<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Networking Applications on Perl.com - programming news, code and culture</title>
    <link>http://localhost:1313/tags/networking-applications/</link>
    <description>Recent content in Networking Applications on Perl.com - programming news, code and culture</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Thu, 19 May 2005 00:00:00 -0800</lastBuildDate>
    <atom:link href="/tags/networking-applications/" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Build a Wireless Gateway with Perl</title>
      <link>http://localhost:1313/pub/2005/05/19/wireless_gw.html/</link>
      <pubDate>Thu, 19 May 2005 00:00:00 -0800</pubDate>
      
      <guid>http://localhost:1313/pub/2005/05/19/wireless_gw.html/</guid>
      <description>

&lt;p&gt;You have set up and configured various wireless access devices, but could not find one that included all of the features you needed. You &lt;em&gt;could&lt;/em&gt; wait for a firmware upgrade from your manufacturer, hoping that they will include the features you want. However, your chances of finding all of your issues addressed by a new firmware package, if it ever comes out, are slim to none. Now is the time to roll up your sleeves and build your own wireless access gateway from scratch. Don&amp;rsquo;t let this idea scare you; this is all possible thanks to the open source world.&lt;/p&gt;

&lt;p&gt;This article introduces an open source project called &lt;a href=&#34;http://awlp.sourceforge.net/&#34;&gt;AWLP&lt;/a&gt; (Alptekin&amp;rsquo;s Wireless Linux Project), which turns a PC with an appropriate wireless LAN card (Prism2/2.&lt;sup&gt;5&lt;/sup&gt;&amp;frasl;&lt;sub&gt;3&lt;/sub&gt;) into a full-featured, web-managed wireless access gateway. That old Pentium 120 machine in your basement might march back up the stairs shortly.&lt;/p&gt;

&lt;p&gt;Building your own wireless access device is nothing new. Around three years ago, Jouni Malinen released &lt;a href=&#34;http://hostap.epitest.fi/&#34;&gt;HostAP&lt;/a&gt;, a Linux driver for wireless LAN cards with Intersil&amp;rsquo;s Prism2/2.&lt;sup&gt;5&lt;/sup&gt;&amp;frasl;&lt;sub&gt;3&lt;/sub&gt; chipset. When operated in a special mode called Managed, the host computer acts as a wireless access point. HostAP does its job and does it well, but it is command line only, and that&amp;rsquo;s not suitable for everyone. A complete solution that potentially competes with off-the-shelf devices needs more features, including DHCP, firewall, DNS, and NTP, along with a web interface for configuration. This is the &lt;em&gt;de facto&lt;/em&gt; standard nowadays.&lt;/p&gt;

&lt;p&gt;To use a car analogy, this is like building a custom car; you want to be able to put in a new clutch, change the suspension, or try a new braking system and see how it performs. In the case of the gateway, you might want to implement an outgoing port-based filter in addition to the incoming one in the firewall. You may want to try a different DNS server or develop a special module that will block MAC addresses through ACLs after exceeding a certain amount of bandwidth in a short period of time.&lt;/p&gt;

&lt;p&gt;For AWLP, the chassis is GNU/Linux Slackware, the engine is Host AP Driver, the transmission is Host AP Utilities, and so on. AWLP code, written in Perl, is the part that makes all these components work together in harmony as a wireless access gateway. After you set up AWLP, you will have a functioning, preconfigured, wireless access gateway to start with. Then you can start modifying the Perl code and configuration files to test and implement the extra capabilities.&lt;/p&gt;

&lt;h3 id=&#34;hardware-requirements&#34;&gt;Hardware Requirements&lt;/h3&gt;

&lt;p&gt;You need a dedicated machine for this task. Running with less than 32 MB of RAM will be painful; the system is more RAM-intensive than it is CPU-intensive so you can run it even on a 486 processor&amp;ndash;but be aware that most 486 machines have only ISA slots. You might have problems finding ISA &lt;sup&gt;10&lt;/sup&gt;&amp;frasl;&lt;sub&gt;100&lt;/sub&gt; Mbps Ethernet cards and ISA wireless LAN cards on the market. An old Pentium machine with at least 1GB HDD is ideal for this task.&lt;/p&gt;

&lt;p&gt;If you plan on running your wireless device on a &lt;sup&gt;24&lt;/sup&gt;&amp;frasl;&lt;sub&gt;7&lt;/sub&gt; basis, and if availability and portability are major concerns, you might consider dedicated hardware. Check out &lt;a href=&#34;http://www.openbrick.com/&#34;&gt;OpenBrick Community&lt;/a&gt; for compact hardware platforms with HDD support.&lt;/p&gt;

&lt;p&gt;In addition to the computer, you also need an Ethernet card compatible with Linux, a PCI or PCMCIA wireless LAN card that has a Prism2/2.&lt;sup&gt;5&lt;/sup&gt;&amp;frasl;&lt;sub&gt;3&lt;/sub&gt; chipset, and a PCI-to-PCMCIA converter, depending on your choice of wireless LAN card and the slots on your board. Refer to the &lt;a href=&#34;http://awlp.sourceforge.net/hardwarecompatibility.html&#34;&gt;AWLP Hardware Compatibility&lt;/a&gt; section for in-depth information on choosing these three components.&lt;/p&gt;

&lt;h3 id=&#34;installing-awlp&#34;&gt;Installing AWLP&lt;/h3&gt;

&lt;p&gt;There are three phases of installation:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Custom installing Slackware with tagfiles&lt;/li&gt;
&lt;li&gt;Upgrading packages in Slackware&lt;/li&gt;
&lt;li&gt;Installing AWLP codes and configuration files&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The third step is the easiest one. The first step, installing Slackware with tagfiles provided by the AWLP package, will take most of your time and effort. You must have Slackware installation discs on hand. Consult the &lt;a href=&#34;http://www.slackware.com/&#34;&gt;Slackware Linux Project&lt;/a&gt; site to obtain them. In order to keep this article readable, I again refer you to the related site, the step-by-step &lt;a href=&#34;http://awlp.sourceforge.net/docs/installation.html&#34;&gt;AWLP Installation Instructions&lt;/a&gt;. After completing the first and second phase of the installation instructions, you can install AWLP, the code, and the configuration files that will make everything work together.&lt;/p&gt;

&lt;p&gt;I highly recommend that you take a disk image after successfully installing AWLP and before you start to modify the code if you have installed it on a slow machine. Installing AWLP code and configuration files take no more than couple of minutes, but in order to reach this step, you must have custom-installed the Slackware with the tagfiles provided, and this might take a couple of hours on an old (&amp;lt;200MHz) Pentium machine. Taking a disk image and restoring from that image when needed will be a lot easier and quicker than starting afresh from Step 1.&lt;/p&gt;

&lt;h3 id=&#34;under-the-hood&#34;&gt;Under the Hood&lt;/h3&gt;

&lt;p&gt;AWLP uses several configuration files:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;DHCP, the Dynamic Host Configuration Protocol: &lt;em&gt;/etc/dhcpd.conf&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Apache Web Server: &lt;em&gt;/etc/apache/httpd.conf&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;DNS, the Domain Name System: &lt;em&gt;/etc/named.conf&lt;/em&gt;, &lt;em&gt;/var/named/caching-example/localhost.zone&lt;/em&gt;, &lt;em&gt;/var/named/caching-example/named.ca&lt;/em&gt;, and &lt;em&gt;/var/named/caching-example/named.local&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;NTP, the Network Time Protocol: &lt;em&gt;/etc/ntp.conf&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Firewalling: &lt;em&gt;/etc/rc.d/rc.firewall&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In addition to these standard configuration files, there are some custom configuration files such as &lt;em&gt;/etc/awlp/oui_filtered.txt&lt;/em&gt;. This file contains the filtered version of &lt;em&gt;oui.txt&lt;/em&gt;, representing the &lt;a href=&#34;http://standards.ieee.org/regauth/oui/oui.txt&#34;&gt;IEEE Organizationally Unique Identifiers&lt;/a&gt;. It makes it possible to find the company manufacturing a specific Ethernet card, wired or wireless, using the first 24 bits of MAC address. In order to have an in-depth knowledge of all the configuration files and their layouts, I encourage you to examine &lt;em&gt;installer.sh&lt;/em&gt; from the AWLP package.&lt;/p&gt;

&lt;p&gt;AWLP code resides in &lt;em&gt;/var/www/cgi-bin/awlp&lt;/em&gt;. The core of the AWLP code is &lt;em&gt;index.pl&lt;/em&gt;. It does all of the error checking, manipulation, and modification. The web server, Apache 1.3.33, runs as the user and group &lt;code&gt;apache&lt;/code&gt;. In order to manipulate configuration files through the web browser, the related configuration files have suid and guid permissions set. This strategy is definitely more secure than running the web server as &lt;code&gt;root&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The part that interacts with HostAP command line tools and utilities, along with standard Linux tools and utilities, is &lt;em&gt;engines1.pl&lt;/em&gt;. It serves as an include file and contains various subroutines to do the work. &lt;em&gt;engines2.pl&lt;/em&gt; also contains various subroutines, but these usually do sorting, searching, and conversion. &lt;em&gt;radar.pl&lt;/em&gt; provides status checking and monitoring functionality. It&amp;rsquo;s not crucial to the operating of the wireless access gateway, but it definitely does add value because watching and monitoring how your device is performing is the key factor to the success of your implementation.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;extras.pl&lt;/em&gt; provides ASCII to HEX conversion, DHCP lease table display, and several other non-core functions. As the name implies, &lt;em&gt;error_messages.pl&lt;/em&gt; has all the error messages and their descriptions. &lt;em&gt;global_configuration.pl&lt;/em&gt; has pretty much all the configuration variables ranging from critical to non-critical. You must understand the inner workings of the system in order to change the configuration variables up to &lt;code&gt;$MAIN_TITLE&lt;/code&gt;. &lt;code&gt;$MAIN_TITLE&lt;/code&gt; and the following variables are also necessary, but for mostly cosmetic purposes, so you can customize them without worrying about accidentally disabling needed features.&lt;/p&gt;

&lt;h3 id=&#34;sample-modification&#34;&gt;Sample Modification&lt;/h3&gt;

&lt;p&gt;Now you know what AWLP is and what it can do. What about all these modifications and customizations? Now, it is time to show you a step-by-step instruction for adding a feature to AWLP. As of AWLP 1.0, you can configure the DHCP server only by manually changing &lt;em&gt;/etc/dhcpd.conf&lt;/em&gt;. The feature I want to demonstrate will simply show the contents of the file. Once you have familiarity with the code, you can improve it to modify the contents of &lt;em&gt;dhcpd.conf&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;The Apache web server runs as the user and group &lt;code&gt;apache&lt;/code&gt;. The result of &lt;code&gt;ls -l&lt;/code&gt; on &lt;em&gt;/etc/dhcpd.conf&lt;/em&gt; shows:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# ls -l /etc/dhcpd.conf
-rwxrwx---  1 root apache 618 Mar 5 12:41 /etc/dhcpd.conf*
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The script will be able to read and modify the &lt;em&gt;/etc/dhcpd.conf&lt;/em&gt; file. Open the &lt;em&gt;index.pl&lt;/em&gt; file. At the top, there are two configuration variables; &lt;code&gt;@MainPageLinksAction&lt;/code&gt; and &lt;code&gt;@MainPageLinksName&lt;/code&gt;. These two control the links on the left side. To add an additional link for DHCP, add &lt;code&gt;DHCP&lt;/code&gt; to both arrays.&lt;/p&gt;

&lt;p&gt;Next, find the line that says:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;elsif ($FORM_Action1 eq &amp;quot;Administration&amp;quot;) {
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Just before this line, add the following lines of code, then save and close the file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;elsif ($FORM_Action1 eq &amp;quot;DHCP&amp;quot;) {

    my $DHCPConfigFileContent;

    if (open(FILE, &amp;quot;/etc/dhcpd.conf&amp;quot;)) {
        local $/;
        $DHCPConfigFileContent = &amp;lt;FILE&amp;gt;;
        close(FILE);
    }

    unless ($DHCPConfigFileContent) {
        $DHCPConfigFileContent = &amp;quot;/etc/dhcpd.conf could not be read or it is empty!&amp;quot;;
        $DHCPLeaseRangeStart = &amp;quot;N/A&amp;quot;;
        $DHCPLeaseRangeEnd   = &amp;quot;N/A&amp;quot;;
    }

    my ($DHCPLeaseRangeStart, $DHCPLeaseRangeEnd);

    if ($DHCPConfigFileContent =~ m/Range\s+(\d+\.\d+\.\d+\.\d+)\s+(\d+\.\d+\.\d+\.\d+)/i) {
        $DHCPLeaseRangeStart = $1;
        $DHCPLeaseRangeEnd   = $2;
    }

    $Right_Plane_Output .=&amp;lt;&amp;lt;HTMLCODE
    &amp;lt;TABLE ALIGN=CENTER CELLSPACING=3 CELLPADDING=3 BGCOLOR=&amp;quot;#000000&amp;quot;&amp;gt;
    &amp;lt;TR BGCOLOR=&amp;quot;#FFFFFF&amp;quot;&amp;gt;
            &amp;lt;TD ALIGN=LEFT&amp;gt;
            &amp;lt;font face=&amp;quot;Helvetica, Arial, Sans-serif, Verdena&amp;quot; size=&amp;quot;2&amp;quot;&amp;gt;
            &amp;lt;TABLE CELLSPACING=0 CELLPADDING=0&amp;gt;
            &amp;lt;TR&amp;gt;
                    &amp;lt;TD&amp;gt;
                    &amp;lt;font face=&amp;quot;Helvetica, Arial, Sans-serif, Verdena&amp;quot; size=&amp;quot;2&amp;quot;&amp;gt;
                    &amp;lt;PRE&amp;gt;&amp;lt;CODE&amp;gt;
                    ${DHCPConfigFileContent}
                    &amp;lt;/CODE&amp;gt;&amp;lt;/PRE&amp;gt;

                    &amp;lt;BR&amp;gt;&amp;lt;BR&amp;gt;&amp;lt;BR&amp;gt;
                    &amp;lt;font color=&amp;quot;#FF0000&amp;quot;&amp;gt;Lease Range:&amp;lt;/font&amp;gt; 
                    &amp;lt;B&amp;gt;${DHCPLeaseRangeStart} to ${DHCPLeaseRangeEnd}&amp;lt;/B&amp;gt;
                    &amp;lt;BR&amp;gt;&amp;lt;BR&amp;gt;&amp;lt;BR&amp;gt;
                    &amp;lt;/TD&amp;gt;
            &amp;lt;/TR&amp;gt;
            &amp;lt;/TABLE&amp;gt;
            &amp;lt;/TD&amp;gt;
    &amp;lt;/TR&amp;gt;
    &amp;lt;/TABLE&amp;gt;
HTMLCODE

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once you do this modification, there will be a new menu section on the left side with the name DHCP. Clicking the DHCP link on the left will show you the contents of &lt;em&gt;/etc/dhcpd.conf&lt;/em&gt; and Lease Range values, which come from the contents of the file through a simple regular expression construct.&lt;/p&gt;

&lt;h3 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h3&gt;

&lt;p&gt;You will have a functioning wireless access gateway once you install AWLP. The above illustration proves how easy it is to add features to this software-based wireless access gateway, provided that you are familiar with Perl. However, to accomplish more useful modifications tailored to your needs, you should examine &lt;em&gt;index.pl&lt;/em&gt; and the other core, and include scripts and configuration files.&lt;/p&gt;

&lt;h3 id=&#34;related-links&#34;&gt;Related Links&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://awlp.sourceforge.net/&#34;&gt;AWLP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.slackware.com/&#34;&gt;The Slackware Linux Project&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://hostap.epitest.fi/&#34;&gt;HostAP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://bridge.sourceforge.net/&#34;&gt;Linux Ethernet Bridging&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.openbrick.com/&#34;&gt;OpenBrick Community&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Cross-Language Remoting with mod_perlservice</title>
      <link>http://localhost:1313/pub/2004/11/18/mod_perlservice.html/</link>
      <pubDate>Thu, 18 Nov 2004 00:00:00 -0800</pubDate>
      
      <guid>http://localhost:1313/pub/2004/11/18/mod_perlservice.html/</guid>
      <description>

&lt;h3 id=&#34;mod-perlservice-what-is-that&#34;&gt;Mod_perlservice? What is That?&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;Mod_perlservice&lt;/code&gt; is a cool, new way to do remoting &amp;ndash; sharing data between server and client processes &amp;ndash; with Perl and Apache. Let&amp;rsquo;s start by breaking that crazy name apart: mod + perl + service.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Mod&lt;/em&gt; means that it&amp;rsquo;s a module for the popular and ubiquitous Apache HTTP Server. &lt;em&gt;Perl&lt;/em&gt; represents the popular and ubiquitous programming language. &lt;em&gt;Service&lt;/em&gt; is the unique part. It&amp;rsquo;s the new ingredient that unifies Apache, Perl, and XML into an easy-to-use web services system.&lt;/p&gt;

&lt;p&gt;With mod_perlservice, you can write Perl subs and packages on your server and call them over the internet from client code. Clients can pass scalars, arrays, and hashes to the server-side subroutines and obtain the return value (scalar, array, or hash) back from the remote code. Some folks refer to this functionality as &amp;ldquo;remoting&amp;rdquo; or &amp;ldquo;RPC,&amp;rdquo; so if you like you can say mod_perlservice is remoting with Perl and Apache. You can write client programs in a variety of languages; libraries for C, Perl, and Flash Action Script are all ready to go.&lt;/p&gt;

&lt;p&gt;Now that you know what mod_perlservice is, let&amp;rsquo;s look at why it is. I believe that mod_perlservice has a very clean, easy-to-use interface when compared with other RPC systems. Also, because it builds on the Apache platform it benefits from Apache&amp;rsquo;s ubiquity, security, and status as a standard. Mod_perlservice sports an embedded Perl interpreter to offer high performance for demanding applications.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_18_mod_perlservice/mod_perlservicelogo.jpg&#34; alt=&#34;mod_perlservice&#34; width=&#34;200&#34; height=&#34;120&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;how-can-i-use-mod-perlservice&#34;&gt;How Can I Use mod_perlservice?&lt;/h3&gt;

&lt;p&gt;Mod_perlservice helps create networked applications that require client-server communication, information processing, and sharing. Mod_perlservice is for applications, not for creating dynamic content for your HTML pages. However, you surely can use it for Flash remoting with Perl. Here are some usage examples:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;A desktop application (written using your favorite C++ GUI library) that records the current local air temperature and sends it to an online database every 10 minutes. Any client can query the server to obtain the current and historical local air temperature of any other participating client.&lt;/li&gt;
&lt;li&gt;A Flash-based stock portfolio management system. You can create model stock portfolios and retrieve real-time stock quote information and news.&lt;/li&gt;
&lt;li&gt;A command-line utility in Perl that accepts English sentences on standard input and outputs the sentences in French. Translation occurs in server-side Perl code. If the sentence is idiomatic and the translation is incorrect, the user has the option of sending the server a correct translation to store in an online idiom database.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;how-do-i-start&#34;&gt;How Do I Start?&lt;/h3&gt;

&lt;p&gt;Let&amp;rsquo;s move on to the fun stuff and set up a working installation. Before we begin, make sure you have everything you need! You need &lt;a href=&#34;http://httpd.apache.org/&#34;&gt;Apache HTTPD&lt;/a&gt;, &lt;a href=&#34;http://www.perl.org/&#34;&gt;Perl&lt;/a&gt;, &lt;a href=&#34;https://libexpat.github.io/&#34;&gt;Expat&lt;/a&gt;, &lt;a href=&#34;http://www.ivorycity.com/mod_perlservice/&#34;&gt;mod_perlservice&lt;/a&gt;, and a mod_perlservice client library (&lt;a href=&#34;http://www.ivorycity.com/mod_perlservice/perl_client.html&#34;&gt;Perl Client&lt;/a&gt; | &lt;a href=&#34;http://www.ivorycity.com/mod_perlservice/c_client.html&#34;&gt;C Client&lt;/a&gt; | &lt;a href=&#34;http://www.ivorycity.com/mod_perlservice/flash_client.html&#34;&gt;Flash Client&lt;/a&gt;). You must download a client library separately, as the distribution does not include any clients! In your build directory:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;myhost$ tar -xvzf mod_perlservice.tar.gz
myhost$ cd mod_perlservice
myhost$ ./configure
myhost$ make
myhost$ make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If everything goes to plan, you&amp;rsquo;ll end up with a fresh &lt;em&gt;mod_perlservice.so&lt;/em&gt; in your Apache modules directory, (usually &lt;em&gt;/etc/apache/modules&lt;/em&gt;). Now it&amp;rsquo;s time to configure Apache to use mod_perlservice. &lt;code&gt;cd&lt;/code&gt; into your Apache configuration directory (usually &lt;em&gt;/etc/apache/conf&lt;/em&gt;) Add the following lines to the file &lt;em&gt;apache.conf&lt;/em&gt; (or &lt;em&gt;httpd.conf&lt;/em&gt;, if you have only a single configuration file):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;LoadModule perlservice_module modules/mod_perlservice.so
AddModule mod_perlservice.c
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Add the following lines to &lt;em&gt;commonapache.conf&lt;/em&gt;, if you have it and &lt;em&gt;httpd.conf&lt;/em&gt; if you don&amp;rsquo;t:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;IfModule mod_perlservice.c&amp;gt;
&amp;lt;Location /perlservice&amp;gt;   SetHandler
mod_perlservice
   Allow From All PerlApp
   myappname /my/app/dir
   #Examples
   PerlApp stockmarket /home/services/stockmarket
   PerlApp temperature /home/services/temperature
&amp;lt;/Location&amp;gt;
&amp;lt;/IfModule&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;Pay close attention to the &lt;code&gt;PerlApp&lt;/code&gt; directive.&lt;/em&gt; For every mod_perlservice application you want to run, you need a &lt;code&gt;PerlApp&lt;/code&gt; directive. If I were creating a stock market application, I might create a directory: &lt;em&gt;/home/services/stockmarket&lt;/em&gt; and add the following &lt;code&gt;PerlApp&lt;/code&gt; directive:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;PerlApp stockmarket /home/services/stockmarket
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This tells mod_perlservice to host an application called &lt;code&gt;stockmarket&lt;/code&gt; with the Perl code files located in the &lt;em&gt;/home/services/stockmarket&lt;/em&gt; directory. You may run as many service applications as you wish and you may organize them however you wish.&lt;/p&gt;

&lt;p&gt;With the configuration files updated, the next step is to restart Apache:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;myhost$ /etc/init.d/apache restart
or
myhost$ apachectl restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now if everything went as planned, mod_perlservice should be installed. Congratulations!&lt;/p&gt;

&lt;h3 id=&#34;an-example&#34;&gt;An Example&lt;/h3&gt;

&lt;p&gt;Let&amp;rsquo;s create that stock portfolio example mentioned earlier. It won&amp;rsquo;t support real-time quotes, but will instead create a static database of common stock names and historical prices. The application will support stock information for General Electric (GE), Red Hat (RHAT), Coca-Cola (KO), and Caterpillar (CAT).&lt;/p&gt;

&lt;p&gt;The application will be &lt;em&gt;stockmarket&lt;/em&gt; and will keep all of the Perl files in the stock market application directory (&lt;em&gt;/home/services/stockmarket&lt;/em&gt;). The first file will be &lt;em&gt;quotes.pm&lt;/em&gt;, reading as follows:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;our $lookups = {
    &amp;quot;General Electric&amp;quot; =&amp;gt; &amp;quot;GE&amp;quot;,
    &amp;quot;Red Hat&amp;quot;          =&amp;gt; &amp;quot;RHAT&amp;quot;,
    &amp;quot;Coca Cola&amp;quot;        =&amp;gt; &amp;quot;KO&amp;quot;,
    &amp;quot;Caterpillar Inc&amp;quot;  =&amp;gt; &amp;quot;CAT&amp;quot;
};
our $stocksymbols = {
    &amp;quot;GE&amp;quot; =&amp;gt; {
        &amp;quot;Price&amp;quot;            =&amp;gt; 33.91,
        &amp;quot;EarningsPerShare&amp;quot; =&amp;gt; 1.544
    },
    &amp;quot;RHAT&amp;quot; =&amp;gt; {
        &amp;quot;Price&amp;quot; =&amp;gt; 14.96,
        &amp;quot;EarningsPerShare&amp;quot; =&amp;gt; 0.129
    },
    &amp;quot;KO&amp;quot;   =&amp;gt; {
        &amp;quot;Price&amp;quot;            =&amp;gt; 42.84,
        &amp;quot;EarningsPerShare&amp;quot; =&amp;gt; 1.984
    },
    &amp;quot;CAT&amp;quot; =&amp;gt; {
        &amp;quot;Price&amp;quot;            =&amp;gt; 75.74,
        &amp;quot;EarningsPerShare&amp;quot; =&amp;gt; 4.306
    }
};

package quotes;

sub lookupSymbol {
    my $companyname = shift;
    return $lookups-&amp;gt;{$company_name};
}

sub getLookupTable {
    return $lookups;
}

sub getStockPrice {
    my $stocksymbol = shift;
    return $stocksymbols-&amp;gt;{$stocksymbol}-&amp;gt;{&amp;quot;Price&amp;quot;};
}
sub getAllStockInfo {
    my $stocksymbol = shift;
    return $stocksymbols{$stocksymbol};
}
1;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That&amp;rsquo;s the example of the server-side program. Basically, two static &amp;ldquo;databases&amp;rdquo; (&lt;code&gt;$lookups&lt;/code&gt; and &lt;code&gt;$stocksymbols&lt;/code&gt;) provide information about a limited universe of stocks. The above methods query the static databases; the behavior should be fairly self-explanatory.&lt;/p&gt;

&lt;p&gt;You may have as many &lt;em&gt;.pm&lt;/em&gt; files in your application as you wish and you may also define as many packages within a &lt;em&gt;.pm&lt;/em&gt; file as you wish. An extension to this application might be a file called &lt;em&gt;news.pm&lt;/em&gt; that enables you to fetch current and historical news about your favorite stocks.&lt;/p&gt;

&lt;p&gt;Now let&amp;rsquo;s talk some security. As it stands, this code won&amp;rsquo;t work; mod_perlservice will restrict access to any file and method you don&amp;rsquo;t explicitly export for public use. Use the &lt;em&gt;.serviceaccess&lt;/em&gt; file to export things. Create this file in each application directory you declare with mod_perlservice or you&amp;rsquo;ll have no access. An example file might read:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;ServiceAccess&amp;gt;
  &amp;lt;AllowFile name=&amp;quot;quotes.pm&amp;quot;&amp;gt;
    Allow quotes::*
  &amp;lt;/AllowFile&amp;gt;
&amp;lt;/ServiceAccess&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the stock market example, this file should be &lt;em&gt;/home/services/stockmarket/.serviceaccess&lt;/em&gt;. Be sure that the &lt;code&gt;apache&lt;/code&gt; user does not own this file; that could be bad for security. This file allows access to the file &lt;em&gt;quotes.pm&lt;/em&gt; and allows public access to all (&lt;code&gt;*&lt;/code&gt;) the methods in package &lt;em&gt;quotes&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;If I want to restrict access only to &lt;code&gt;getStockPrice&lt;/code&gt;, I would have written &lt;code&gt;Allow quotes::getStockPrice&lt;/code&gt;. After that, I could add access to &lt;code&gt;lookupSymbol&lt;/code&gt; with &lt;code&gt;Allow quotes::lookupSymbol&lt;/code&gt;. To make &lt;em&gt;quotes.pm&lt;/em&gt; public carte blanche, use &lt;em&gt;Allow *&lt;/em&gt;. You won&amp;rsquo;t need to restart Apache when you make changes to this file as it reloads automatically.&lt;/p&gt;

&lt;h3 id=&#34;client-code&#34;&gt;Client Code&lt;/h3&gt;

&lt;p&gt;Well, so far I&amp;rsquo;ve only shown you half the story. It&amp;rsquo;s time to create some client-side code. This client example uses the Flash &amp;ldquo;PerlService&amp;rdquo; library, just one of the client-side interfaces to mod_perlservice. The Flash client works well for browser interfaces while the Perl and C clients can create command-line or GUI (ie, GTK or Qt) applications. This article is on the web, so we&amp;rsquo;ll give the Flash interface a spin and then go through an example in Perl.&lt;/p&gt;

&lt;p&gt;The first code smidgen should go in the first root frame of your Flash application. It instantiates the global &lt;code&gt;PerlService&lt;/code&gt; object and creates event handlers for when remote method calls return from the server. The event handlers output the requested stock information to the display box.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;quot;PerlService-0.0.2.as&amp;quot;
// Create a global PerlService object
// Tell the PerlService object about the remote code we want to use:
// arg1) host: www.ivorycity.com
// arg2) application: stockmarket
// arg3) file: quotes.pm
// arg4) package: quotes
_global.ps = new PerlService(&amp;quot;www.ivorycity.com&amp;quot;,&amp;quot;stockmarket&amp;quot;,&amp;quot;quotes.pm&amp;quot;,&amp;quot;quotes&amp;quot;);
// First declare three callback functions to handle return values
function onStockPrice(val) {
    output.text = &amp;quot;StockPrice: &amp;quot; + symbolInput.text + &amp;quot; &amp;quot; + val + &amp;quot;\n&amp;quot; + output.text;
}

function onAllStockInfo(val) {
    output.text = &amp;quot;Stock Info: &amp;quot; + allInfoInput.text + &amp;quot;\n&amp;quot; + &amp;quot;\tPrice: &amp;quot;
                  + val.Price + &amp;quot;\n&amp;quot; + &amp;quot;\tEarnings Per Share: &amp;quot;
                  + val.EarningsPerShare + &amp;quot;\n&amp;quot; + output.text;
}

function onLookupSymbol(val) {
    output.text = &amp;quot;Lookup Result: &amp;quot; + symbolInput.text + &amp;quot; &amp;quot; + val + &amp;quot;\n&amp;quot;
                  + output.text;
}

// Register callback handlers for managing return values from remote  methods
// ie, onStockPrice receives the return value from remote method getStockPrice

ps.registerReplyHandler( &amp;quot;getStockPrice&amp;quot;, onStockPrice );
ps.registerReplyHandler( &amp;quot;getAllStockInfo&amp;quot;, onAllStockInfo );
ps.registerReplyHandler( &amp;quot;lookupSymbol&amp;quot;, onLookupSymbol );
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now for the code that makes things happen. The following code attaches to three separate buttons. When clicked, the buttons call the remote Perl methods using the global &lt;code&gt;PerlService&lt;/code&gt; object. Flash Action Script is an event-driven system, so click event-handlers will call the remote code and return event-handlers will do something with those values.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_18_mod_perlservice/flashclientdgm.jpg&#34; alt=&#34;buttons and code associations&#34; width=&#34;400&#34; height=&#34;206&#34; /&gt;
&lt;em&gt;Figure 1. Button and code associations.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;When a user presses Button 1, call the remote method &lt;code&gt;getStockPrice&lt;/code&gt; and pass the text in the first input box as an argument.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;on (release) {
    ps.getStockPrice(box1.text);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When the user presses Button 2, call the remote method &lt;code&gt;getAllStockInfo&lt;/code&gt; and pass the text in the second input box as an argument.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;on (release) {
    ps.getAllStockInfo(box2.text);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;When the user presses Button 3, call the remote method &lt;code&gt;lookupSymbol&lt;/code&gt; and pass the text in the third input box as an argument.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;on (release) {
    ps.lookupSymbol(box3.text);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That&amp;rsquo;s the entire Flash example. Here is the finished product.&lt;/p&gt;

&lt;h4 id=&#34;perl-client&#34;&gt;Perl Client&lt;/h4&gt;

&lt;p&gt;Not everyone uses Flash, especially in the Free Software community. The great thing about mod_perlservice is that everyone can join the party. Here&amp;rsquo;s a Perl Client that uses the same server-side stock market API.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;use PService;

my $hostname = &amp;quot;www.ivorycity.com&amp;quot;;
my $appname  = &amp;quot;stockmarket&amp;quot;;
my $filename = &amp;quot;quotes.pm&amp;quot;;
my $package  = &amp;quot;quotes&amp;quot;;

#Create the client object with following arguments:
#1) The host you want to use
#2) The application on the host
#3) The perl module file name
#4) The package you want to use

my $ps = PSClient-&amp;gt;new( $hostname, $appname, $filename, $package );

# Just call those remote methods and get the return value
my $price  = $ps-&amp;gt;getStockPrice(&amp;quot;GE&amp;quot;);
my $info   = $ps-&amp;gt;getAllStockInfo(&amp;quot;RHAT&amp;quot;);
my $lookup = $ps-&amp;gt;lookupSymbol(&amp;quot;Coca Cola&amp;quot;);

#Share your exciting new information with standard output
print &amp;quot;GE Price: &amp;quot; . $price . &amp;quot;\n&amp;quot;;
print &amp;quot;Red Hat Price: &amp;quot; . $info-&amp;gt;{Price} . &amp;quot;\n&amp;quot;;
print &amp;quot;Red Hat EPS: &amp;quot; . $info-&amp;gt;{EarningsPerShare} . &amp;quot;\n&amp;quot;;
print &amp;quot;Coca-Cola&#39;s ticker symbol is &amp;quot; . $lookup . &amp;quot;\n&amp;quot;;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using the &lt;em&gt;PSClient&lt;/em&gt; object to call remote methods might feel a little awkward if you expect to call them via &lt;code&gt;quotes::getStockPrice()&lt;/code&gt;, but think of the &lt;code&gt;$ps&lt;/code&gt; instance as a proxy class to your remote methods, if you like.&lt;/p&gt;

&lt;p&gt;If things don&amp;rsquo;t work, use &lt;code&gt;print $ps-&amp;gt;get_errmsg();&lt;/code&gt; to print an error message. $ps-&amp;gt;get_errmsg(); That&amp;rsquo;s a local reserved function, so it doesn&amp;rsquo;t call the server. It&amp;rsquo;s one of a few reserved functions detailed in the &lt;a href=&#34;http://www.ivorycity.com/mod_perlservice/perl_client.html&#34;&gt;Perl client reference&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As you can see, it requires much less work to create an example with the Perl client. You simply instantiate the PSClient object, call the remote methods, and do something with the return values. That&amp;rsquo;s it. There is no protocol decoding, dealing with HTTP, CGI arguments, or any of the old annoyances. Your remote code may as well be local code.&lt;/p&gt;

&lt;h3 id=&#34;thanks-for-taking-the-tour&#34;&gt;Thanks for Taking the Tour&lt;/h3&gt;

&lt;p&gt;That&amp;rsquo;s mod_perlservice. I&amp;rsquo;m sure many of you who are developing client-server applications can see the advantages of this system. Personally, I&amp;rsquo;ve always found the existing technologies to be inflexible and/or too cumbersome. The mod_perlservice system offers a clean, simple, and scalable interface that unites client-side and server-side code in the most sensible way yet.&lt;/p&gt;

&lt;p&gt;What&amp;rsquo;s next? mod_parrotservice!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Implementing Flood Control</title>
      <link>http://localhost:1313/pub/2004/11/11/floodcontrol.html/</link>
      <pubDate>Thu, 11 Nov 2004 00:00:00 -0800</pubDate>
      
      <guid>http://localhost:1313/pub/2004/11/11/floodcontrol.html/</guid>
      <description>

&lt;p&gt;Accordingly to Merriam-Webster Online, &amp;ldquo;flood&amp;rdquo; means:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;1: a rising and overflowing of a body of water especially onto normally dry land;&lt;/p&gt;

&lt;p&gt;2: an overwhelming quantity or volume.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;In computer software there are very similar situations when an unpredictable and irregular flow of events can reach higher levels. Such situations usually are not comfortable for users, either slowing down systems or having other undesired effects.&lt;/p&gt;

&lt;p&gt;Floods can occur from accessing web pages, requesting information from various sources (ftp lists, irc services, etc.), receiving SMS notification messages, and email processing. It is obvious that it is not possible to list all flood cases.&lt;/p&gt;

&lt;p&gt;&amp;ldquo;Flood control&amp;rdquo; is a method of controlling the processing-rate of a stream of events. It can reject or postpone events until there are available resources (CPU, time, space, etc.) for them. Essentially the flood control restricts the number of events processed in a specific period of time.&lt;/p&gt;

&lt;h3 id=&#34;span-id-closing-the-gates-closing-the-gates-span&#34;&gt;&lt;span id=&#34;closing_the_gates&#34;&gt;Closing the Gates&lt;/span&gt;&lt;/h3&gt;

&lt;p&gt;To maintain flood control, you must calculate the flood ratio, which is:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_11_floodcontrol/flood2-eq1.gif&#34; alt=&#34;flood ratio equation&#34; width=&#34;73&#34; height=&#34;50&#34; /&gt;
&lt;em&gt;Figure 1. Flood ratio equation.&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;fr flood ratio
ec event count
tp time period for ec
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To determine if a flood is occurring, compare the flood ratio to the fixed maximum (threshold) ratio. If the result is less than the threshold, there&amp;rsquo;s no flood. Accept the event. If the result is higher, refuse or postpone the event.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_11_floodcontrol/flood2-eq2.gif&#34; alt=&#34;comparing the ratios&#34; width=&#34;68&#34; height=&#34;50&#34; /&gt;
&lt;em&gt;Figure 2. Comparing the ratios.&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ec event count
tp time period for ec
fc fixed event count (max)
fp fixed time period for fc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It is possible to keep an array of timestamps of all events. Upon receipt of a new event, calculate the time period since the oldest event to use as the current count/time ratio. This approach has two drawbacks. The first is that it uses more and more memory to hold all of the timestamps. Suppose that you want only two events to happen inside a one-minute period, giving two events per minute. Someone can trigger a single event, wait half an hour, and finally flood you with another 58 requests. At this point the ratio will be 1.9/min., well below the 2/min. limit. This is the second drawback.&lt;/p&gt;

&lt;p&gt;A better approach is to keep a sliding window either of events (&lt;code&gt;fc&lt;/code&gt;) or time period (&lt;code&gt;fp&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;This period window requires an array of the last events. This array size is unknown. (The specific time units are not important, but the following examples use minutes.)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;               past                                   now
    Timeline:  1----2----3----4----5----6----7----8----9---&amp;gt; (min)
    Events:    e1      e2 e3         e4     e5 e6     e7
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This timeline measures event timestamps. To calculate the flood ratio, you count events newer than the current time window of size &lt;code&gt;fp&lt;/code&gt;. And check against a ratio of four events in three minutes:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Time now:      9
Time window:   from 9-3 = 6 to now(9), so window is 6-9
Oldest event:  e5 (not before 6)
Event count:   3 (in 6-9 period)
Flood ratio:   3/3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This ratio of &lt;sup&gt;3&lt;/sup&gt;&amp;frasl;&lt;sub&gt;3&lt;/sub&gt; is below the flood threshold of &lt;sup&gt;4&lt;/sup&gt;&amp;frasl;&lt;sub&gt;3&lt;/sub&gt;, so at this moment there is no flood. Perform this check at the last event to check. In this example, this event is &lt;code&gt;e7&lt;/code&gt;. After each check, you can safely remove all events older than the time window to reduce memory consumption.&lt;/p&gt;

&lt;p&gt;The other solution requires a fixed array of events with size &lt;code&gt;fc&lt;/code&gt;. With our 4ev/3min example, then:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;               past                  now
    Timeline:  &amp;lt;--5----6----7----8----9---&amp;gt; (min)
    Events:      e4        e5 e6     e7
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The event array (window) is size 4. To check for a flood at &lt;code&gt;e7&lt;/code&gt;, we use this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Window size &amp;quot;fc&amp;quot;: 4
First event time: e4 -&amp;gt; 5
Last  event time: e7 -&amp;gt; 9
Time period &amp;quot;tp&amp;quot;: 9-5 = 4
Flood ratio is:   4/4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The ratio of &lt;sup&gt;4&lt;/sup&gt;&amp;frasl;&lt;sub&gt;4&lt;/sub&gt; is also below the threshold of &lt;sup&gt;4&lt;/sup&gt;&amp;frasl;&lt;sub&gt;3&lt;/sub&gt;, so it&amp;rsquo;s OK to accept event &lt;code&gt;e7&lt;/code&gt;. When you must check a new event, add it to the end of the event array (window) and remove the oldest one. If the new event would cause a flood, remember to reverse these operations.&lt;/p&gt;

&lt;p&gt;If the flood check fails, you can find a point in the future when this check will be OK. This makes it possible to return some feedback information to the user indicating how much time to wait before the system will accept the next event:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_11_floodcontrol/flood2-eq3.gif&#34; alt=&#34;time until next event equation&#34; width=&#34;126&#34; height=&#34;50&#34; /&gt;
&lt;em&gt;Figure 3. Time until next event equation.&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ec  event count (requests received, here equal to fc)
fc  fixed event count (max)
fp  fixed time period for fc
now the future time point we search for
ot  oldest event time point in the array (event timestamp)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_11_floodcontrol/flood2-eq4.gif&#34; alt=&#34;simplified time until next event equation&#34; width=&#34;186&#34; height=&#34;50&#34; /&gt;
&lt;em&gt;Figure 4. Simplified time until next event equation.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://localhost:1313/images/_pub_2004_11_11_floodcontrol/flood2-eq5.gif&#34; alt=&#34;time to wait equation&#34; width=&#34;192&#34; height=&#34;30&#34; /&gt;
&lt;em&gt;Figure 5. The time-to-wait equation.&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;time the actual current time (time of the new event)
wait time period to wait before next allowed event
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If &lt;code&gt;wait&lt;/code&gt; is positive, then this event should be either rejected or postponed. When &lt;code&gt;wait&lt;/code&gt; is 0 or negative, it&amp;rsquo;s OK to process the event immediately.&lt;/p&gt;

&lt;h3 id=&#34;span-id-the-code-the-code-span&#34;&gt;&lt;span id=&#34;the_code&#34;&gt;The Code&lt;/span&gt;&lt;/h3&gt;

&lt;p&gt;In the following implementation I&amp;rsquo;ll use a slightly modified version of the sliding window of events. To avoid removing the last event and eventually replacing it after a failed check, I decided to check the current flood ratio with the existing events array and with the time of the new one:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;               past                  now
    Timeline:  &amp;lt;--5----6----7----8----9---&amp;gt; (min)
    Events:      e3   e4   e5 e6    (e7)

    Window size fc: 4 (without e7)
    First event time: e4 -&amp;gt; 5
    Last event time: e7 -&amp;gt; 9
    Time period tp: 9-5 = 4
    Flood ratio is:   4/4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This seems a bit strange at first, but it works exactly as needed. The check is performed as if &lt;code&gt;e6&lt;/code&gt; is timed as &lt;code&gt;e7&lt;/code&gt;, which is the worst case (the biggest time period for the fixed event window size). If the check passes, than after removing &lt;code&gt;e3&lt;/code&gt;, the flood ratio will be always below the threshold!&lt;/p&gt;

&lt;p&gt;Following this description I wrote a function to call for each request or event that needs flood control. It receives a fixed, maximum count of requests (the events window size) and a fixed time period. It returns how much time must elapse until the next allowed event, or 0 if it&amp;rsquo;s OK to process the event immediately.&lt;/p&gt;

&lt;p&gt;This function should be generic, so it needs some kind of event names. To achieve this there is a third argument &amp;ndash; the specific event name for each flood check.&lt;/p&gt;

&lt;p&gt;Here is the actual code:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# this package hash holds flood arrays for each event name
# hash with flood keys, this is the internal flood check data storage
our %FLOOD;

sub flood_check
{
  my $fc = shift; # max flood events count
  my $fp = shift; # max flood time period for $fc events
  my $en = shift; # event name (key) which identifies flood check data

  $FLOOD{ $en } ||= [];   # make empty flood array for this event name
  my $ar = $FLOOD{ $en }; # get array ref for event&#39;s flood array
  my $ec = @$ar;          # events count in the flood array

  if( $ec &amp;gt;= $fc ) 
    {
    # flood array has enough events to do real flood check
    my $ot = $$ar[0];      # oldest event timestamp in the flood array
    my $tp = time() - $ot; # time period between current and oldest event

    # now calculate time in seconds until next allowed event
    my $wait = int( ( $ot + ( $ec * $fp / $fc ) ) - time() );
    if( $wait &amp;gt; 0 )
      {
      # positive number of seconds means flood in progress
      # event should be rejected or postponed
      return $wait;
      }
    # negative or 0 seconds means that event should be accepted
    # oldest event is removed from the flood array
    shift @$ar;
    }
  # flood array is not full or oldest event is already removed
  # so current event has to be added
  push  @$ar, time();
  # event is ok
  return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I&amp;rsquo;ve put this on the CPAN as &lt;a href=&#34;https://metacpan.org/pod/Algorithm::FloodControl&#34;&gt;Algorithm::FloodControl&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To test it, I wrote a simple program that accepts text, line by line, from standard input and prints each accepted line or the amount of time before the program will accept the next line.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/usr/bin/perl
use strict;
use Algorithm::FloodControl;

while(&amp;lt;&amp;gt;)
  {
  # time is used to illustrate the results
  my $tm = scalar localtime;

  # exit on `quit&#39; or `exit&#39; strings
  exit if /exit|quit/i;

  # FLOOD CHECK: allow no more than 2 same lines in 10 seconds
  # here I use the actual data for flood event name!
  my $lw = flood_check( 2, 10, $_ );

  if( $lw ) # local wait time
    {
    chomp;
    print &amp;quot;WARNING: next event allowed in $lw seconds (LOCAL CHECK for &#39;$_&#39;)\n&amp;quot;;
    next;
    }
  print &amp;quot;$tm: LOCAL  OK: $_&amp;quot;;

  # FLOOD CHECK: allow no more than 5 lines in 60 seconds
  my $gw = flood_check( 5, 60, &#39;GLOBAL&#39; );

  if( $gw ) # global wait time
    {
    print &amp;quot;WARNING: next event allowed in $gw seconds (GLOBAL CHECK)\n&amp;quot;;
    next;
    }
  print &amp;quot;$tm: GLOBAL OK: $_&amp;quot;;
  }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I named this &lt;code&gt;floodtest.pl&lt;/code&gt;. The of the test were: (&amp;rdquo;&amp;gt;&amp;rdquo; marks my input lines)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cade@aenea:~$ ./floodtest.pl 
&amp;gt; hello
Wed Feb 17 08:25:35 2004: LOCAL  OK: hello
Wed Feb 17 08:25:35 2004: GLOBAL OK: hello
&amp;gt; hello
Wed Feb 17 08:25:38 2004: LOCAL  OK: hello
Wed Feb 17 08:25:38 2004: GLOBAL OK: hello
&amp;gt; hello
WARNING: next event allowed in 5 seconds (LOCAL CHECK for &#39;hello&#39;)
&amp;gt; bye
Wed Feb 17 08:25:43 2004: LOCAL  OK: bye
Wed Feb 17 08:25:43 2004: GLOBAL OK: bye
&amp;gt; hello
Wed Feb 17 08:25:45 2004: LOCAL  OK: hello
Wed Feb 17 08:25:45 2004: GLOBAL OK: hello
&amp;gt; see you
Wed Feb 17 08:25:48 2004: LOCAL  OK: see you
Wed Feb 17 08:25:48 2004: GLOBAL OK: see you
&amp;gt; next time
Wed Feb 17 08:25:52 2004: LOCAL  OK: next time
WARNING: next event allowed in 43 seconds (GLOBAL CHECK)
&amp;gt; one more try?
Wed Feb 17 08:26:09 2004: LOCAL  OK: one more try?
WARNING: next event allowed in 26 seconds (GLOBAL CHECK)
&amp;gt; free again
Wed Feb 17 08:26:31 2004: LOCAL  OK: free again
WARNING: next event allowed in 4 seconds (GLOBAL CHECK)
&amp;gt; free again
Wed Feb 17 08:26:42 2004: LOCAL  OK: free again
Wed Feb 17 08:26:42 2004: GLOBAL OK: free again
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can see that I could not enter &amp;ldquo;hello&amp;rdquo; 3 times during the first 10 seconds but still I managed to enter one more &amp;ldquo;hello&amp;rdquo; a bit later (the 10-second flood had ended for the &amp;ldquo;hello&amp;rdquo; line) and 2 other lines before the global flood check triggered (5 lines for 1 minute). After 60 seconds, &lt;em&gt;floodtest.pl&lt;/em&gt; finally accepted my sixth line, &amp;ldquo;free again.&amp;rdquo;&lt;/p&gt;

&lt;p&gt;The next sections show how to use flood control in several applications. These examples are not exhaustive but are very common, so they will work as templates for other cases.&lt;/p&gt;

&lt;h3 id=&#34;span-id-my-scores-please-my-scores-please-span&#34;&gt;&lt;span id=&#34;my_scores_please&#34;&gt;My Scores Please?&lt;/span&gt;&lt;/h3&gt;

&lt;p&gt;Imagine an IRC bot (robot) which can report scores from the local game servers. Generally this bot receives requests from someone inside IRC channel (a chat room, for those of you who havenï¿½t used IRC) and reports current scores back to the channel. If this eventually becomes very popular, people will start requesting scores more frequently than it is useful just for fun, so there&amp;rsquo;s a clear need for flood control.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;d prefer to allow any user to request scores no more than twice per minute, but at the same time I want to allow 10 requests total every two minutes:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sub scores_request
{
    my $irc     = shift; # the IRC connection which I communicate over
                         # this is a Net::IRC::Connection object
    my $channel = shift; # the channel where &amp;quot;scores&amp;quot; are requested
    my $user    = shift; # the user who requested scores

    # next line means: do flood check for $user and if it is ok, then
    #                  check for global flood. this is usual Perl idiom.
    my $wait = flood_check( 2, 60, $user ) || flood_check( 10, 120, &#39;*&#39; );
    if( $wait ) # can be 0 or positive number so this check is simple
      {
      # oops flood detected, report this personally to the user
      $irc-&amp;gt;notice( $user, &amp;quot;please wait $wait seconds&amp;quot; );
      }
    else
      {
      # it is ok, there is no flood, print scores back to the channel
      $irc-&amp;gt;privmsg( $channel, get_scores() );
      }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This code uses the &lt;a href=&#34;https://metacpan.org/pod/Net::IRC&#34;&gt;Net::IRC&lt;/a&gt; module, so if you want to know the details of the &lt;code&gt;notice()&lt;/code&gt; and &lt;code&gt;privmsg()&lt;/code&gt; functions, check the module documentation.&lt;/p&gt;

&lt;p&gt;This is good example of combining events, but it works correctly only if the second flood ratio (in this case &lt;sup&gt;10&lt;/sup&gt;&amp;frasl;&lt;sub&gt;120&lt;/sub&gt;) is greater than first one (&lt;sup&gt;2&lt;/sup&gt;&amp;frasl;&lt;sub&gt;60&lt;/sub&gt;). Otherwise you should extend the &lt;code&gt;flood_check()&lt;/code&gt; function with an array of events to check in one loop, so if any of them fails the internal storage will update. Perhaps &lt;code&gt;Algorithm::FloodControl&lt;/code&gt; will have such a feature in the future.&lt;/p&gt;

&lt;p&gt;Another common case is to limit the execution of resource-consuming web scripts (CGI).&lt;/p&gt;

&lt;h3 id=&#34;span-id-don-t-flood-the-page-don-t-flood-the-page-span&#34;&gt;&lt;span id=&#34;_don_t__flood_the_page_&#34;&gt;(Don&amp;rsquo;t) Flood the Page!&lt;/span&gt;&lt;/h3&gt;

&lt;p&gt;If you want to limit CGI-script execution you will hit a problem: you must save and restore the flood-control internal data between script invocations. For this reason the &lt;code&gt;Algorithm::FloodControl&lt;/code&gt; module exports another function called &lt;code&gt;flood_storage&lt;/code&gt;, which can get or set the internal data.&lt;/p&gt;

&lt;p&gt;In this example I&amp;rsquo;ll use two other modules, &lt;a href=&#34;https://metacpan.org/pod/Storable&#34;&gt;Storable&lt;/a&gt; and &lt;a href=&#34;https://metacpan.org/pod/LockFile::Simple&#34;&gt;LockFile::Simple&lt;/a&gt;. I use the first to save and restore the flood-control data to and from disk files and the second to lock this file to avoid corruptions if two or more instances of the script run at the same time:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/usr/bin/perl
use strict;
use Storable qw( store retrieve );
use LockFile::Simple qw( lock unlock );
use Algorithm::FloodControl;

# this is the file that should keep the flood data though /tmp is not
# the perfect place for it
my $flood_file = &amp;quot;/tmp/flood-cgi.dat&amp;quot;;

# this is required so the web browser will know what is expected
print &amp;quot;Content-type: text/plain\n\n&amp;quot;;

# I wanted to limit the script executions per remote IP so I have to
# read it from the web server environment
my $remote_ip = $ENV{&#39;REMOTE_ADDR&#39;};

# first of all--lock the flood file
lock( $flood_file );

# now read the flood data if flood file exists
my $FLOOD = retrieve( $flood_file ) if -r $flood_file;

# load flood data into the internal storage
flood_storage( $FLOOD ) if $FLOOD;

# do the actual flood check: max 5 times per minute for each IP
# this is the place where more checks can be done
my $wait = flood_check( 5, 60, &amp;quot;TEST_CGI:$remote_ip&amp;quot; );

# save hte internal data back to the disk
store( flood_storage(), $flood_file );

# and finally unlock the file
unlock( $flood_file );

if( $wait )
  {
  # report flood situation
  print &amp;quot;You have to wait $wait seconds before requesting this page again.\n&amp;quot;;
  exit;
  }

# there is no flood, continue with the real work here
print &amp;quot;Hello, this is main script here, local time is:\n&amp;quot;;
print scalar localtime;
print &amp;quot;\n...\n&amp;quot;;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There are various issues to consider, such as the save/restore method, time required, and locking, but in any case the scheme will be similar.&lt;/p&gt;

&lt;h3 id=&#34;span-id-beep-beep-beep-beep-beep-beep-span&#34;&gt;&lt;span id=&#34;beep__beep__beep___&#34;&gt;Beep, Beep, Beep &amp;hellip;&lt;/span&gt;&lt;/h3&gt;

&lt;p&gt;In this last example I&amp;rsquo;ll describe a small program, a variation of which I use for (email) SMS notifications. I wanted to avoid scanning large mail directories so I made my email filter copy incoming messages into a separate folder. The program scans this copy folder every 10 minutes for new messages. If there are any, it sends a notification for each one to my mobile phone and removes the copy of the message.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#!/usr/bin/perl
use strict;
use Algorithm::FloodControl;

our $MAIL_ROOT = &#39;/home/cade/mail&#39;;
our @SCAN = ( 
              { # this is my personal mail, I&#39;d like to be notified often
                FOLDER  =&amp;gt; &#39;Personal2&#39;, # directory (mail folder) to scan
                FC      =&amp;gt; 20,          # fixed event count
                FP      =&amp;gt; 60*60,       # fixed time period, 1 hour
              }, 
              { # this is a mailing list, I don&#39;t need frequent notifications
                FOLDER  =&amp;gt; &#39;AList2&#39;,    # directory (mail folder) to scan
                FC      =&amp;gt; 3,           # fixed event count
                FP      =&amp;gt; 20*60,       # fixed time period, 20 minutes
              }
            );
while(4)
  {
  process_folder( $_ ) for @SCAN;
  sleep(10*60); # sleep 10 minutes
  }

sub process_folder
{
  my $hr     = shift; # this is hash reference
  my $fc     = $hr-&amp;gt;{ &#39;FC&#39; };
  my $fp     = $hr-&amp;gt;{ &#39;FP&#39; };
  my $folder = $hr-&amp;gt;{ &#39;FOLDER&#39; };

  my @msg = glob &amp;quot;$MAIL_ROOT/$folder/*&amp;quot;;
  return unless @msg; # no messages found
  for( @msg )
    {
    # there are new messages, so flood check is required
    my  $wait = flood_check( $fc, $fp, $folder );
    if( $wait )
      {
      # skip this pass if non-zero wait time is received for this folder
      print &amp;quot;FLOOD! $wait seconds required.\n&amp;quot;;
      return;
      }
    send_sms( $folder, $_ );
    }
}

sub send_sms
{
  my $folder = shift;
  my $file   = shift;
  # implementation of this function is beyond the scope of this example
  # so I&#39;ll point just that it extracts subject line from the message file
  # and sends (over local sms gateway) text including folder name, time 
  # and subject
  unlink( $file );
  print &amp;quot;SMS: $folder, $file\n&amp;quot;;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As you can see, this code &amp;ndash; while implementing a totally different task &amp;ndash; has exactly the same flood check as in the previous two examples.&lt;/p&gt;

&lt;h3 id=&#34;span-id-conclusion-conclusion-span&#34;&gt;&lt;span id=&#34;conclusion&#34;&gt;Conclusion&lt;/span&gt;&lt;/h3&gt;

&lt;p&gt;I said in the beginning that flood control has a vast field of applications. There are many cases where it is appropriate or even necessary. There is no excuse to avoid such checks; implementing it is not hard at all.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>

