<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" id="sixapart-standard">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="Movable Type Pro 5.13-en" />
<link rel="stylesheet" href="/pub/styles.css" type="text/css" />
<link rel="start" href="/pub/" title="Home" />
<link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/pub/atom.xml" />
<script type="text/javascript" src="/pub/mt.js"></script>
<!--
<rdf:RDF xmlns="http://web.resource.org/cc/"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="/pub/">
<dc:title>Perl.com</dc:title>
<dc:description>news and views of the Perl programming language</dc:description>
<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/3.0/" />
</Work>
<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/3.0/">
</License>
</rdf:RDF>
-->

<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-50555-22']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
   'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
   'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
   s.parentNode.insertBefore(ga, s);
 })();

</script>
<script type='text/javascript' src='http://partner.googleadservices.com/gampad/google_service.js'></script>
<script type='text/javascript'>
GS_googleAddAdSenseService("ca-pub-4136420132070439");
GS_googleEnableAllServices();
</script>
<script type='text/javascript'>
GA_googleAddSlot("ca-pub-4136420132070439", "Perl_728x90");
</script>
<script type='text/javascript'>GA_googleFetchAds();</script>
    <title>Perl.com: December 2004 Archives</title>


    <link rel="prev" href="/pub/2004/11/" title="November 2004" />
    <link rel="next" href="/pub/2005/01/" title="January 2005" />

</head>
<body id="perl-com" class="mt-archive-listing mt-datebased-monthly-archive layout-wt">
    <div id="container">
        <div id="container-inner">


            <div id="header">
    <div id="header-inner">
        <div id="header-content">
        <span id="top_advert"> 
<!-- Put any landscape advert in here -->
<!-- Perl_728x90 -->
<script type='text/javascript'>
GA_googleFillSlot("Perl_728x90");
</script>
        </span> 



            <div id="header-name"><a href="/pub/" accesskey="1">Perl.com</a></div>
            <div id="header-description">news and views of the Perl programming language</div>




        </div>
    </div>
</div>



            <div id="content">
                <div id="content-inner">


                    <div id="alpha">
                        <div id="alpha-inner">


                            <h1 id="page-title" class="archive-title">December 2004 Archives</h1>





                            
                            <div id="entry-1042" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/p6pdigest/20041227.html" rel="bookmark">This Fortnight in Perl 6, December 7-20 2004</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2004-12-29T00:00:00-08:00">December 29, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>All~</p>

<p>The observant among you might notice that I missed last week's summary.
With the hubbub and confusion of the holidays, I blame ninjas, in particular
Ryu Hyabusa. Given that Christmas is next weekend and New Years is the weekend
after that, what you are like to see in the future are a pair of ten-day
summaries or some other equally irregular pattern. If you are thinking of using
the dates of my summaries to seed a random number generator, I would advise
against it as I can be really easily bought ;-). Without more ado, I give you
this fortnight's summary starting with:</p>

<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/a93c3142b1e5d4d0/00f8f30b2072ddd0?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#00f8f30b2072ddd0">Lexical
Scope of Parametric Declaration Blocks</a></h4>

<p>Ashley Winters wanted to know the differences between type parameter
lists and sub parameter lists. Luke Palmer could not think of any.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/9cb275722aa327b3/263c711b28d1c416?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#263c711b28d1c416">Object
Representation</a></h4>

<p>Abhijit Mahabal noticed that S12 allowed one to supply an object layout to
<code> bless()</code> and wondered if one could really have two instances of
the same class with different layouts. Larry admitted that he had probably not
intended for that to be the case.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/9516165d4ac18d9f/311a1cfb4d81a5e0?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#311a1cfb4d81a5e0">Capturing
into a Hash, Hypothetically</a></h4>

<p>Patrick R. Michaud wondered about capturing things into a hash in S05, as
<code>&lt;ident&gt;</code> now captures. Larry admitted that it was probably supposed
to be <code>(&lt;&lt;ident&gt;&gt;)</code> but also noticed that this exposed
a blind spot in the design. He ruminated about this blind spot and ways to
solve it.  After much churning, he decided that it would be possible to perform
multiple different (but identically named) rule captures by adding information
after a dash a la <code>&lt;ws-1&gt; &lt;ws-2&gt; &lt;ws-3&gt;</code>.</p>
<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">
<!-- sidebar ends -->
<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/0a68ecc0a9b5813b/7ff38e73da762a8d?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#7ff38e73da762a8d">Custom
Subscripting</a></h4>

<p>When talking about key Type for a hash, Larry offhandedly commented about
attaching a block to a hash or array to provided custom subscripting.  Many
people drooled over the awesome syntactic sugar this could provide them.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/faa9911197e3fe6d/778ad6a110772849?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#778ad6a110772849">Undeclared
Attributes</a></h4>

<p>Dave Whipp hoped that he need not predeclare his attributes; as they
necessarily start with <code> $. </code> The fact that a new variable is an
attribute is easy to determine. Abhijit Mahabal thought that it would not be a
good idea but then asked if classes could be declared as not strict.  We're
still waiting for more official word...</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/45b5fce6d7d18e88/ff71ab8ff22ed0c4?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#ff71ab8ff22ed0c4">Classes
Which Autovivify Attributes</a></h4>

<p>Abhijit Mahabal wondered about creating a class that populates its
attributes on demand, as some of them might be rarely used. Larry suggested
that it would be something that one should not undertake lightly, and a simple
hash attribute would provide most of what he wanted. This also morphed into the
eternal debate about strictures and oneliners. There has to be a joke in there
somewhere.  A stricture, a oneliner, and Larry Wall walk into a bar....</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/95a14742f1904bc6/e85fa6de2d11f06a?_done=%2Fgroup%2Fperl.perl6.language%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#e85fa6de2d11f06a">Auto
<code>my</code></a></h4>

<p>Rod Adams wondered if having <code>my</code> occur automatically for new
variables might be worthwhile. Several people commented that some languages
already do this, and it is simply an aesthetic choice. The consensus seems to be
that Perl has already made this choice and will stick with its answer.</p>

<h3>Perl 6 Compiler</h3>

<p>At long last, Google has picked up P6C. I guess I have slightly mixed
emotions about this, as it takes a running gag from me. Alas, I will have to
find another.</p>

<h4>PGE Tests</h4>

<p>Markus Laire began working on a formerly small script to convert Perl 5's
regex tests to PGE. He produced a modest 700 tests, a few of which pass.  Nice
work. Patrick suggested only running the script once and thereafter maintaining
the tests external to Perl 5.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/d18f4d37358ced6a/808f24640b57dea5?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#808f24640b57dea5">Initial
post</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/b605f0c589ab19ec/113710d10a083013?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#113710d10a083013">Patrick's
suggestion</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/c71ba440a427f1ec/d6bff60bb550bb5c?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#d6bff60bb550bb5c">How
to deal with abiguity converting</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.compiler/browse_frm/thread/af402d8eaa2595f5/9eb81f98e5378ec9?_done=%2Fgroup%2Fperl.perl6.compiler%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#9eb81f98e5378ec9">On
your marks, get set, HACK! </a></h4>

<p>Luke Palmer opened the door to hacking and has requested rules for parts of
the Perl 6 Grammar. Patrick posted a link to <a
href="https://svn.perl.org/perl6">its SVN repository</a>.</p>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/43c5b9c73e4848db/217436af13c0c9fc?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#217436af13c0c9fc">"\0namespace"</a></h4>

<p>Leo committed a fix to support namespace mangling.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/5c5e46756cd4f05d/c1f10ac184af35a4?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#c1f10ac184af35a4">Store
Global =&gt; Invalidate Method Cache</a></h4>

<p>Leo committed a fix to invalidate the method cache when storing a global.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/70b44974c2860073/d03c349941977f0a?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d03c349941977f0a"><code>pow</code>,
<code>hash</code>, Batman Sound Effects! </a></h4>

<p>Leo added <code>pow</code> and <code>hash</code> as vtables and opcodes. He
also renamed <code>new_extended</code> to <code>instantiate</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c15476e3c9ca138b/58854737da2e4401?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#58854737da2e4401">Base
Scalar Semantics</a></h4>

<p>Leo asked for comments about base PMC semantics and received none.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/46c2a1cf65c48c58/e1ec9e4ea1117694?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#e1ec9e4ea1117694"><code>split</code>
Now Independent of Perl</a></h4>

<p>James deBoer provided a patch removing the dependency on
<code>PerlArray</code> in <code>split</code>. Will applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a915411ce0206fd0/82349b8a0e5db102?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#82349b8a0e5db102">SVN</a></h4>

<p>Periodically, every project has a thread about switching some basic
tool to another basic tool. This time, the thread is in P6I, and the tools in
questions are CVS and SVN. Many voiced support, but no one decided anything
with any permanence.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/214157bf29879710/9c8d3ba8639d45bd?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#9c8d3ba8639d45bd">Continuations</a></h4>

<p>At long last, the long-running continuation thread has died down. Unless I am
mistaken, the status quo remains, and return continuations should restore
register contents even when promoted and repeatedly invoked.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/824cae85acf178d8/ec3f0af4b6a154b1?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ec3f0af4b6a154b1">Correctly
Dispatching Opcodes and Functions</a></h4>

<p>Sam Ruby had some concern about dynamically overloading <code>__add__</code>
in Python. Leo and Sam had quite a bit of back and forth about the proper way
to handle it. I am not sure what resolution they reached other than that it
should work.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/d96a195d3dd44766/c595678463d6d0f1?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#c595678463d6d0f1">Dynamic
libs and Tcl Issues</a></h4>

<p>Klaas-Jan Stol had some problems with Tcl and dynamic libs. Sam Ruby
provided the necessary fix for him.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/250ece92585432cd/d19c4b68f91fe9e6?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d19c4b68f91fe9e6">Class
Refactoring</a></h4>

<p>Leo began refactoring base PMCs such as Integer. He also started a TODO of
what remains. This somehow morphed into discussion of logical
<code>xor</code>...</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/10979f287b2fa6cb/35717d665efc53de?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#35717d665efc53de">Register
Coloring Issues</a></h4>

<p>Dan posted a failing test case for the register coloring. Leo fixed it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/1f158c4366c62885/fd4e276e287c7e4c?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#fd4e276e287c7e4c"><code>split</code>
on String vs Regex</a></h4>

<p>James deBoer wondered about the <code>split</code> opcode's current
insistence on a string. Some advocated making it a method on a class, while
others wanted to change the opcode to take a PMC instead of a string.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e5cee4871a9e1fc7/8581b2b9f395c419?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#8581b2b9f395c419"><code>self</code>
vs P2</a></h4>

<p>Sam Ruby discovered that usages of P2 had broken, as it was no longer the
object of a method. Fortunately, Leo provided the helpful <code>self</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3cf8e317d26e3bcf/7a6ddc2d2cf14b33?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#7a6ddc2d2cf14b33">Linux
PPC</a></h4>

<p>Long ago, there were troubles with Linux on PPC. Recently, chromatic
submitted a patch. More recently, Warnock applied.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/373ac21fc9db4bfe/3859a503c0a5de90?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#3859a503c0a5de90">Whether
vs Weather</a></h4>

<p>This morning it was cold and snowy. Sadly, instead of fixing my dreary
weather, chromatic fixed a mistyped "whether."</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/9f09741447b66ebc/6ba693efa9e2b84c?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#6ba693efa9e2b84c">Benchmarks
as Test</a></h4>

<p>Justin DeVuyst supplied a patch to use the benchmarks as tests. Leo applied
it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/dece7f5cabdd5ded/07b5495abd2ea138?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#07b5495abd2ea138"><code>make
[install|docs|monkeys]</code></a></h4>

<p>Adrian Lambeck suggested a few improvements to the current make set up,
including a cool sounding <code>make doc-install</code>. Warnock applied.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/daf976c64a96f368/bb340708ab6ae1f0?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#bb340708ab6ae1f0">Dan
Still Alive</a></h4>

<p>Dan sent an apology about the egregious amount of work he had and assured
everyone that he was actively trying to get caught up. In the mean time, Cc him
on things that need his personal attention, like your Christmas lists.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/537ebd7fb3e715de/a80c6b7e0de25dac?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#a80c6b7e0de25dac">IMCC
Parser No Longer Chokes on Empty Sub</a></h4>

<p>Will noted that gremlins had fixed a problem in IMCC with empty subs.  Yay,
gremlins!</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3982c73332ba5d65/90b236b18b324053?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#90b236b18b324053">Current
Object Invocation</a></h4>

<p>Dan discovered that Parrot put the current object into its place after
calling <code>invoke</code>. This was, of course, bad, so Leo fixed it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/123a57c984ae3255/7df334dcb5f20e2d?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#7df334dcb5f20e2d">Configure
Help</a></h4>

<p>Somebody had trouble with <em>Configure.pl</em>. Leo pointed out the
usefulness of <code>--verbose=2</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/76056987830cd723/d8d8d2a561ccde3d?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d8d8d2a561ccde3d"><code>./parrot
nonexistant.pbc</code> =&gt; core dump</a></h4>

<p>Dan noticed that Parrot would core dump when given a nonexistance bytecode
file. Matthew Zimmerman and chromatic fought to get a patch in first. One
succeeded.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/8e9693869a5eb19f/142c9526f7d82393?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#142c9526f7d82393">Python
Dynclasses Build Issues</a></h4>

<p>Will noticed a multiple definition problem in the py* dynclasses. Sam
fixed it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/adae2ebb6eb3533d/d0016a8a5f0be7c4?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d0016a8a5f0be7c4">MMD
Dispatch Problem</a></h4>

<p>Jens Rieks reported a problem with <code>mmd_dispatch_v_pnp</code>. Leo
could not reproduce it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0ec537181da1dc6b/d90b30500b8748a7?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d90b30500b8748a7
">mod_parrot with Mandelbrot</a></h4>

<p>Jeff Horwitz posted a link to a <a
href="http://www.smashing.org/mod_parrot">webpage using mod_parrot to generate
ASCII Mandelbrot sets</a>. Really cool, but I prefer Julia sets.</p>

<h4>Documentation Shortcomings</h4>

<p>Dave Brondsema pointed out that the main FAQ should include info on the IRC
channels/hosts that Parroters use. He also noted that some PDDs were not
available on the website. Warnock applies.</p>

<ul>

<li><a href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ee16a6a40951a989/b663216e7a62b099?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#b663216e7a62b099">irc</a></li>

<li><a href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a53a24f2aa5cc202/688e5dfc2a999e48?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#688e5dfc2a999e48">pdd</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ae4a03fb5d3df295/616f25e5d43348ba?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#616f25e5d43348ba">Scope
Cleanup Issues</a></h4>

<p>Leo and Dan hashed out some of the issues with scope clean up and stale
registers keeping things alive.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7b3d26581e5a951d/db228ae4d47bf138?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#db228ae4d47bf138">WinXP
Duild Issues</a></h4>

<p>Nicu Ionita reported a problem with the build on WinXP. Leo fixed it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/47689b780a1f7941/be5fa7f74b4d5d1a?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#be5fa7f74b4d5d1a"><code>runops_fromc</code></a></h4>

<p>Sam Ruby provided a patch allowing <code>runops_fromc</code> access to
registers. Leo applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a19458c4fa570074/fbb6658956e0c04e?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#fbb6658956e0c04e">Parameter
Fillin Problem</a></h4>

<p>Dan posted about a problem he was having. Unforunately, he cannot make a
simple test case against CVS head, and Leo can't reproduce it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/6843a04696561442/b2f2337c4f026861?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#b2f2337c4f026861">Class
Autoload</a></h4>

<p>Leo added support for autoloading dynamic classes for Python and Tcl.  Sam
Ruby suggested ways to extend it further.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/51e645c36023c77f/f8c37497aaded1e8?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#f8c37497aaded1e8">P5
Is the New P2</a></h4>

<p>Sam and Leo came to the conclusion that the current object should be passed
in P5 as well as P2. Currently, they are waiting for Dan... nudge, nudge...</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/eb26d8206c8346d4/8f6474c75a47ed78?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#8f6474c75a47ed78"><code>get_anonymous_subclass</code></a></h4>

<p>Leo wondered what <code>get_anonymous_subclass</code> was for. Dan
explained.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/765fa0191688b49f/e23c8a3bdaa7bdde?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#e23c8a3bdaa7bdde">Context,
Wrappers, Rules, NCI</a></h4>

<p>Sam and Leo had a discussion about what exactly VTABLE functions, MMD
functions, and ops should do. I think they spent much of the time talking past
each other and all of it talking past me.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/993244d2e68bb808/246944c41bf29963?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#246944c41bf29963">Namespaces
As Objects</a></h4>

<p>Sam Ruby wants to use namespaces as objects. Leo is not so sure that this is
right. This turned into a dialog about <code>find_method</code>.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/34a7b8bc69c0da2f/693149f9f0297a61?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#693149f9f0297a61">POD
Cleanup</a></h4>

<p>chromatic provided and threatened to apply a patch fixing up some of the POD
nits.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/116e7b185d9c06e7/1f6d824eb2874c2f?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#1f6d824eb2874c2f">Plain
Ole <code>Hash</code></a></h4>

<p>Bernhard Schmalhofer provided a patch cleaning up <code>Hash</code>. Sam
wondered if the NCI calls in <code>Hash::fromkeys</code> could go away along
with a few others.  Leo said that iterators in general needed another
round of thought.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/39f5a1d8f7a23d4e/aa2c0177c22b12f8?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#aa2c0177c22b12f8">Opcode/Sub
Conflict</a></h4>

<p>Dave Brondsema notice that there was a problem with subs whose names
conflict with opcodes. Luke Palmer provided a workaround.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/fe09eef1be4f75fd/4a07de3344219618?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#4a07de3344219618">Duplicate
Subclass Naming Errors</a></h4>

<p>Simon Glover noticed some problems with duplicate subclass names, notably
that one could not create two nameless classes.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e169f5cdf871ab52/27b9495dafd24c36?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#27b9495dafd24c36">MMD
and <code>VTABLE_find</code></a></h4>

<p>Leo suggested a mechanism for MMD and <code>VTABLE_find</code>. Sam Ruby provided some
input.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e169f5cdf871ab52/27b9495dafd24c36?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#27b9495dafd24c36">Auxiliary
Variables</a></h4>

<p>Tomas Necas wondered about the necessity of auxiliary variables in
Perl 6. Luke Palmer and Dan provided some answers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/1a49ff84b16b7198/d2fed737536f94c5?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d2fed737536f94c5">N
Register Stomping</a></h4>

<p>Dan noticed that something stomped his N registers occasionally.</p>

<h3>The Usual Footer</h3>

<p>If you find these summaries useful or enjoyable, please consider
contributing to the Perl Foundation to help support the development of Perl.
You might also like to send feedback to ubermatt@gmail.com</p>

<ul>

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>

</ul>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1036" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/29/3d_engine.html" rel="bookmark">Building a 3D Engine in Perl, Part 2</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Geoff Broadwell</span> on <abbr class="published" title="2004-12-29T00:00:00-08:00">December 29, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<br clear="all" />
<p>This article is the second in a <a href="/pub/au/Broadwell_Geoff">series</a>
aimed at building a full 3D engine in Perl. The first article, <a
href="/pub/a/2004/12/01/3d_engine.html">Building a 3D Engine in Perl</a>,
covered basic program structure, opening an OpenGL window using SDL, basic
projection and viewing setup, simple object rendering, object transformations,
and depth ordering using the OpenGL depth buffer.</p>

<p><em>Editor's note: see also the rest of the series, <a href="/pub/a/2005/02/17/3d_engine.html">lighting and movement</a>, and <a href="/pub/a/2005/08/04/3d_engine.html">profiling your application</a>.</em></p>

<p>This time, I'll discuss rotating and animating the view, SDL event and
keyboard handling, and compensating for frame rate variations. As a bonus, I'll
demonstrate some real-world refactoring, including a conversion from procedural
to (weakly) object-oriented code. Before I start, however, there were a couple of
issues discovered since the first article went live:</p>

<ul>

<li>In the first article, I wrote "orthogonal projection." This should be
"orthographic projection," which reminds me again that no matter how many times
you proofread, you can still miss the bug--in code or in prose. Unfortunately,
prose is a bit harder to write tests for.</li>

<li><p>Todd Ross discovered a problem with SDL on FreeBSD 5.3, which caused the
code to die immediately with "Bad system call (core dumped)." A short while
later, he reported the workaround. He set his <code>LD_PRELOAD</code>
environment variable with a little magic, and everything worked fine:</p>


<pre><code>setenv LD_PRELOAD /usr/lib/libc_r.so</code></pre>

<p>His research method is a good one to follow if you should encounter a
similar problem. He installed another SDL_Perl application, in this case Frozen
Bubble. Once he was sure it worked, he checked the code in the launcher script
and found the magic shown above. A quick test confirmed that this worked for
his code as well.</p>

<p>Frozen Bubble is a 2D application, so if it works fine but your OpenGL
programs don't, check to make sure that OpenGL works at all. Unix variants
should supply the <code>glxinfo</code> and <code>glxgears</code> programs. Use
<code>glxinfo</code> to gather details on your OpenGL driver; it serves as both
a sanity check and a good addition to bug reports. <code>glxgears</code> does a
simple animated rendering of meshing gears. This tells you whether OpenGL works
correctly (at least for basic stuff) and what performance your OpenGL driver
and hardware can provide. Both programs work under X on Apple's OS X 10.3 as
well.</p></li>

</ul>

<p>Keep your comments, questions, and bug reports coming! I'd like to recognize
your contribution in the next article, but if you'd rather remain anonymous,
that's fine too.</p>

<p>Without further ado, let's start. If you want try the code at each stage
without all the typing, <a
href="/2004/12/29/examples/perl_opengl_2_examples.tar.gz">download the example
source code</a>. It includes a <em>README.steps</em> file that should help you
follow along more easily.</p>

<h3>Moving the Viewpoint</h3>

<p>At the end of the last article, our scene had a set of axis lines roughly in
the center of the screen, with a big white cube behind them and a rotated flat
yellow box to the right:</p>

<pre><code>sub draw_view
{
    draw_axes();

    glColor(1, 1, 1);
    glPushMatrix;
    glTranslate( 0, 0, -4);
    glScale( 2, 2, 2);
    draw_cube();
    glPopMatrix;

    glColor(1, 1, 0);
    glPushMatrix;
    glTranslate( 4, 0, 0);
    glRotate( 40, 0, 0, 1);
    glScale(.2, 1, 2);
    draw_cube();
    glPopMatrix;
}</code></pre>

<p>Let's move that white cube to the right by changing the first
<code>glTranslate</code> call as follows:</p>

<pre><code>glTranslate( 12, 0, -4);</code></pre>

<p>Now the right side of the window cuts off the white box. If I wanted to fix
that while maintaining the relative positions of all the objects, there are a
few possible changes I could make:</p>

<ul>

<li>Use a wider projection (FOV) angle to see more of the scene at once.
Unfortunately, it's already at 90 degrees, which is fairly wide. The
perspective effect is already very strong; much wider, and the rendering will
look too distorted.</li>

<li>Individually move all objects in the scene the same distance to the left.
This would certainly work, but is a lot of effort, especially when there are
many objects in the scene.</li>

<li>Move the viewpoint right to recenter the view. This is my preference.</li>

</ul>

<p>I want to move the viewpoint to the right, a positive X direction, so I add
+6 to the X component of the viewing translation:</p>

<pre><code>sub set_view_3d
{
    glTranslate(6, -2, -10);
}</code></pre>

<p>Now the scene is even <em>farther</em> to the right. The problem is that
OpenGL combines the transformations used to modify the view (<em>viewing</em>
transformations) with those used to transform objects in the scene
(<em>modeling</em> transformations) in the <em>modelview</em> matrix. OpenGL
has no way to know whether I intend any given modelview transformation to alter
the view or the objects in the scene; it treats all of them as altering the
objects. By translating +6 X, I effectively moved every object 6 units to the
right, rather than moving my viewpoint right as intended.</p>

<p>I hinted at the solution before: moving the viewpoint right is equivalent
to moving all objects in the scene to the left. The solution to this problem is
to reverse the sign of the translation:</p>

<pre><code>sub set_view_3d
{
    glTranslate(-6, -2, -10);
}</code></pre>

<p>This puts the viewpoint at (6, 2, 10) where I wanted it, roughly recentering
the scene. Now you can see why the viewing translation from the first article
moved the viewpoint to a point slightly above (+Y) and some distance closer to
the user (+Z) than the origin. I simply reversed the signs of the viewpoint
coordinates I wanted, (0, 2, 10).</p>

<p>The scene is now centered, but with this static view, it's difficult to tell
the true location and relative sizes of the objects in the scene. Perhaps I can
rotate the view a bit to see this. I'll rotate it 90 degrees counterclockwise
(positive rotation) around the Y axis:</p>

<pre><code>sub set_view_3d
{
    glTranslate(-6, -2, -10);
    glRotate(90, 0, 1, 0);
}</code></pre>

<p>Well, that certainly rotated things, but it's still hard to see where the
objects really are. Why did the scene end up all over on the left like that and
with the axis lines in front?</p>













<h3>Animating the View</h3>

<p>To understand what's really going on with an odd transformation, it helps me
to turn it into a short animation. I start the animation with a very small
transformation and keep increasing it until well past the intended level. This
way, I can see the effect of both smaller and larger changes.</p>

<p>To do this, I need a few more frames in the animation. I can do this by
changing the last line in <code>draw_frame</code>:</p>

<pre><code>$done = 1 if $frame == 10;</code></pre>

<p>I also want the rotation to animate with each frame:</p>

<pre><code>sub set_view_3d
{
    glTranslate(-6, -2, -10);
    glRotate(18 * $frame, 0, 1, 0);
}</code></pre>

<p>This chops the rotation into 18 degree increments, starting at frame 1 with
an 18 degree rotation and ending at frame 10 with a 180 degree rotation.</p>

<p>Running this program shows what is happening. The scene rotates
counterclockwise around its origin, the intersection point of the axis lines. I
wanted to rotate the viewpoint, but I rotated the objects instead. Just
reversing the sign won't do the trick. That will rotate the scene the other
direction (clockwise), but it won't rotate around the viewpoint--it will
still rotate around the scene origin.</p>

<p>In the first article, I described how to visualize a series of transforms by
thinking about transforming the local coordinate system of the objects in a
series of steps. Looking at the code above, you can see that it first
translates the scene origin away and then rotates around that new origin. To
rotate around the viewpoint, I need to rotate first and then translate the
scene away:</p>

<pre><code>sub set_view_3d
{
    glRotate(18 * $frame, 0, 1, 0);
    glTranslate(-6, -2, -10);
}</code></pre>

<p>This now rotates around the viewpoint, but because it rotates 180 degrees
starting from dead ahead, the scene ends up behind the viewpoint. To start the
view so that the scene is on one side and then rotates to be on the other, I
simply offset the angle:</p>

<pre><code>sub set_view_3d
{
    glRotate(-90 + 18 * $frame, 0, 1, 0);
    glTranslate(-6, -2, -10);
}</code></pre>

<p>At frame 1, the rotation angle is -90 + 18 * 1 = -72 degrees. At frame 10,
the angle is -90 + 18 * 10 = 90 degrees.  Perfect.</p>

<h4>Stop and Turn Around</h4>

<p>There's only one little problem: it's going the wrong way! I wanted to do a
counterclockwise rotation of the view, but that should make the scene appear to
rotate <em>clockwise</em> around the viewpoint. Imagine standing in front of a
landmark, taking a picture. Looking through the viewfinder, you might notice
that the landmark is a bit left of center. To center it, turn slightly left
(counterclockwise as seen from above, or around +Y in the default OpenGL
coordinate system). This would make the landmark appear to move clockwise
around you (again as seen from above), moving it from the left side of the
viewfinder to the center.</p>

<p>In this case, reverse the angle's sign:</p>

<pre><code>sub set_view_3d
{
    glRotate(90 - 18 * $frame, 0, 1, 0);
    glTranslate(-6, -2, -10);
}</code></pre>

<p>In fact, every transformation of the view is equivalent to the opposite
transformation of every object in the scene. You must reverse the sign of the
coordinates in a translation, reverse the sign of the angle in a rotation, or
take the inverse of the factors in a scaling (shrinking the viewer to half size
makes everything appear twice as big). As we saw before, you must reverse the
order of rotation and translation as well.</p>

<p>Scaling is a special case. Inverting the factors works, but you must still do
the scaling after the translation to achieve the expected effect, rather than
following the rule for rotation and translation and reversing the
transformation order completely.  The reason is that scaling before the
translation scales the translation also. Scaling by (2, 2, 2) would double the
size of all of the objects in the scene, but it would also put them twice as
far away, making them appear the same size. I'll skip the code for this and
leave it as an exercise for the reader. Go ahead, have fun.</p>

<p>If you decide to give view scaling a try, remember that all distances will
change. This affects some non-obvious things such as the third and fourth
arguments to <code>gluPerspective</code> (the distance to the nearest and
farthest objects OpenGL will render).</p>

<h3>Smoothing It Out</h3>

<p>After watching these animations for a while, the jerkiness really begins to
bother me, and because I doubled the number of animation frames, it takes twice
as long to finish a run.  Both of these problems relate to the second-long
sleep at the end of <code>draw_frame</code>. I should be able to fix them by
shortening the sleep to half a second:</p>

<pre><code>sleep .5;</code></pre>

<p>Chances are, that doesn't yield quite the respected result. On my system,
there's a blur for a fraction of a second, and the whole run is done.
Unfortunately, the builtin Perl <code>sleep</code> function only handles
integer seconds, so .5 truncates to 0 and the <code>sleep</code> returns almost
instantly.</p>

<p>Luckily, SDL provides a millisecond-resolution delay function,
<code>SDL::Delay</code>. To use it, I add another subroutine to handle the
delay, translating between seconds and milliseconds:</p>

<pre><code>sub delay
{
    my $seconds = shift;

    SDL::Delay($seconds * 1000);
}</code></pre>

<p>Now, changing the <code>sleep</code> call to <code>delay</code> fixes it:</p>

<pre><code>delay(.5);</code></pre>

<p>The movement is faster and it only takes five seconds to complete the entire
animation again, but this code still wastes the available performance of the
system. I want the animation to be as smooth as the system allows, while
keeping the rotation speed (and total time) constant. To implement this, I need
to give the code a sense of time. First, I add another global to keep the
current time:</p>

<pre><code>my ($time);</code></pre>

<p>At this point, my editor likely just sprayed his screen with whatever he's
drinking and coughed "Another global?!?" I'll address that later in this
article during the refactoring.</p>

<p>To update the time, I need a couple more functions:</p>

<pre><code>sub update_time
{
    $time = now();
}

sub now
{
    return SDL::GetTicks() / 1000;
}</code></pre>

<p><code>now</code> calls SDL's <code>GetTicks</code> function, which returns
the time since SDL initialization in milliseconds. It converts the result back
to seconds for convenience elsewhere. <code>update_time</code> uses
<code>now</code> to keep the global <code>$time</code> up to date.</p>

<p><code>main_loop</code> uses this to update the time before rendering the
frame:</p>

<pre><code>sub main_loop
{
    while (not $done) {
        $frame++;
        update_time();
        do_frame();
    }
}</code></pre>

<p>Because this version won't artificially slow the animation, I make two
changes to <code>draw_frame</code>. I remove the <code>delay</code> call and
change the animation end test to check whether the time has reached five seconds,
instead of whether frame ten has been drawn.</p>

<pre><code>sub draw_frame
{
    set_projection_3d();
    set_view_3d();
    draw_view();

    print '.';
    $done = 1 if $time &gt;= 5;
}</code></pre>

<p>Finally, <code>set_view_3d</code> must base its animation on the current
time instead of the current frame. Our current rotation speed is 18 degrees per
frame. With 2 frames per second, that comes to 36 degrees per second:</p>

<pre><code>sub set_view_3d
{
    glRotate(90 - 36 * $time, 0, 1, 0);
    glTranslate(-6, -2, -10);
}</code></pre>

<p>This version should appear much smoother. On my system, the dots printed for
each frame scroll up the terminal window. If you run this program multiple
times, you'll notice the number of frames (and hence dots) varies. Small
variations in timing from numerous sources cause a frame now and then to take
more or less time. Over the course of a run, this adds up to being able to
complete a few frames more or less before hitting the five second deadline.
Visually, the rotation speed should appear nearly constant because it calculates
the current angle from the current time, whatever that may be, rather than the
frame number.</p>













<h3>Refactoring for Fun and Clarity</h3>

<p>Now that the animation is smooth, I'm almost ready to add some manual
control using SDL events. That's a big topic and involves a lot of code. It's
always a good idea before a big change to step back, take a look at the
exisiting code, and see if it needs a clean up.</p>

<p>The basic procedure is as follows:</p>

<ul>
<li>Find one obvious bit of ugliness.</li>
<li>Make a small atomic change to clean it up.</li>
<li>Test to make sure everything still works.</li>
<li>Lather, rinse, repeat until satisfied.</li>
</ul>

<p>Unfortunately, it's occasionally necessary to make one part of the code a
little uglier while cleaning up something else. The trick is eventually to
clean up the freshly uglified piece.</p>

<h4>Refactoring the View</h4>

<p>And on that note, let's add another global! I don't like the hardcoding of
<code>set_view_3d</code>. I'd like to convert that into a data structure of
some kind, so I define a view object:</p>

<pre><code>my ($view);</code></pre>

<p>This needs an update routine, so here's a simple one:</p>

<pre><code>sub update_view
{
    $view = {
        position    =&gt; [6, 2, 10],
        orientation =&gt; [-90 + 36 * $time, 0, 1, 0],
    };
}</code></pre>

<p>This is simply the position and orientation of the virtual viewer (before
the sign reversal needed by the viewing transformations). I need to call this
in the main loop, just before calling <code>do_frame</code>:</p>

<pre><code>sub main_loop
{
    while (not $done) {
        $frame++;
        update_time();
        update_view();
        do_frame();
    }
}</code></pre>

<p>At this point, running the program should show that nothing much changed because
I haven't actually changed the viewing code--the new code runs in parallel
with the old code. Using the new code requires replacement of
<code>set_view_3d</code>:</p>

<pre><code>sub set_view_3d
{
    my ($angle, @axis) = @{$view-&gt;{orientation}};
    my ($x, $y, $z)    = @{$view-&gt;{position}};

    glRotate(-$angle, @axis);
    glTranslate(-$x, -$y, -$z);
}</code></pre>

<p>Running the program should again show that nothing visually changed, indicating a
successful refactoring. At this point, you may wonder what this has gained;
there's a new global and a dozen or so more lines of code. The new code has
several benefits:</p>

<ul>

<li>The concepts of animating the view parameters and setting the current view
in OpenGL are now separate, as they should be.</li>

<li>Hoisting the <code>update_view</code> call up to <code>main_loop</code>
next to the <code>update_time</code> call begins to collect all updates
together, cleaning up the overall design.</li>

<li>The new code hints at further refactoring opportunities.</li>

</ul>

<p>In fact, I can see several problem places to refactor next, along with some
reasons to fix them:</p>

<ol>

<li>The mess of globals, since I just added one.</li>

<li>Updating <code>$done</code> in <code>draw_view</code> (mixing updates and
OpenGL work again) to continue collecting all updates together.</li>

<li>Pervasive hardcoding in <code>draw_view</code>, for all the same reasons I
refactored <code>set_view_3d</code>.</li>

</ol>

<h4>The Great Global Smashing</h4>

<p>The globals situation is out of hand, so now seems a good time to fix that
and check off the first item of the new "pending refactoring" list. First, I
need to decide how to address the problem.</p>

<p>Here's the current globals list:</p>

<pre><code>my ($done, $frame);
my ($conf, $sdl_app);
my ($time);
my ($view);</code></pre>

<p>In this mess, I see several different concepts:</p>

<ul>
<li>Configuration: <code>$conf</code></li>
<li>Resource object: <code>$sdl_app</code></li>
<li>Engine state: <code>$done</code>, <code>$frame</code></li>
<li>Simulated world: <code>$time</code>, <code>$view</code></li>
</ul>

<p>I'll create from these groupings a single engine object laid out like so
(variables show where the data from the old globals goes):</p>

<pre><code>{
    conf     =&gt; $conf,
    resource =&gt; {
        sdl_app =&gt; $sdl_app,
    },
    state    =&gt; {
        done    =&gt; $done,
        frame   =&gt; $frame,
    },
    world    =&gt; {
        time    =&gt; $time,
        view    =&gt; $view,
    }
}</code></pre>

<p>This is a fairly radical change from the current code, so to be safe, I'll do
it in several small pieces, testing after each version that everything still
works.</p>

<p>The first step is to add a constructor for my object:</p>

<pre><code>sub new
{
    my $class = shift;
    my $self  = bless {}, $class;

    return $self;
}</code></pre>

<p>This is pretty much the garden variety trivial constructor in Perl 5. It
blesses a hash reference into the specified class and then returns it. I also
need to change my <code>START</code> code to use this new constructor to create
an object and call <code>main</code> as a method on it:</p>

<pre><code>START: __PACKAGE__-&gt;new-&gt;main;</code></pre>

<p>This snippet constructs a new object, using the current package as the class
name, and immediately calls the <code>main</code> method on the returned
object. <code>main</code> doesn't have any parameters, so calling it as a
method won't affect it (there are no existing parameters that would be shifted
right by a new invocant parameter). I never store the object in a variable as a
form of self-imposed stricture. Because the object only exists as the invocant
of <code>main</code>, I must convert every routine that accesses the
information in the object to a method and change all calls to those routines as
well.</p>

<h5>Let It Flow</h5>

<p>Testing at this point shows all still works, so the next change is to make
<code>main</code> flow the object reference through to its children by calling
them as methods:</p>

<pre><code>sub main
{
    my $self = shift;

    $self-&gt;init;
    $self-&gt;main_loop;
    $self-&gt;cleanup;
}</code></pre>

<p>Testing this shows that, again, all is fine, as expected. <code>init</code>
and <code>main_loop</code> are changed in the obvious fashion
(<code>cleanup</code> doesn't do much, so it doesn't need to change now):</p>

<pre><code>sub init
{
    my $self = shift;

    $| = 1;

    $self-&gt;init_conf;
    $self-&gt;init_window;
}

sub main_loop
{
    my $self = shift;

    while (not $done) {
        $frame++;
        $self-&gt;update_time;
        $self-&gt;update_view;
        $self-&gt;do_frame;
    }
}</code></pre>

<p>Notice that I have not changed the references to <code>$done</code> and
<code>$frame</code> in <code>main</code>. It's important to make only a single
conceptual change at a time during refactoring, to minimize the chance of
making an error and not being able to figure out which change caused the
problem. I'll return to these references in a bit. Testing this version shows
that all is well, so I continue:</p>

<pre><code>sub do_frame
{
    my $self = shift;

    $self-&gt;prep_frame;
    $self-&gt;draw_frame;
    $self-&gt;end_frame;
}

sub draw_frame
{
    my $self = shift;

    $self-&gt;set_projection_3d;
    $self-&gt;set_view_3d;
    $self-&gt;draw_view;

    print '.';
    $done = 1 if $time &gt;= 5;
}</code></pre>

<p>Again, for this pass, I ignore <code>$done</code> and <code>$time</code> in
<code>draw_frame</code>. At this point, I've pretty much exhausted all of the
changes that amount to simply turning subroutine calls into method calls and
the code still works as advertised.</p>

<h5>Replacing the Globals</h5>

<p>With this working, I start into more interesting territory. It's time to
move the globals into their proper place in the object. First up are the state
variables <code>$done</code> and <code>$frame</code> in
<code>main_loop</code>:</p>

<pre><code>sub main_loop
{
    my $self = shift;

    while (not $self-&gt;{state}{done}) {
        $self-&gt;{state}{frame}++;
        $self-&gt;update_time;
        $self-&gt;update_view;
        $self-&gt;do_frame;
    }
}</code></pre>

<p>and the last line of <code>draw_frame</code>:</p>

<pre><code>$self-&gt;{state}{done} = 1 if $time &gt;= 5;</code></pre>

<p>As they are no longer globals, I remove their declarations as well. I will
have to come back to <code>draw_frame</code> again when cleaning up
<code>$time</code>. One change per pass--it's very easy to follow a long
chain of related changes before doing a test run and find out you made a
mistake. Somewhere. Argh. In this case, I resist the urge to keep changing the
code and do another test run immediately to find that indeed all still
works.</p>

<p>Next up is the world attribute <code>$view</code>:</p>

<pre><code>sub update_view
{
    my $self = shift;

    $self-&gt;{world}{view} = {
        position    =&gt; [6, 2, 10],
        orientation =&gt; [-90 + 36 * $time, 0, 1, 0],
    };
}

sub set_view_3d
{
    my $self = shift;

    my $view           = $self-&gt;{world}{view};
    my ($angle, @axis) = @{$view-&gt;{orientation}};
    my ($x, $y, $z)    = @{$view-&gt;{position}};

    glRotate(-$angle, @axis);
    glTranslate(-$x, -$y, -$z);
}</code></pre>

<p>In <code>set_view_3d</code>, it seemed clearest to make a lexical
<code>$view</code> loaded from the object. This allowed me to leave the rest of
the function clean and unchanged. Testing after the above changes and removing
the global declaration for <code>$view</code> shows that all is good.</p>

<p>Next up are <code>$conf</code> and the resource object
<code>$sdl_app</code>, following much the same pattern as before:</p>

<pre><code>sub init_conf
{
    my $self = shift;

    $self-&gt;{conf} = {
        title  =&gt; 'Camel 3D',
        width  =&gt; 400,
        height =&gt; 400,
        fovy   =&gt; 90,
    };
}

sub init_window
{
    my $self = shift;

    my $title = $self-&gt;{conf}&#123;title};
    my $w     = $self-&gt;{conf}{width};
    my $h     = $self-&gt;{conf}{height};

    $self-&gt;{resource}{sdl_app}
        = SDL::App-&gt;new(-title  =&gt; $title,
                        -width  =&gt; $w,
                        -height =&gt; $h,
                        -gl     =&gt; 1,
                       );
    SDL::ShowCursor(0);
}

sub set_projection_3d
{
    my $self   = shift;

    my $fovy   = $self-&gt;{conf}{fovy};
    my $w      = $self-&gt;{conf}{width};
    my $h      = $self-&gt;{conf}{height};
    my $aspect = $w / $h;

    glMatrixMode(GL_PROJECTION);
    glLoadIdentity;
    gluPerspective($fovy, $aspect, 1, 1000);

    glMatrixMode(GL_MODELVIEW);
    glLoadIdentity;
}

sub end_frame
{
    my $self = shift;

    $self-&gt;{resource}{sdl_app}-&gt;sync;
}</code></pre>

<p>The first time I did this, it broke. I had forgotten to make the changes to
<code>set_projection_3d</code>. Thanks to <code>use strict</code>, the error was
obvious, and a quick fix later, everything worked again.</p>

<p>Last but not least, it's time to fix the remaining world attribute
<code>$time</code>:</p>

<pre><code>sub update_time
{
    my $self = shift;

    $self-&gt;{world}{time} = now();
}</code></pre>

<p>In <code>update_view</code>, I continue with my tactic of creating lexicals
and leaving the remaining code alone:</p>

<pre><code>my $time = $self-&gt;{world}{time};</code></pre>

<p>Finally, the last line of <code>draw_frame</code> changes again:</p>

<pre><code>$self-&gt;{state}{done} = 1
    if $self-&gt;{world}{time} &gt;= 5;</code></pre>

<p>The first test run of the completed refactoring uncovered a typo that gave
an obscure warning. Thankfully, I only had to check the few changed lines since
the last test, and the typo was easily found. With things working again, The
Great Global Smashing is complete. The once completely procedural program is
now on its way to claiming object orientation. (Boy will I be happy to switch
to Perl 6 OO syntax! Perl 6 OO keeps the visual clarity of pure procedural code
while gaining several powerful benefits not available in Perl 5. I could fake
the clearer syntax with judicious use of source filtering, but that's another
article.)</p>

<p>This seems to me like enough refactoring for now, so it's back to the main
thrust of development: keyboard control.</p>













<h3>The Big Event</h3>

<p>Keyboard handling is a special case of SDL event handling, and not an
entirely trivial case at that. I'll start with the basic structure for
processing SDL events and handle a much simpler event first. To access SDL
events, I need to load the <code>SDL::Event</code> module:</p>

<pre><code>use SDL::Event;</code></pre>

<p>Like <code>SDL::App</code>, the code needs to keep track of an
<code>SDL::Event</code> resource object to access the event queue. In addition,
I need to keep track of which routine I'll use to process each event type. This
is a new kind of data, so I add a new branch to the engine object for various
lookup tables. To set up both of these, I add a new initialization function:</p>

<pre><code>sub init_event_processing
{
    my $self = shift;

    $self-&gt;{resource}{sdl_event} = SDL::Event-&gt;new;
    $self-&gt;{lookup}{event_processor} = {
        &amp;SDL_QUIT    =&gt; \&amp;process_quit,
    };
}</code></pre>

<p>SDL event types are constants in the general SDL constant convention
(UPPERCASE with a leading <code>SDL_</code> marker). The event type for quit
events is <code>SDL_QUIT</code>, which I associate with the
<code>process_quit</code> routine using a subroutine reference.</p>

<p>A new line at the end of <code>init</code> calls the initialization
routine:</p>

<pre><code>$self-&gt;init_event_processing;</code></pre>

<p>Every time through, the main loop should process events before updating the
view (after I add keyboard control, the view should update using the latest
user input). The contents of the loop in <code>main_loop</code> are now as
follows:</p>

<pre><code>$self-&gt;{state}{frame}++;
$self-&gt;update_time;
$self-&gt;do_events;
$self-&gt;update_view;
$self-&gt;do_frame;</code></pre>

<p><code>do_events</code> is very simple at this stage, just calling
<code>process_events</code> to, er, process pending SDL events:</p>

<pre><code>sub do_events
{
    my $self = shift;

    my $queue = $self-&gt;process_events;
}</code></pre>

<h4>The Event Processing Loop</h4>

<p><code>process_events</code> is where all the magic happens:</p>

<pre><code>sub process_events
{
    my $self = shift;

    my $event  = $self-&gt;{resource}{sdl_event};
    my $lookup = $self-&gt;{lookup}{event_processor};
    my ($process, $command, @queue);

    $event-&gt;pump;
    while (not $self-&gt;{state}{done} and $event-&gt;poll) {
        $process = $lookup-&gt;{$event-&gt;type} or next;
        $command = $self-&gt;$process($event);
        push @queue, $command if $command;
    }

    return \@queue;
}</code></pre>

<p>The first couple of lines provide shorter names for the previously stored
<code>SDL::Event</code> object and event processor lookup table. The rest of
the variables respectively store:</p>

<ul>

<li>A reference to the processing routine for the current event</li>
<li>The internal command to convert the event into</li>
<li>The queue of commands collected from incoming events</li>
</ul>

<p>The core of the code starts by telling the <code>SDL::Event</code> object to
gather any pending operating system events in preparation for the processing
loop, using the <code>pump</code> method. The processing loop checks to make
sure that a previous event has not flagged the <code>done</code> state, which
helps to improve responsiveness to quit events. Assuming that this has not
happened, the loop requests the next SDL event using
<code>SDL::Event::poll</code>. <code>poll</code> returns a false value when
there are no events ready for pickup, thereby exiting the loop.</p>

<p>The first line inside the loop uses the event type to look up the proper
event processing routine. If there is none, I use <code>next</code> to loop
again and check the next event.  Otherwise, the next line calls the processing
routine as a dynamically chosen method to handle the event. If the processing
routine determines that the event requires additional work, it should return a
command packet to be queued. If the event should be ignored, the processor
should simply return a false value.</p>

<p>The last line within the loop adds the command packet (if any) to the queue
awaiting further processing. Once the loop processes all available SDL events,
<code>process_events</code> returns the queue so that <code>do_events</code>
can perform the next stage of processing.</p>

<p>It may seem confusing that each time through the loop the code reuses the
same <code>$event</code>. You might expect <code>SDL::Event::poll</code> to
return the next waiting event (and perhaps <code>undef</code> when none
remain). Instead, the SDL API specifies that <code>poll</code> copies the data
from the next entry in the event queue into the event object, returning a true
or false status indicating whether this operation succeeded. As with some of
the OpenGL quirks, SDL_Perl copies this odd interface directly, easing the
transition for programmers used to the C API.</p>

<p>A consequence of this interface decision is that the event processing
routine must make a copy of any data from the SDL event object needed for
later. The call to <code>SDL::Event::poll</code> in the next iteration of the
processing loop will overwrite any data left in the SDL event object, so simply
storing the object reference won't work.</p>

<p>The <code>process_quit</code> routine doesn't need to save any data; it only
matters that an <code>SDL_QUIT</code> event occurred:</p>

<pre><code>sub process_quit
{
    my $self = shift;

    $self-&gt;{state}{done} = 1;
    return 'quit';
}</code></pre>

<p><code>process_quit</code> first sets the <code>done</code> state flag, which
causes the loop in <code>process_events</code> to exit early and, more
importantly, exits <code>main_loop</code>. It returns the simplest type of
command packet, a string indicating the <code>quit</code> command. At this
point, there's no code to process this command further, but this keeps things
parallel with the keyboard version I'll show next.</p>

<p>What does all this buy us? For starters, we can now (finally) quit the
program using the window manager before the animation runs its course. On my
system, that means clicking the 'X' on the window's title bar. Still, that's
not the same as having a quit key (which I find much more convenient).</p>

<h3>Key Binding</h3>

<p>To add a quit key, I first need to decide <em>which</em> key should quit the
program. I'd choose the Escape key because that makes mnemonic sense to me, but
everyone has their favorite, so I'll allow that to be a configuration setting.
To do this, I extend the configuration hash with a new <code>bind</code>
section:</p>

<pre><code>sub init_conf
{
    my $self = shift;

    $self-&gt;{conf} = {
        title  =&gt; 'Camel 3D',
        width  =&gt; 400,
        height =&gt; 400,
        fovy   =&gt; 90,
        bind   =&gt; {
            escape =&gt; 'quit',
        }
    };
}</code></pre>

<p>Now anyone who wants to choose a different quit key can simply change the
keyboard bindings hash. In fact, several keys could be associated with the same
command, so that either the Escape key or 'q' would exit the program.  The hash
value corresponding to each specified key is the command packet issued when the
user presses that key. This one matches the command packet I'd chosen for the
window manager quit message earlier.</p>

<p>Next, I need to process keypress events, which have the event type
<code>SDL_KEYDOWN</code>. I add another entry to the
<code>event_processor</code> hash:</p>

<pre><code>sub init_event_processing
{
    my $self = shift;

    $self-&gt;{resource}{sdl_event} = SDL::Event-&gt;new;
    $self-&gt;{lookup}{event_processor} = {
        &amp;SDL_QUIT    =&gt; \&amp;process_quit,
        &amp;SDL_KEYDOWN =&gt; \&amp;process_key,
    };
}</code></pre>

<p>and define the key processor as follows:</p>

<pre><code>sub process_key
{
    my $self = shift;

    my $event   = shift;
    my $symbol  = $event-&gt;key_sym;
    my $name    = SDL::GetKeyName($symbol);
    my $command = $self-&gt;{conf}{bind}{$name} || '';

    return $command;
}</code></pre>

<p><code>process_key</code> starts by extracting the key symbol from the SDL
event. Key symbols are rather opaque for our purposes, so I request the key
name matching the extracted key symbol using <code>SDL::GetKeyName</code>. This
produces a friendly key name that I look up in the key bindings hash to find
the appropriate command packet. If there is none, no matter; that key isn't
bound yet so it yields an empty command packet.  <code>process_key</code> then
returns the command packet to add to the queue for further processing.</p>

<h4>Handling Command Packets</h4>

<p>At this point, the code converts a press of the Escape key into a quit
command packet, but <code>do_events</code> ignores that packet because it does
not process the command queue it receives from <code>process_events</code>. To
make something happen, I first need to associate each known command with an
action routine. I create a new lookup hash for this association, initialized in
<code>init_command_actions</code>:</p>

<pre><code>sub init_command_actions
{
    my $self = shift;

    $self-&gt;{lookup}{command_action} = {
        quit      =&gt; \&amp;action_quit,
    };
}</code></pre>

<p>As usual, I call this at the end of <code>init</code>:</p>

<pre><code>$self-&gt;init_command_actions;</code></pre>

<p>It's now time to fill out <code>do_events</code>:</p>

<pre><code>sub do_events
{
    my $self   = shift;

    my $queue  = $self-&gt;process_events;
    my $lookup = $self-&gt;{lookup}{command_action};
    my ($command, $action);

    while (not $self-&gt;{state}{done} and @$queue) {
        $command = shift @$queue;
        $action  = $lookup-&gt;{$command} or next;
        $self-&gt;$action($command);
    }
}</code></pre>

<p>This is similar in form to <code>process_events</code>.  Instead of
processing events from SDL's internal queue to create a queue of command
packets, it processes queued command packets into actions to perform. The loop
starts as usual by checking that the <code>done</code> is not true and that
there are still commands pending in the queue.</p>

<p>Within the loop, it shifts the next command off the front of the queue. The
next line determines the action routine associated with the command. If it
cannot find one, it uses <code>next</code> to skip to the next command.
Otherwise, it calls the action routine as a dynamically chosen method with the
command packet as a parameter. This allows a single action routine to process
several similar commands while still being able to tell the difference between
them. I'll need this later for processing movement keys.</p>

<p>For all of that, <code>action_quit</code> is very simple; it just flags
<code>done</code>:</p>

<pre><code>sub action_quit
{
    my $self = shift;

    $self-&gt;{state}{done} = 1;
}</code></pre>

<p>At this point, the Escape key really will quit the program early, and the
window manager quit still works as well.</p>

<p>Now that the user can quit whenever desired, I can finally remove the
incongruous end of <code>draw_frame</code>. It's no longer necessary to force
the program to end after five seconds, and the dots printed each frame have
outlived their usefulness. The routine now looks like this:</p>

<pre><code>sub draw_frame
{
    my $self = shift;

    $self-&gt;set_projection_3d;
    $self-&gt;set_view_3d;
    $self-&gt;draw_view;
}</code></pre>

<p>Now, if you wait long enough after the objects disappear on the right, the
view rotates all the way around, and the scene appears again on the left. This
version of the routine is much cleaner and incidently closes the next open
refactoring issue (changing engine state within a drawing routine) for
free.</p>













<h3>Controlling the View</h3>

<p>Now that the code can handle keypress events, it's time to control the view
using the keyboard.</p>

<p>Instead of having the view completely recalculated every frame, I'd rather
have each keypress modify the existing view state. To specify the initial
state, I add another initialization routine:</p>

<pre><code>sub init_view
{
    my $self = shift;

    $self-&gt;{world}{view} = {
        position    =&gt; [6, 2, 10],
        orientation =&gt; [0, 0, 1, 0],
        d_yaw       =&gt; 0,
    };
}</code></pre>

<p>The new entry, <code>d_yaw</code>, tells <code>update_view</code> if there
is a pending change (aka delta, hence the leading <code>d_</code>) in facing.
The code so far can only handle yaw (left and right rotation), so that's the
only delta key needed right now.</p>

<p><code>init</code> calls this routine as usual in its new last line:</p>

<pre><code>$self-&gt;init_view;</code></pre>

<p><code>update_view</code> applies the yaw delta to the view orientation, then
zeroes out <code>d_yaw</code> so that it won't continue to affect the rotation
in succeeding frames (without the user pressing the rotation keys again):</p>

<pre><code>sub update_view
{
    my $self   = shift;

    my $view   = $self-&gt;{world}{view};

    $view-&gt;{orientation}[0] += $view-&gt;{d_yaw};
    $view-&gt;{d_yaw}           = 0;
}</code></pre>

<p>A command action assigned to the <code>yaw_left</code> and
<code>yaw_right</code> commands updates <code>d_yaw</code>:</p>

<pre><code>sub init_command_actions
{
    my $self = shift;

    $self-&gt;{lookup}{command_action} = {
        quit      =&gt; \&amp;action_quit,
        yaw_left  =&gt; \&amp;action_move,
        yaw_right =&gt; \&amp;action_move,
    };
}</code></pre>

<p>To assign keys for these commands, I update the <code>bind</code> hash in
<code>init_conf</code>:</p>

<pre><code>bind   =&gt; {
    escape =&gt; 'quit',
    left   =&gt; 'yaw_left',
    right  =&gt; 'yaw_right',
}</code></pre>

<p>The big change is the new command action routine
<code>action_move</code>:</p>

<pre><code>sub action_move
{
    my $self = shift;

    my $command     = shift;
    my $view        = $self-&gt;{world}{view};
    my $speed_yaw   = 10;
    my %move_update = (
        yaw_left  =&gt; [d_yaw =&gt;  $speed_yaw],
        yaw_right =&gt; [d_yaw =&gt; -$speed_yaw],
    );
    my $update = $move_update{$command} or return;

    $view-&gt;{$update-&gt;[0]} += $update-&gt;[1];
}</code></pre>

<p><code>action_move</code> starts by grabbing the command parameter and
current view. It then sets the basic rotation speed, measured in degrees per
key press. Next, the <code>%move_update</code> hash defines the view update
associated with each known command. If it knows the command, it retrieves the
corresponding update. If not, <code>action_move</code> returns.</p>

<p>The last line interprets the update. The view key specified by the first
element of the update array is incremented by the amount specified by the
second element. In other words, receiving a <code>yaw_left</code> command
causes the routine to add <code>$speed_yaw</code> to
<code>$view-&gt;{d_yaw}</code>; a <code>yaw_right</code> command adds
<code>-$speed_yaw</code> to <code>$view-&gt;{d_yaw}</code>, effectively turning
the view the opposite direction.</p>

<p>With these changes in place, the program starts up looking directly at the
scene as it appeared near the beginning of this article. Each press of the left
or right arrow keys turns the view ten degrees in the appropriate direction
(remember that the scene appears to turn the opposite direction around the
view). Holding the keys down does nothing; only a change from unpressed to
pressed does anything, and it only rotates the view one increment. This, as
they say, is suboptimal.</p>

<h4>Angular Velocity</h4>

<p>In order to solve this, the code has to change from working purely in terms
of angular <em>position</em> to working in terms of angular <em>velocity</em>.
Pressing a key should start the view rotating at a constant speed, and it should
stay that way until the key is released.</p>

<p>Velocity goes hand in hand with time. In particular, for each frame,
<code>update_view</code> needs to know how much time has passed since the last
frame to determine the change in angle matching the rotation speed. To compute
this time delta, the first change is to make sure the code always has a valid
world time by initializing it at program start:</p>

<pre><code>sub init_time
{
    my $self             = shift;

    $self-&gt;{world}{time} = now();
}</code></pre>

<p>Of course, this requires another line at the end of <code>init</code>:</p>

<pre><code>$self-&gt;init_time;</code></pre>

<p>With this in place, I can change <code>update_time</code> to record the time
delta for each frame:</p>

<pre><code>sub update_time
{
    my $self = shift;

    my $now  = now();

    $self-&gt;{world}{d_time} = $now - $self-&gt;{world}{time};
    $self-&gt;{world}{time}   = $now;
}</code></pre>

<p>I've made a few changes that shouldn't affect the behavior of the program,
and I'm about to make several more that definitely will change the behavior, so
now is a good time for a quick sanity test. All is fine, so it's time to
contemplate the design for the remaining code.</p>

<h5>Continuing Commands</h5>

<p>There are really two classes of keyboard commands that I want to handle:</p>

<ul>

<li>Single-shots like <code>quit</code>, <code>drop_object</code>, and
<code>pull_pin</code></li>

<li>Continuing commands like <code>yaw_left</code> and
<code>scream_head_off</code></li>

</ul>

<p>To differentiate them, I borrow an existing game convention and use a
leading <code>+</code> to indicate a continuing command. This changes the bind
mapping in <code>init_conf</code>:</p>

<pre><code>bind   =&gt; {
    escape =&gt; 'quit',
    left   =&gt; '+yaw_left',
    right  =&gt; '+yaw_right',
}</code></pre>

<p>and the <code>command_action</code> lookup:</p>

<pre><code>sub init_command_actions
{
    my $self = shift;

    $self-&gt;{lookup}{command_action} = {
          quit       =&gt; \&amp;action_quit,
        '+yaw_left'  =&gt; \&amp;action_move,
        '+yaw_right' =&gt; \&amp;action_move,
    };
}</code></pre>

<p>To process the key release events, I need to assign an event processor for
the <code>SDL_KEYUP</code> event. I'll reuse the existing
<code>process_key</code> routine:</p>

<pre><code>sub init_event_processing
{
    my $self = shift;

    $self-&gt;{resource}{sdl_event} = SDL::Event-&gt;new;
    $self-&gt;{lookup}{event_processor} = {
        &amp;SDL_QUIT    =&gt; \&amp;process_quit,
        &amp;SDL_KEYUP   =&gt; \&amp;process_key,
        &amp;SDL_KEYDOWN =&gt; \&amp;process_key,
    };
}</code></pre>

<p><code>process_key</code> needs some training to be able to differentiate the
two types of events:</p>

<pre><code>sub process_key
{
    my $self    = shift;

    my $event   = shift;
    my $symbol  = $event-&gt;key_sym;
    my $name    = SDL::GetKeyName($symbol);
    my $command = $self-&gt;{conf}{bind}{$name} || '';
    my $down    = $event-&gt;type == SDL_KEYDOWN;

    if ($command =~ /^\+/) {
        return [$command, $down];
    }
    else {
        return $down ? $command : '';
    }
}</code></pre>

<p>The new code (everything after the <code>my $command</code> line) first sets
<code>$down</code> to true if the key is being pressed or to false if the key is
being released. The remaining changes replace the old <code>return
$command</code> line. For continuing commands (those that start with a
<code>+</code>), there's a new class of command packet, containing both the
<code>$command</code> and the <code>$down</code> boolean to indicate whether
the command should begin or end. Single-shot commands (those without a leading
<code>+</code>), send a simple command packet only for keypresses; they ignore
key releases.</p>

<p>To handle the new class of command packets, I update <code>do_events</code>
as well:</p>

<pre><code>sub do_events
{
    my $self   = shift;

    my $queue  = $self-&gt;process_events;
    my $lookup = $self-&gt;{lookup}{command_action};
    my ($command, $action);

    while (not $self-&gt;{state}{done} and @$queue) {
        my @args;
        $command          = shift @$queue;
        ($command, @args) = @$command if ref $command;

        $action = $lookup-&gt;{$command} or next;
        $self-&gt;$action($command, @args);
    }
}</code></pre>

<p>The only new code is inside the loop. It starts off by assuming that the
command packet is a simple one, with no arguments. If the command turns out to
be a reference instead of a string, it unpacks it into a command string and
some arguments. The <code>$action</code> lookup remains unchanged, but the last
line changes slightly to add <code>@args</code> to the parameters of the action
routine. If there are no arguments, this has no effect, so a single-shot action
routine such as <code>action_quit</code> can remain unchanged.</p>

<h5>View, Meet Velocity</h5>

<p>The view needs to keep track of the current yaw velocity and the velocity
delta when the user presses or releases a key; I initialize them to 0 in
<code>init_view</code>:</p>

<pre><code>sub init_view
{
    my $self = shift;

    $self-&gt;{world}{view} = {
        position    =&gt; [6, 2, 10],
        orientation =&gt; [0, 0, 1, 0],
        d_yaw       =&gt; 0,
        v_yaw       =&gt; 0,
        dv_yaw      =&gt; 0,
    };
}</code></pre>

<p><code>update_view</code> needs a few more lines to handle the new
variables:</p>

<pre><code>sub update_view
{
    my $self   = shift;

    my $view   = $self-&gt;{world}{view};
    my $d_time = $self-&gt;{world}{d_time};

    $view-&gt;{orientation}[0] += $view-&gt;{d_yaw};
    $view-&gt;{d_yaw}           = 0;

    $view-&gt;{v_yaw}          += $view-&gt;{dv_yaw};
    $view-&gt;{dv_yaw}          = 0;
    $view-&gt;{orientation}[0] += $view-&gt;{v_yaw} * $d_time;
}</code></pre>

<p>After adding any velocity delta to the current yaw velocity, this method
multiples the total yaw velocity by the time delta for this frame to determine
the change in orientation. This is accumulated with the current orientation and
any other facing change for this frame.</p>

<p>Finally, I update <code>action_move</code> to handle the new semantics:</p>

<pre><code>sub action_move
{
    my $self = shift;

    my ($command, $down) = @_;
    my $sign             = $down ? 1 : -1;
    my $view             = $self-&gt;{world}{view};
    my $speed_yaw        = 36;
    my %move_update      = (
        '+yaw_left'  =&gt; [dv_yaw =&gt;  $speed_yaw],
        '+yaw_right' =&gt; [dv_yaw =&gt; -$speed_yaw],
    );
    my $update = $move_update{$command} or return;

    $view-&gt;{$update-&gt;[0]} += $update-&gt;[1] * $sign;
}</code></pre>

<p>The <code>$sign</code> variable converts the <code>$down</code> parameter
from 1/0 to +1/-1. I changed the last line of the routine to multiply the delta
by this sign before updating the value. Adding a negated value is the same as
subtracting the original value; this means that pressing a key requires adding
the update, and releasing it will subtract it back out.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/911" template="b/article_sidebar.view">
<!-- sidebar ends -->

<p>To make sure the new yaw commands update velocity, I also fixed up the
<code>%move_update</code> hash to update <code>dv_yaw</code> instead of
<code>d_yaw</code> and used the <code>+</code> versions of the command names.
Finally, to bring back the old rotation rate, I set <code>$speed_yaw</code> to
36 degrees per second.</p>

<p>This version responds the way most people expect.  Holding down a key turns
the proper direction until the key is released. What about when the user
presses multiple keys at once? This is why I was careful always to accumulate
updates and deltas by using <code>+=</code> instead of plain old
<code>=</code>. If the user holds both the right and left arrow keys down at
the same time, the view remains motionless because they've added in equal and
opposite values to <code>dv_yaw</code>. If the user releases just one of the
keys, the view rotates in the proper direction for the key that is still held
down because the opposing update has now been subtracted back out.  Press the
released key back down while still holding the other, and the rotation stops
again as expected.</p>

<p>Of course, there's no requirement that the speeds for yawing left and right
must be the same. In fact, for an airplane or spaceship simulation, the game
engine might set these differently to represent damage to the control surfaces
or maneuvering thrusters. It may even be part of the gameplay to hold both
direction keys down at the same time to compensate partially for this damage,
perhaps tapping one key while holding the other steady.</p>

<p>One thing that <em>doesn't</em> magically work is making sure that if
several keys map to the same command, pressing them all won't make the command
take effect several times over. As it stands, the user could map five keys to the
same movement command and move five times as fast. You might try fixing this on
your own as a quick puzzle; I'll try to address it in a later installment.</p>

<h5>Eyes in the Back of Your Head</h5>

<p>You might be curious why I left <code>d_yaw</code> hanging around, since
nothing uses it now. I could use it in the above-mentioned space simulation to
simulate a thruster stuck on--continuously trying to veer the ship off
course. In a first-person game, it allows one of my favorite commands,
<code>+look_behind</code>.  Holding down the appropriate key rotates the view
180 degrees. Releasing the key snaps the view back forward. To implement this,
I need to add another entry to the <code>bind</code> hash:</p>

<pre><code>bind   =&gt; {
    escape =&gt; 'quit',
    left   =&gt; '+yaw_left',
    right  =&gt; '+yaw_right',
    tab    =&gt; '+look_behind',
}</code></pre>

<p>Then another <code>command_action</code> entry:</p>

<pre><code>sub init_command_actions
{
    my $self = shift;

    $self-&gt;{lookup}{command_action} = {
          quit         =&gt; \&amp;action_quit,
        '+yaw_left'    =&gt; \&amp;action_move,
        '+yaw_right'   =&gt; \&amp;action_move,
        '+look_behind' =&gt; \&amp;action_move,
    };
}</code></pre>

<p>Last but not least, another entry in <code>%move_update</code>:</p>

<pre><code>my %move_update      = (
    '+yaw_left'    =&gt; [dv_yaw =&gt;  $speed_yaw],
    '+yaw_right'   =&gt; [dv_yaw =&gt; -$speed_yaw],
    '+look_behind' =&gt; [d_yaw  =&gt;  180       ],
);</code></pre>

<p>That's it: a whopping three lines, all of which were entries in lookup
hashes.</p>

<h3>Conclusion</h3>

<p>That's it for this article; it's already quite long. I started where I left
off in the last article. From there, I talked about translation and rotation of
the view; millisecond resolution SDL time; animation from jerky beginnings to
smooth movement; basic SDL event and keyboard handling; single-shot and
continuing commands; and a whole lot of refactoring.</p>

<p>Next time, I'll talk about moving the <em>position</em> of the viewpoint,
clean up <code>draw_view</code>, and spend some more time on the OpenGL side of
things with the basics of lighting and materials. In the meantime, I've covered
quite a lot in this article, so go forth and experiment!</p>






        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1034" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/22/mod_parrot.html" rel="bookmark">Introducing mod_parrot</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Jeff Horwitz</span> on <abbr class="published" title="2004-12-22T00:00:00-08:00">December 22, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars-->
<!-- sidebar ends -->
<p>It's been almost nine years since the first release of <a
href="http://perl.apache.org/">mod_perl</a>, and it remains a very powerful
tool for writing web applications and extending the capabilities of the Apache
web server. However, lurking around the corner is Perl 6, which gives us not
only a new version of Perl to embed in Apache but an entirely new runtime
engine called <a href="http://www.parrotcode.org/">Parrot</a>.  If there is
ever going to be a Perl 6 version of mod_perl, Apache must first be able to run
Parrot bytecode. This article introduces <a
href="http://www.smashing.org/mod_parrot">mod_parrot</a>, an Apache module that
allows the execution of Parrot bytecode from within the web server. Like
mod_perl, it also gives your code direct access to the Apache API so you can
write your own handlers.</p>

<h3>What is Parrot?</h3>

<p>Parrot is a virtual machine (VM) optimized for dynamic languages like Perl,
Python, PHP, and Ruby. Source code written in each of these languages eventually
compiles down to bytecode (after some optimizations), which subsequently runs
in a virtual machine. Currently, each language runs bytecode with its own VM,
but one of Parrot's goals is to provide a single common VM for all dynamic
languages. This makes implementing a new language much easier because there's
no need to worry about writing a new VM, and this also makes it possible for code in
one language to call code or access data structures from another language.</p>

<!-- sidebar begins -->
 <csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">
<!-- sidebar ends -->

<p>Parrot code comes in three distinct flavors:</p>

<ul>

<li>Bytecode: This is the file format natively interpreted by Parrot.</li>

<li>PASM: Parrot assembler (PASM) is the low-level language that compiles down
to bytecode. It has very simple operations to perform functions such as setting
registers, adding numbers, and printing strings. PASM is very straightforward,
but it operates at such a low level that it can be quite cumbersome.</li>

<li>PIR: Parrot Intermediate Representation (PIR) solves many of the problems
encountered when programming in PASM. It provides more user-friendly and
compiler-friendly constructs and optimizations and feels more like a
traditional high-level programming language.  Parrot eventually breaks down PIR
into PASM before compiling to bytecode (you can even include PASM blocks in
PIR). All of the examples in this article use PIR.</li>

</ul>

<p>For more information on Parrot, including PASM and PIR syntax, visit the <a
href="http://www.parrotcode.org">Parrot website</a>.  It will provide a good
background for understanding the code in this article.</p>

<h3>Why mod_parrot?</h3>

<p>Before discussing the details, you should know a little about mod_parrot's
history.  Ask Bj&ouml;rn Hansen and Robert Spier originally wrote mod_parrot in
2002, later turning it over to Kevin Falcone. This version of mod_parrot
targeted Apache 1.3 and had very limited functionality due to Parrot's
immaturity at the time. In August 2004, with Parrot and its API much more
mature, people suggested that the development on mod_parrot continue. This is where
I picked up the project.  However, instead of picking up where Ask, Robert, and
Kevin left off, I started from scratch, coding for Apache 2 and focusing on
access to the Apache API.</p>

<p>The new mod_parrot project has three primary goals:</p>

<ul>

<li>Provide access to the Apache API through Parrot objects</li>

<li>Provide a common Apache layer for Parrot-based languages</li>

<li>Support for new languages should require little or no C coding</li>.

</ul>

<p>Let's discuss each of these in more detail.</p>

<h4>Provide Access to the Apache API Through Parrot</h4>

<p>Much of mod_perl's power comes from direct access to the Apache API. Rather
than restrict your code to content generation, mod_perl provides hooks for
things such as authentication handlers and output filters and gives you access
to Apache's internal structures, all in Perl. Once you have this functionality,
it is easy to implement other useful features including script caching and
persistent database connections.</p>

<p>mod_parrot shares this approach, providing access to the Apache API from
Parrot. It does this using Parrot objects, mimicking mod_perl's use of
<code>$r</code>.  There will eventually be hooks for all phases of the Apache
lifecycle, though the current version supports only content handlers and
authentication handlers.</p>

<h4>Provide a Common Apache Layer for Parrot-based Languages</h4>

<p>There are several different languages that can run inside Apache today. The
major players here are mod_perl and PHP, but Python, Ruby, and even LISP have
modules embedding them into Apache. Each of these implementations comes with
its own Apache module, which makes sense for languages with different runtime
engines. This is where Parrot changes the landscape dramatically-all languages
targeted to the Parrot VM now have a <em>common</em> runtime engine, so they
need only one Apache module: mod_parrot.</p>

<h4>Support for New Languages Should Require Little or No C Coding</h4>

<p>mod_parrot will provide all of the infrastructure for accessing the Apache
API. The actual Apache module will already be written.  Hooks for calling
Parrot code for each stage of the Apache lifecycle will exist. Parrot objects
will provide access to the Apache API. With all of this already done, and
assuming our language compiles down to Parrot bytecode, we should be able to
write the "glue" between Apache and our language in the language itself.
mod_perl could be written in Perl; mod_python could be written in Python, and
so on. Very little C code, if any, would be necessary. Each language community
could maintain its own language-specific code while sharing the mod_parrot
module.</p>

<h3>Architecture</h3>

<p>mod_parrot is written for Apache 2, with no plans to back-port it to Apache
1.3. The reason behind this decision is to code for the future, not the past or
present; after all, Perl 6 is still a few years down the road. It's also much
easier to write a module for Apache 2 than it is for 1.3! In addition to the
Apache 2 decision, there are several other interesting aspects of the
mod_parrot architecture.</p>

<h4>NCI</h4>

<p>The most significant design decision is the use of NCI (native call
interface) to access the Apache API. mod_perl accesses most of the Apache API
functions through individual XS wrappers (basically a bunch of C macros),
themselves compiled into mod_perl itself or its supporting modules. This is a
tried and true method, used for many Perl modules as well. Now, Parrot gives us
NCI, which eliminates the need for these wrappers, letting you call arbitrary C
functions without having to write any C code. Here's an example of a Parrot
program that calls the C function <code>getpid()</code>, which returns the
current process ID:</p>

<pre><code>.sub _main
    # load libc.so, where getpid() is defined, and assign it to $P0
    $P0 = loadlib '/lib/libc.so.6'

    # find the function in the library and assign it to $P1
    # 'iv' means that getpid() returns an integer and takes no arguments
    $P1 = dlfunc $P0, 'getpid', 'iv'

    # call getpid() and place result in $I0
    $I0 = $P1( )

    # print the PID
    print $I0
    print "\n"
.end</code></pre>

<p>That's it--there is no C code to write, no recompilation, and no relinking.
However, the Apache API functions do not come from a loadable shared library;
they're in the Apache executable, <code>httpd</code>. Fortunately, NCI can run
C functions contained in the running process image, solving that problem. For
more information on NCI, see the <a
href="http://www.parrotcode.org/docs/pdd/pdd16_native_call.html">Parrot NCI
Documentation</a>.</p>

<h4>The Apache::RequestRec Object</h4>

<p>All access to the Apache API goes through Parrot objects.  Because
mod_parrot borrows heavily from mod_perl, it made sense to base the primary
object class in mod_parrot on Apache's <code>request_rec</code> structure. Just
as in mod_perl, the class is <code>Apache::RequestRec</code>. This name is
subject to change, however, as Parrot's namespace nomenclature becomes
clearer.</p>

<p>Every method is written in Parrot, with NCI calls to their corresponding
Apache API functions. For example, here is the Parrot method for the
<code>ap_rputs</code> function (<code>$r-&gt;puts</code> in mod_perl):</p>

<pre><code>.sub puts method, prototyped
    .param string data
    .local pmc r
    .local pmc ap_rputs
    .local int offset

    classoffset offset, self, 'Apache::RequestRec'
    getattribute r, self, offset

    # find NCI object for ap_rputs
    find_global ap_rputs, 'Apache::NCI', 'ap_rputs'

    # use NCI to call out to Apache's ap_rputs
    ap_rputs( data, r )
.end</code></pre>

<p>Currently, <code>Apache::RequestRec</code> is the only class implemented in
mod_parrot. Other classes to support the API will eventually appear, including
classes to support Apache's <code>conn_rec</code> and <code>server_rec</code>
structures.</p>













<h3>Installing mod_parrot</h3>

<p>You can download mod_parrot from the <a
href="http://www.smashing.org/mod_parrot">mod_parrot home page</a>.
Additionally, you'll need the following prerequisites (as of version 0.1):</p>

<ul>
<li>Parrot 0.1.1 (Poicephalus)</li>
<li>Apache 2.0.50 or later</li>
<li>Perl 5.6.0 or later (for configuration only)</li>
<li>Apache::Test 1.13 or later (for the test suite)</li>
</ul>

<p>Once you have all the prerequisite software, run the
<code>Configure.pl</code> script. The arguments to this script will most
certainly change in future releases, but for now, there are only two
arguments:</p>

<ul>

<li><code>--parrot-build-dir=<em>path-to-parrot-source</em></code>, the path to
the top-level Parrot directory</li>

<li><code>--apxs=<em>path-to-apxs</em></code>, the path to Apache's
<code>apxs</code> script, usually found in the <em>bin</em> directory under the
Apache installation directory</li>

</ul>

<pre><code>$ perl Configure.pl --parrot-build-dir=../parrot \
  --apxs=/usr/local/apache2/bin/apxs

Generating Makefile...done.
Creating testing infrastructure...done.

Type 'make' to build mod_parrot.</code></pre>

<p>When configuration completes, type <code>make</code> to build mod_parrot,
then <code>make test</code> to run the tests. To install, become root and type
<code>make install</code>. This will install the mod_parrot module into your
Apache installation and activate the module in <code>httpd.conf</code>.</p>

<h3>Writing a mod_parrot Handler</h3>

<p>While there are currently no languages targeted to Parrot that have the
object support to use mod_parrot (though Parakeet in the Parrot source looks
promising), we can still write Apache handlers. In what language? In Parrot, of
course! Well, actually, PIR. Here's a simple content handler that displays
"Hello World," or if you pass it an query string in the URL, "Hello
<em>name</em>," where <em>name</em> is the string you pass.</p>

<pre><code># this namespace is used to identify the handler
.namespace [ 'HelloWorld' ]

# the actual handler
.sub _handler
    # our Apache::RequestRec object
    .local pmc r

    # this will contain Apache constants
    .local pmc ap_constants

    # instantiate the Apache::RequestRec object
    find_type $I0, 'Apache::RequestRec'
    r = new $I0

    # who should we say hello to?
    $S0 = r.'args'( )
    $I0 = length $S0
    if $I0 &gt; 0 goto say_hello
    $S0 = 'world'

say_hello:
    # call the puts method to send some output
    $S1 = 'Hello ' . $S0
    r.'puts'( $S1 )

    # tell Apache that we're finished with this phase
    find_global ap_constants, 'Apache::Constants', 'ap_constants'
    $I0 = ap_constants['OK']
    .pcc_begin_return
        .return $I0
    .pcc_end_return
.end</code></pre>

<p>If you are at all familiar with mod_perl or the Apache API, this should look
familiar to you, even if you don't know any Parrot.  Let's go through the code
to see how it works. Because this is not an article about Parrot itself, I'll
glaze over the syntax and concentrate on what the code actually does.</p>

<p>The first line of code in the handler declares the namespace in which this
handler exists. In this case, it is <code>HelloWorld</code>. This is important
because namespaces differentiate one handler from another in
<code>httpd.conf</code>.</p>

<p>Next comes the actual handler subroutine, which should always be named
<code>_handler</code>. The first thing the subroutine does is to declare some
locally scoped "variables." These are actually registers in Parrot, but PIR can
abstract them with named variables as it were a higher level language.  And
<code>ap_constants</code>, a hash that will give access to Apache constants
including <code>OK</code> and <code>DECLINED</code>, come next.  Both are PMCs,
or <em>Parrot Magic Cookie</em>, a special data type that implements the more
complex data types of higher-level languages such as Perl or Python.</p>

<p>The code now checks for a query string using the <code>args</code> method of
the <code>Apache::RequestRec</code> object and, if one exists, assigns it to
the temporary string register <code>$S0</code>. If there is no query string,
<code>$S0</code> will contain <code>world</code>. Next, the code creates the
output string, instantiates the <code>Apache::RequestRec</code> object, and
calls the <code>puts</code> method to output "Hello World" or "Hello
<em>name</em>". By default, the content type is <code>text/html</code>, so
there's no need to set it here.</p>

<p>This is the end of the handler, so it's time to tell Apache that we're done
and that it no longer needs to handle this phase of the request.  This requires
returning the Apache constant <code>OK</code> from the
<code>ap_constants</code> hash in the <code>Apache::Constants</code>
namespace.</p>

<p>To compile the handler into Parrot bytecode, save it in a file with a
<em>.imc</em> extension (IMC is short for Intermediate Compiler). Then, compile
it into Parrot bytecode (PBC) as follows (this step will be automatic in a
future release):</p>

<pre><code>$ parrot -o HelloWorld.pbc HelloWorld.imc</code></pre>

<h3>Configuring Apache to Use A Handler</h3>

<p>Writing the handler was the hard part. Configuring Apache to use it is easy.
The first thing to do is to initialize mod_parrot and load some bytecode
libraries:</p>

<pre><code># mod_parrot initialization
ParrotInit /path/to/lib/ModParrot/init.pbc
ParrotLoad /path/to/lib/Apache/RequestRec.pbc
ParrotLoad /path/to/lib/Apache/Constants.pbc

# our handler
ParrotLoad /path/to/HelloWorld.pbc</code></pre>

<p><code>ParrotInit</code> tells mod_parrot where to find its initialization
bytecode. A future release will probably handle this automatically, but for now
explicitly set the path in <code>httpd.conf</code>.  <code>ParrotLoad</code>
tells mod_parrot to load a bytecode file. In this case, it loads the code that
implements the <code>Apache::RequestRec</code> object and the constants hash,
as well as the bytecode for the new handler.</p>

<p>Next, Apache needs a location for the handler to, well, handle.  How about
the location <code>/hello</code>:</p>

<pre><code>&lt;Location /hello&gt;
    SetHandler parrot-code
    ParrotHandler HelloWorld
&lt;/Location&gt;</code></pre>

<p>First, this sets the Apache handler for the location to
<code>parrot-code</code>. This is the official name of the mod_parrot handler.
Then it sets the actual Parrot handler, which, as discussed in the previous
section, is the namespace of the handler subroutine, <code>HelloWorld</code>.
That's it. Save the configuration, restart Apache, point your browser to
<code>http://yourserver/hello</code> (replacing <code>yourserver</code> with
the name of your server), and you should see the "Hello World" message. Add a
query string to see the output change: <code>http://yourserver/hello?Joe</code>
should produce "Hello Joe."</p>

<h3>Writing an Authentication Handler</h3>

<p>Apache handlers do more than just generate content, of course, and this
applies to mod_parrot as well. Here's an example of using an authentication
handler to protect a private directory. It will use the HTTP basic
authentication scheme, but instead of using a standard password file, it will
accept any username as long as the password is "squawk." Here's the handler PIR
code:</p>

<pre><code># this namespace is used to identify the handler
.namespace [ 'TestAuthHandler']

# the actual handler
.sub _handler
    # our Apache::RequestRec object
    .local pmc r
    .local string pw
    .local int status

    # this will contain Apache constants
    .local pmc ap_constants
    find_global ap_constants, 'Apache::Constants', 'ap_constants'

    # instantiate the Apache::RequestRec object
    find_type $I0, 'Apache::RequestRec'
    r = new $I0

    # check the password, ignoring the username
    (status, pw) = r.'get_basic_auth_pw'( )
    if pw != 'squawk' goto auth_failure
    $I0 = ap_constants['OK']
    goto auth_return_status

# authentication failed
auth_failure:
    $I0 = ap_constants['HTTP_UNAUTHORIZED']
    goto auth_return_status

# return our status code
auth_return_status:
    .pcc_begin_return
        .return $I0
    .pcc_end_return
.end</code></pre>

<p>Here is the corresponding configuration in <code>httpd.conf</code>.  Instead
of using <code>SetHandler</code> and <code>ParrotHandler</code> here, set
<code>ParrotAuthenHandler</code> to the namespace of the authentication
handler:</p>

<pre><code>&lt;Directory /usr/local/apache/htdocs/private&gt;
	ParrotAuthenHandler TestAuthHandler
	AuthType Basic
	AuthName Private
	Require valid-user
&lt;/Directory&gt;</code></pre>

<h3>Remembering Why We're Here</h3>

<p>Note the low-level nature of the two handlers. There are no else clauses;
goto statements appear throughout the subroutine; and return values must be
assigned to registers before being used in another operation. You can plainly
see that this is only one step above writing assembly here, but remember that
you won't have to worry about writing code at this level--you'll write in a
high-level language such as Perl 6, and it will eventually compile down to
Parrot assembler. Looking forward, the corresponding Perl 6 code for the
<code>HelloWorld</code> handler might look a lot like this (as with all things
Perl 6, this is subject to change):</p>

<pre><code>use Apache::Constants ':common';
use Apache::RequestRec;

sub handler(Apache::RequestRec $r)
{
    my ($status, $pw) = $r.get_basic_auth_pw();
    return ($pw eq 'squawk') ? OK : HTTP_UNAUTHORIZED;
}</code></pre>

<h3>Future Directions</h3>

<p>mod_parrot is still in its infancy. It's quite functional, but there is
still a lot of work to do before it can power any serious applications. At this
point in development, the primary goal is to finish hooking into all phases of
the Apache request lifecycle, including support for the relevant Apache API
functions.  Windows support will also become a priority as mod_parrot becomes
more functional.</p>

<p>You may also wonder about CGI scripts. As of this writing, there is no
support for running CGI scripts in mod_parrot. mod_perl has
<code>Apache::Registry</code> to help CGI scripts run in a persistent
environment, and mod_parrot will need a similar infrastructure.</p>

<p>However, the real fun will begin when we have a high level language that we
can use to write handlers. If the timelines work out as I hope they will,
mod_parrot will be fully functional before the formal release of Perl 6 or any
other mainstream Parrot-based language. Because the Apache/Parrot layer will
have already been written, this will save quite a bit of development time for
mod_perl, PHP, and other similar projects.</p>

<p>If you'd like to read more about mod_parrot, or would like to help with the
project, visit the <a href="http://www.smashing.org/mod_parrot">mod_parrot home
page</a>.</p>





        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1032" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/16/import_kata.html" rel="bookmark">Perl Code Kata: Testing Imports</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author"><a class="fn url" href="http://www.modernperlbooks.com/">chromatic</a></span> on <abbr class="published" title="2004-12-16T00:00:00-08:00">December 16, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p><a href="/pub/a/2004/10/21/taint_testing_kata.html">Perl
Taint Test Kata</a> introduced the idea of Perl Test Kata, small exercises
designed to improve your understanding of Perl and your ability to write
test-driven code. This article is the second in the series.</p>

<h3>Import Testing Kata</h3>

<p>Perl 5 added the ideas of namespaces and modules, making code reusable
and easier to maintain. To allow convenience, it also added an importing
mechanism to put code from a module into the current namespace.</p>

<p>Behind the scenes, when you <code>use</code> a module, Perl loads it
from disk and, if successful, calls the special method
<code>import()</code>. By convention, this generally imports functions.
Much of the time, <code>import()</code> mundanely installs subroutines into
the current namespace. That's why so many modules use Exporter to provide a
default <code>import()</code>.</p>

<p>However, it's also a general module-loading hook that can perform many
different types of manipulations. For example, <a
href="http://search.cpan.org/dist/Filter-Simple">Filter::Simple</a> allows the
use of source filters to transform code that looks entirely unlike Perl into
valid code in the using module. Other modules change their behavior depending
on any arguments passed to <code>import()</code>. This includes <a
href="http://search.cpan.org/dist/Test-More">Test::More</a> and <a
href="http://search.cpan.org/dist/Test-Simple">Test::Simple</a>, which interpret
their arguments as information about how many tests to run.</p>

<pre><code>use Test::More 'no_plan';

# or

use Test::More tests =&gt; 100;</code></pre>

<p>This feature is both powerful and important. Because of its importance,
it needs good tests. Because of its power and flexibility, it may seem
difficult to test an <code>import()</code> well. Here are three sample
implementations for you to practice testing.</p>

<h4>Basic Exporting</h4>

<pre><code>package Basic::Exports;

use strict;

use base 'Exporter';
use vars '@EXPORT';

@EXPORT = qw( foo bar );

sub foo { 'foo' }
sub bar { 'bar' }

1;</code></pre>

<p>The tests should check that using Basic::Exports exports <code>foo()</code>
and <code>bar()</code> to the appropriate namespace and that they return the
appropriate values. Another test is that the code <code>use Basic::Exports
();</code> exports <em>neither</em> function.</p>

<h4>Optional Exports</h4>

<pre><code>package Optional::Exports;

use strict;

use base 'Exporter';
use vars '@EXPORT_OK';

@EXPORT_OK = qw( foo bar baz );

sub foo { 'foo' }
sub bar { 'bar' }
sub baz { 'baz' }

1;</code></pre>

<p>The tests should check that Optional::Exports exports nothing by default
and only those functions named, if there are any.</p>

<h4>Load-time Behavior</h4>

<p>A few modules have curious behavior. My Pod::ToDemo behaves differently
when invoked from the command line versus when used within a module. This
makes it substantially more difficult to test. Rather than make you
reinvent the tests there, here's a simpler custom <code>import()</code>
that does different things based on its invocation. If invoked from the
command line, it prints a message to standard output. If used from a
module, it exports the same <code>foo()</code> subroutine as before.</p>

<pre><code>package Export::Weird;

use strict;

sub import
{
    my ($package, undef, $line) = caller();

    if ( $line == 0 )
    {
        print &quot;Invoked from command-line\n&quot;;
    }
    else
    {
        no strict 'refs';
        *{ $package . '::foo' } = sub { 'foo' };
    }
}

1;</code></pre>

<p>The only really tricky test here must exercise the behavior of the
module when invoked from the command line. Assume that the documentation of
the module suggests invoking it via:</p>

<pre><code>$ <strong>perl -MExport::Weird -e 1</strong></code></pre>

<p>The next page explains some techniques for testing these examples. For
best results, spend between 30 and 45 minutes working through the kata on
your own before looking at the hints. For more information on how modules,
<code>use</code>, and <code>require</code> work, see <code>perldoc
perlmod</code> and <code>perldoc perlfunc</code>.</p>













<h3>Tips, Tricks, and Suggestions</h3>

<p>If you've worked your way through writing tests for the three examples,
here are the approaches I would take. They're not the only ways to test
these examples, but they do work. First, here is some background
information on what's happening.</p>

<h4>Reloading</h4>

<p>To test <code>import()</code> properly, you must understand its
implications. When Perl encounters a <code>use <em>module</em>;</code>
statement, it executes a two-step process <em>immediately</em>:</p>

<pre><code>BEGIN
{
    require module;
    module-&gt;import();
}</code></pre>

<p>You can subvert both of these processes. To force Perl to reload a
module, you can delete its entry from <code>%INC</code>. Note that all of
the keys of this special hash represent pathnames in Unix format. For
example, even if you use Windows or VMS or Mac OS 9 or earlier, loading
Filter::Simple successfully should result in <code>%INC</code> containing a
true value for the key of <code>Filter/Simple.pm</code>. (You may also want
to use the <code>delete_package()</code> function of the Symbol module to
clear out the namespace, though beware of the caveats there.) Now you can
<code>require</code> the module again.</p>

<h4>Re-importing</h4>

<p>Next, you'll have to call <code>import()</code> manually. It's a normal
class method call, however, so you can provide all of the arguments as you
would to a function or method call.</p>

<p>You can also switch packages, though make sure that you qualify any
calls to Test::* module functions appropriately:</p>

<pre><code>package Some::Other::Package;

module-&gt;import( @args );

main::ok( 1, 'some test label' );

# or 

::ok( 1, 'some test label' );</code></pre>

<h4>Testing Exports</h4>

<p>There are at least two techniques for checking the import of functions.
One is the use of the <code>defined</code> keyword and the other is through
the <code>can()</code> class method. For example, tests for Example #1
might be:</p>

<pre><code>use_ok( 'Basic::Exports' );
ok( defined &amp;foo,              'module should export foo()' )
ok( __PACKAGE__-&gt;can( 'bar' ), '... and should export bar()' );</code></pre>

<p>To test that these are the right functions, call them as normal and
check their return values.</p>

<p>By the way, the presence of the <code>__PACKAGE__</code> symbol there
allows this test to take place in other namespaces. If you haven't imported
the <code>ok()</code> test function into this namespace, remember to
qualify it, import it manually, or alias it so that the test program will
itself run. (It may fail, which is fine, but errors in your tests are
difficult and embarrassing to fix.)</p>

<h4>Testing Non-Exports</h4>

<p>It's difficult to prove a negative conclusively, but if you reverse the
condition of a test, you can have good confidence that the module hasn't
provided anything unwanted.</p>

<pre><code>use_ok( 'Optional::Exports' );
ok( ! __PACKAGE__-&gt;can( 'foo' ),
    'module should not export foo() by default' );</code></pre>

<p>The only tricky part of the tests here is in trying to import functions
again. Call <code>import()</code> explicitly as a class method of the
module. Switching packages within the test can make this easier; you don't
have to unload the module if you do this.</p>

<h4>Testing Weird Exports</h4>

<p>The easist way to test an <code>import()</code> function that relies on
command-line invocation or produces weird side effects that you may not want to
handle in your current program is to launch it as a separate program. There are
plenty of options for this, from <code>system</code> to <code>fork</code> and
<code>exec</code> to tricks with pipes and shell redirection. <a
href="http://search.cpan.org/dist/IPC-Open3">IPC::Open3</a> is one good
approach, if you want to use it in your test suite:</p>

<pre><code>#! perl

use strict;
use warnings;

use blib;
use IPC::Open3;

use Test::More tests =&gt; 3;

use_ok( 'Export::Weird' );

my $pid = open3(
    undef, my $reader, undef,
    $^X, '-Mblib', '-MExport::Weird', '-e', '1'
);

my @out = &lt;$reader&gt;;
is( @out,                                1,
    'cli invocation should print one line' );
is( $out[0], &quot;Invoked from command-line\n&quot;,
    '... with the right message' );</code></pre>

<p><code>$^X</code> represents the path to the Perl binary currently
executing this program. The <code>-Mblib</code> switch loads the
<code>blib</code> module to set <code>@INC</code> in the program
appropriately. Depending on how you've set up your directories and invoke
this program, you may have to change this. The other commands follow the
invocation scheme given in Example #3.</p>

<h3>Conclusion</h3>

<p>You should now have several ideas on how to test <code>import()</code>
methods of various kinds. For more details, read the tests of <a
href="http://search.cpan.org/dist/Pod-ToDemo">Pod::ToDemo</a> or <a
href="http://search.cpan.org/dist/Test-Builder">Test::Builder</a>, which play
strange games to achieve good test coverage.</p>

<p>If you've found a differently workable approach, I'd like to hear from you.
Also, if you have suggestions for another kata (or would like to write one),
please let me know.</p>

<csperl file="grab" domain="on" record="b/936" template="b/article_sidebar2.view">

<p><em>chromatic is the author of <a href="http://onyxneon.com/books/modern_perl/">Modern Perl</a>. In his spare time, he has been working on <a href="https://trendshare.org/how-to-invest/">helping novices understand stocks and investing</a>.</em></p>
        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1040" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/p6pdigest/20041209.html" rel="bookmark">This Fortnight in Perl 6, December 1 - 6 2004</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2004-12-09T00:00:00-08:00">December  9, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>All~</p>

<p>Last week I asked for help identifying the source of a quotation. One
friendly soul suggested Alan J. Perlis, but could not find an actual
attribution. It did lead me to find a very applicable (and in my mind funny)
quote from Perlis, which I will now inflict upon you all, before your regularly
scheduled summary:</p>

<blockquote>When someone says "I want a programming language in which I need only say
what I wish done," give him a lollipop. -- Alan J. Perlis</blockquote>

<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/b0aad9939bb2367a/1f29abcbe56bfbfe?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#1f29abcbe56bfbfe"><code>qq:i</code></a></h4>

<p>Jim Cromie wondered if there could be a <code>qq:i</code> which sometimes
interpolates and sometimes doesn't depending on whether the variable had been
previously defined. There was some discussion which led to the conclusion that
this was just asking for strange bugs.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/bdf375ee76730b63/5a9e80e5952d2d10?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#5a9e80e5952d2d10">Getters
and Setters</a></h4>

<p>John Siracusa wanted to know if Perl 6 would allow one to expose a member
variable to the outside world, but then later intercept assignments to it
without actually having to switch to using getters and setters in all of the
code that uses the variable. The answer: yes, yes you can.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/01d83e4f7124a967/fbcc955466c79c95?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#fbcc955466c79c95"><code>&lt;&lt;
foo &gt;&gt;</code></a></h4>

<csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">

<p>Richard Proctor asked if he could do <code>&lt;&lt;list of
words&gt;&gt;</code>. Juerd pointed out that someone had already asked this.
Which brings us to the fine point, ask not Larry for he will tell you both yes
and no. Although in this case I think he said "probably"...</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/d099f2399629373a/e35a284b1e68a454?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#e35a284b1e68a454">Flipflop
Operator</a></h4>

<p>Juerd wondered about the fate of the flipflop. Larry explained that while it
had lost the election it was still going to work hard for you in the Senate.
Err, that's not quite right, he said that "It's leaving syntactically but not
semantically.", but he hasn't specified the new syntax...</p> 

<h4><a href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/4f047f2247f84647/5341da569ccf67dd?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#5341da569ccf67dd"><code>Temp $var</code></a></h4>

<p>Alexey Trofimenko wanted to know whether <code>temp</code> would
preserve or destroy its old value. Larry is leaning toward the Perl 5
semantics of destroying, I think.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/878c8f7ddc47f6fd/b2febbdc269ea8e6?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#b2febbdc269ea8e6"><code>State</code>
vs. <code>My</code></a></h4>

<p>Alexey Trofimenko wondered how much advice about optimizing Ruby also
applied to Perl. Unfortunately, he also misunderstood the <code>state</code>
specifier. The topic then quickly veered into what exactly <code>state</code>
does.</p>

<h4><a
href=http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/0a68ecc0a9b5813b/6cceddfaac9b6a23?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%6&amp;_doneTitle=Back&amp;&amp;d#6cceddfaac9b6a23">Specifying
a Hash's Key Type</a></h4>

<p>Abhijit Mahabal wanted to know if he could specify a hash's key type.  The
answer is yes, but the exact syntax seems to be worth a discussion.  Luke
Palmer, in his Mathematician's rage, attempted to shoot down any usage of
Domain and Range, as they really should be Domain and Codomain.</p>

<p><a href="http://en.wikipedia.org/wiki/Range_%28mathematics%29">Wikipedia:
range Range (Mathematics)</a></p> 

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/5795b160190bea66/975ca916a337f524?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#975ca916a337f524">Container
Methods</a></h4>

<p>Ashley Winters wants to have syntax for calling a method on the container
object rather than the containee. Luke Palmer agreed that this was problematic.
Larry appears to be in no hurry to add more operators for this one, yet.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/e831fbff7f4853f8/1e7c0a77327dbf88?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#1e7c0a77327dbf88">Slight
Discrepancy Between Synopses</a></h4>

<p>St&eacute;phane Payrard pointed out a small issue in some Synopses. Larry
replied "oops".</p>

<h4>Arrays, Lists, Iterators, Functions, Co-routines, Syntax</h4>

<p>Many people suggested many things about the best thing to replace the now
missing <code>&lt;&gt;</code> op. I think Larry is leaning toward adding an
undare <code>=</code> op, which would do cool things. I don't thing anything is
final yet.</p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/cbb53159bcaed4a7/1169615c9bfdc0e2?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#1169615c9bfdc0e2">Iterators
as Functions</a></p>

<p><a
href=http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/257b8e0bbed541a8/93e0c356ddf3afcd?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#93e0c356ddf3afcd">Unary
<code>=</code> Talk</a></p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/257b8e0bbed541a8/93e0c356ddf3afcd?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#93e0c356ddf3afcd">Push/Pop/Pull/Monkey</a></h4>

<p>Many folk voiced their dislike of shift and unshift. I must agree with them,
but they also suggested a great many alternatives, including pull/put,
get/unget, and even getting rid of push/pop. I must say that I really dislike
that last idea. Fortunately I am not alone. Currently we are waiting for
inspiration to strike.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/257b8e0bbed541a8/93e0c356ddf3afcd?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#93e0c356ddf3afcd">Topicalization</a></h4>

<p>Someone noticed that <code>for</code> might override one's topic at
undesired times. Larry ruminated about ways to solve this.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/257b8e0bbed541a8/93e0c356ddf3afcd?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fgvc%3D2%26&amp;_doneTitle=Back&amp;&amp;d#93e0c356ddf3afcd">Required
Whitespace</a></h4>

<p>Rod Adams does not like inconsistent whitespace rules. Larry explained why
the existing rules really were consistent.</p>

<h3>Perl 6 Compilers</h3>

<p>The lack of traffic on p6c has given me another space to abuse. You should
listen to "Soul Coughing." If you would like to join in the fun of abusing p6c,
you should submit tests. Nothing is more abusive then stress testing. ;-)</p>

<h3>Parrot</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ab18b616e2a89b3b/6bedca9a038ed1d9?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#6bedca9a038ed1d9">Tuning
and Monitoring</a></h4>

<p>Matt S asked how much support Parrot has for tuning and monitoring. This
week I exercise the awesome powers of the summarizer and invoke the mighty
Warnock's Dilemma.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e6020b8ffabbad88/028cfc120dffd3a1?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#028cfc120dffd3a1"><code>IMCC Globals</code></a></h4>

<p>Leo removed some IMCC globals. Nice work.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a69db424446d8783/b7e77e4177a5e0b7?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#b7e77e4177a5e0b7">Ensure
Directories Exist First</a></h4>

<p>Andy Dougherty fixed a problem with writing a file in a non-existent
directory. Leo applied the patch.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7b48bde181d11a1a/5805eb2e5eb0bb02?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#5805eb2e5eb0bb02">Namespace-sub
Invocation</a></h4>

<p>Last week Luke Palmer wanted to know about calling subs in namespaces. I
posted Leo's answer, but Dan does not like it. It should be a two-step process:
first fetch, then invoke.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/9f4ab6159579062e/34d31c62a32b54be?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#34d31c62a32b54be">What
Is an opcode? </a></h4>

<p>Thomas Seiler attempted to clear up some perceived confusion about what
exactly an "opcode" is. No responses...</p>

<h4>Lexicals, Continuations, and Register Allocations</h4>

<p>Dan voiced a final word in this long-lived and lively thread, which kicked
off several children. Return Continuations (even once-promoted) restore their
registers.</p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3a61fe5e97d17389/0603ff13ca52f0ff?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#0603ff13ca52f0ff">Dan's
Ruling</a></p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/214157bf29879710/4c15aa4a1f56c20a?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#4c15aa4a1f56c20a">The
Long and Lively Thread</a></p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/092577189995ee1d/f22bdbb497de3975?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#f22bdbb497de3975">Keyword
Arguments</a></h4>

<p>Sam Ruby wondered how he ought to handle keyword arguments to functions.  Dan
admitted that this is complex, and outlined the cheat he has been contemplating.
No one has either commented on or implemented it yet.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/168d0efbd0cfc1f4/b594c3a38848d19a?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#b594c3a38848d19a">What
Is and Isn't Up for Grabs</a></h4>

<p>Dan attempted to lay out clear rules as to what things he would entertain
until Parrot was functionally complete. Let's hope it sticks.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/bea07c6bee8717aa/8a916b80e4dc4c20?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#8a916b80e4dc4c20">AST
+ COMPILE_IMMEDIATE == :-(</a></h4>

<p>Bernhard Schmalhofer provided a patch to fix some of the :-(. Leo applied
it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/5b28ae722a86bc80/bc5bad4a9a843190?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#bc5bad4a9a843190"><em>t/dynclass/pybuiltin.t</em>
Fails</a></h4>

<p>Will added a BUG to RT for this.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/59b554e4cd6200ca/6e273b614f34004a?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#6e273b614f34004a">Benchmark
Tests</a></h4>

<p>Justin DeVuyst submitted a patch, which fell through the cracks, to make the
benchmarks also be tests. Fortunately Matt Diephouse rescued it from the
cracks and Leo applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a549937c1d815228/64547f8c695af32e?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#64547f8c695af32e">Too
Many opcodes</a></h4>

<p>Leo voiced his opinion that there were too many opcodes and suggested a
scheme for cutting down on them. Dan corrected him that there were not too
many. Despite this surface disagreement, however, Dan addressed the spirit of
Leo's complaint. Thus, they can both be happy.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/98345a122be7a9e2/1bf9ebeca3e9fe3f?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#1bf9ebeca3e9fe3f">C89
Issues</a></h4>

<p>There was a little confusion about whether variable declarations
could follow code in C89. The answer is not.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/acb11073ce7d12c2/b79d4f2f7409bbde?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#b79d4f2f7409bbde">perlhash
<code>iter</code> busted</a></h4>

<p>Sam Ruby noticed that the perlhash <code>iter</code> did not work and
submitted a test case for it. Leo fixed it (and presumably applied the
test).</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/355b38da2a067793/4aec9b7ad3ac3aae?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#4aec9b7ad3ac3aae">Warnings
Cleanup</a></h4>

<p>Garrett Rooney submitted a patch to fix some warnings. Leo applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/eb26d8206c8346d4/a59e8326a855b612?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#a59e8326a855b612">Objects,
Classes, Metaclasses, and MMD Dispatch</a></h4>

<p>Dan's attempt to spec out objects from last week led to some discussion of
MMD. Leo suggested an implementation. Silence reigned.</p>

<p><a
href=http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ebe0bd5533aa3655/2c13224380f7b64b?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Bak+to+topics&amp;_doneTitle=Back&amp;&amp;d#2c13224380f7b64b">More
MMD Stuff</a></p>

<h4><a
href=http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/98c099993a0ef979/873d4926bf1d80ef?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Bak+to+topics&amp;_doneTitle=Back&amp;&amp;d#873d4926bf1d80ef">More
Tcl Stuff</a></h4>

<p>Will added more new stuff to Tcl. Yay, Will!</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7ebda933279848a8/9504b2207764af73?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#9504b2207764af73">Internal
Exception Clean Up</a></h4>

<p>James deBoer submitted a patch that cleans up internal exception output.
Later he submitted a second, better version of the patch. Warnock applies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/55da497e90c63c16/05d1c7ecf5d40021?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#05d1c7ecf5d40021">Dynamic
Evaluation of PAST</a></h4>

<p>Bernhard Schmalhofer submitted a patch to add support for PAST dynamic
evaluation. Leo applied it.</p>

<h4>Inline Caching</h4>

<p>Leo explained inline caches and why 19 out of 20 calls like them. This led
to his suggesting that some of the opcodes we have that take offsets from
strings are a premature optimization. This led to some discussion about whether what he suggested was in Dan's earlier mandate.</p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/11bf7f5b99611372/a4b461185a77d149?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#a4b461185a77d149">Inline
Caching</a></p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thre
ad/824cae85acf178d8/ce8deb56f8b293b4?_done=%2Fgroup%2Fperl.perl6.internals%
3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#ce8deb56f8b293b4">Leo's
Suggestion</a></p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/9df1f9c203964ebd/881f8aef14e5bd29?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#881f8aef14e5bd29"><code>help</code>
Target in Make</a></h4>

<p>Bernhard Schmalhofer (whose name makes me very thankful for copy and paste)
submitted a patch adding a new <code>help</code> target to
<em>parrot/docs/Makefile</em>.  Will appied it.</p>

<h4>Parrot and Strong Types</h4>

<p>Cameron Zemek asked about supporting strongly typed languages on Parrot.  I
confused strong-typing and static-typing, but fortunately Dan came to the
rescue with a good explanation. During the course of this thread, people
suggested both Haskell and Prolog on Parrot. I like them both, a lot.</p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/77b5a3793a41a73c/1b4029708201449c?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#1b4029708201449c">
Original Message</a></p>

<p><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/77b5a3793a41a73c/1b4029708201449c?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#1b4029708201449c">Dan
to the Rescue</a></p>

<h4><a
href=http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/40960c8b3e7d3f48/428b477f8cfdc896?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Bak+to+topics&amp;_doneTitle=Back&amp;&amp;d#428b477f8cfdc896">Move
<em>libnci.def</em> Out of Root Directory</a></h4>

<p>Mitchell ::mumble:: provided a patch to do the above some time ago. Will
rescued it and asked for a ruling. The ruling is that it should apply. I don't
know if anyone DID apply it, but someone should.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e668cb261aade149/e04b3c73c582e4f4?_done=%2Fgroup%2Fperl.perl6.internals%3F&amp;_doneTitle=Back+to+topics&amp;_doneTitle=Back&amp;&amp;d#e04b3c73c582e4f4">Tru64
<code>cc</code>/<code>ld</code> Issues</a></h4>

<p>Jarkko Hietaniemi posted a problem with building on Tru64. Sam Ruby
committed it.</p>

<h3>The Usual Footer</h3>

<p>If you find these summaries useful or enjoyable, please consider
contributing to the Perl Foundation to help support the development of Perl.
You might also like to send feedback to <a
href="mailto:ubermatt@gmail.com">ubermatt@gmail.com</a>.</p>

<ul> 

<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>

</ul>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1030" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/09/epayment.html" rel="bookmark">The Evolution of ePayment Services at UB</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Jim Brandt</span> on <abbr class="published" title="2004-12-09T00:00:00-08:00">December  9, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->

<p>In the summer of 2001, the State University of New York at Buffalo (UB) hired a new
Provost. She surveyed various school services and came up with a short list of
must-do projects. Given the level of competition in higher education, it's no
surprise that she felt that we must be able to accept payments over the
internet. In general, we try to make it as easy as possible for students and
their parents to manage the business side of their education. Electronic
payment is a key, new component of that.</p>

<h3>How to Start?</h3>

<p>Determining how to accept an electronic payment requires skills from a wide
variety of groups on campus. So we first put together a committee with
representatives from Accounting, Student Accounts, and some offices that wanted
to accept electronic payments. My department, Administrative Computing
Services, also sat on the committee since we would have to implement the actual
technology. Our role was to work with the people who handled the manual payment
system and figure out how to automate that system through the web.</p>

<p>We had no experience taking money over the internet, so we looked at our
options:</p>
<csperl file="grab" domain="on" record="b/936" template="b/article_sidebar.view">
<ul>

<li><p><em>Purchase a fully outsourced solution.</em></p>

<p>We evaluated many all-in-one systems, but most didn't do exactly what we
wanted. The biggest problem was integration with our existing system, which had
grown over time and had many legacy components. Many vendors had systems that
worked only with their complete accounting systems.</p></li>

<li><p><em>Partially outsourced solution.</em></p>

<p>With this approach, we would do some work on our end and offload some to a
vendor. This ended up being our initial approach since it allowed us to write
the custom parts to interface with our systems, but still outsource the
financial parts to reduce our initial risk.</p></li>

<li><p><em>Mostly custom solution with payment processing outsourced.</em></p>

<p>With this configuration, we'd host all of the web components in-house. We
would use an external vendor for the payment-processing components, including
validating credit cards, encumbering the funds from cards, and processing the
actual payments through the payment networks and banks.</p></li>

<li><p><em>Complete in-house system.</em></p>

<p>Some companies actually act as their own payment processor in addition to
running the front-end website components. There is nothing preventing you from
processing your own payments, but we found the banking world incredibly
complex, especially with regard to credit card transactions.  Although we could
theoretically save money by doing this work ourselves, we weren't <I>interested</I> in
doing this work.  Our Accounting department agreed.</p></li>

</ul>

<p>After evaluating the options, we chose to start with a partially outsourced
solution. Over time our needs changed and we became more knowledgeable; we since made the transition to a mostly in-house solution.</p>

<h3>Initial Solution: Partial Outsourcing</h3>

<p>Our initial solution was mostly outsourced, with us building just a few
front-end components. This allowed us to get our feet wet with electronic
payment without running everything. Even with a vendor doing most of the work,
we encountered some challenges.</p>

<p>To implement this model, we built a website with a few pages that would
collect personal data and track some data on the transaction. On the final page
of our site, the user clicked a submit button and we shipped them off to the
vendor website to enter the credit card information. This way we didn't
directly deal with any credit card issues. Each night we would receive a
remittance file with the day's transactions and we would reconcile these with
our data using a unique identifier.</p>

<p>The key issues for this first phase were:</p>

<ol>

<li>Purchase and install a certificate from a widely accepted certificate
issuer.</li>

<li>Make sure all users used SSL. We simply redirected all http requests to the
site to https so users couldn't accidentally use unencrypted connections.</li>

<li>Accurately record a unique identifier to match up transactions when we
received the remittance file from the vendor.</li>

<li>Follow the vendor's protocol to integrate properly with their site.</li>

<li>Understand the payment-processing system so we could date and post
transactions accurately in our batch jobs.</li>

</ol>

<p>The first two were basically normal tasks for setting up a secure server.
The third required a little work, but not much. The challenge was integrating
with the vendor. They had limits on the size of a unique identifier that were
smaller than we wanted to provide, so we needed to shorten the value we sent.
We also had concerns with how we would track down any "orphan" payments in the
payment system that we couldn't track to a particular user. We were lucky that,
in practice, this never occurred.</p>

<p>Number four also presented a challenge. My department is largely a Perl shop
and we didn't use Java on our website. During the development process, we
discovered that the vendor link required Java to encrypt the data we sent to
their system. They used Cryptix PGP with some custom code, available in Java
only. That summer at OSCON I learned about the Inline modules and I decided to
try one. Since it was only one small Java component, I followed their examples
to code the Java encryption subroutine and stuck it at the bottom of the final
Perl submission script using <a
href="http://search.cpan.org/dist/Inline-Java"><code>Inline::Java</code></a>.</p>

<p>We have since moved on to a different system for processing our payments, so
this code is a bit dated. However, when we were using it, it looked something
like this:</p>

<pre><code>my $encrypt = new encrypt();

# We had several calls like this one, one for each parameter we
# needed to encrypt.
# Each call returned a string with the encrypted data.
my $vendor_code = $encrypt-&gt;send_to_vendor($pay_code);

# CGI code to create a form with the encrypted data as hidden fields.
# The form also acted as a confirmation page, so the user saw
# "Please review your information and click to continue".

# Java code at the bottom of the file.
use Inline ( Java =&gt; &lt;&lt;'END_OF_JAVA_CODE',
  import xjava.security.Cipher;
  import cryptix.pgp.*;

class encrypt {
  public encrypt(){
  }

  public String send_to_vendor (String value_string){
      PGP pgpObj = new PGP();

      /* Initialize the object with base values. */
     pgpObj.init("/pgp_dir", "client name", "passwd","sender_key_name");

      /* Add the receiver name to the list. */
      pgpObj.addReceiver("vendor name");

     /* Create the encoded string. */
     String encvalue = pgpObj.encodeString(value_string);

     return (encvalue);
   }
}
END_OF_JAVA_CODE
SHARED_JVM =&gt; 1,
CLASSPATH =&gt; 'paths to cryptix libraries',
);</code></pre>

<p>The code itself is very simple. The Java code simply creates a new object,
calls a few methods, and returns the encrypted string. The interesting part is
how relatively easy it was to embed the Java code in a Perl CGI script and have
it work seamlessly. When we initially implemented this in 2001,
<code>Inline::Java</code> was fairly new and there was little documentation on
how to do this. Patrick LeBoutillier, the author, was very helpful as I was
trying to get it working. Now the <code>Inline::Java</code> documentation has a section on using <code>Inline::Java</code> in CGI scripts.</p>

<p>The last item on the list was far more difficult than we anticipated.  For
most days, it was a simple formula to tag a record with a date the money would
be available. However, weekends had special rules; we saw results that were
inconsistent with the documentation we were working from.  To nail down the
problem, we ended up having to run small test transactions at various times on
various days to see when our accountants saw the money actually arrive in the
UB account.</p>

<p>For example, if the documentation said there was a 4 p.m. cut-off time for
payments on a given day, we would run a $1.11 transaction at 3:55 p.m., then
another $1.12 transaction at 4:05 p.m. Our accounting people would watch the
system to see when the payments came through. We needed to increment the
amounts because we used the same credit card to process the transactions and
there was no other way to keep them straight.</p>

<p>Following this method, we learned a lot about the backend banking system.
Different credit card companies process things on different schedules and
handle things differently. The most important thing we found was a bug in the
vendor's processing system. After many weeks of running test transactions and
comparing the clearing times with the vendor documentation, we finally tracked
it back to a problem in the vendor system that they quickly fixed.</p>

<p>The final product worked well. During the first run of the final
confirmation script, <code>Inline::Java</code> compiles and saves the code to
run again, so it was quite fast. The vendor received the encrypted information
correctly and could decrypt it successfully; it didn't matter to them that we
actually generated the request in Perl. Our remittance files arrived on a
regular schedule and we posted the results on a daily cycle.</p>

<h3>The World Happens in Real Time</h3>

<p>As described above, the vendor did much of the work, but since we passed
users off to their system, we were unable to see the results of transactions
until the next day. This wasn't a problem for some payments.  For example, the
graduate school application fee just needs to be received by a particular date.
It's not crucial that we know the results of the transaction in real time.</p>

<p>For tuition payment, however, we needed a real-time solution. At UB and many
universities, you can't register for your next semester if you have an
outstanding balance from the previous semester. When a student is in this
situation, called a checkstop, he needs to be able to pay and have the
checkstop lifted immediately. Students often find out about their checkstop
while trying to register online, so they need to be able to pay, clear their
accounts, and return to the registration system while some courses are still
available. What's more, this often happens on a Saturday morning when many
services may not be available.</p>

<h4>Real-Time Integration Challenges</h4>

<p>The existing accounts system at UB runs on a mainframe, but most new
development happens in our distributed Solaris environment. To allow real-time
payments, we needed a vendor who could provide an immediate payment response,
and we needed to apply that result to the mainframe. We also wanted to design
the system to be open for future applications.</p>

<p>We selected VeriSign as our new vendor and they returned real-time results. To
then apply real-time results to our system, we could no longer pass users off
to another site; we needed to manage the entire transaction.  We redesigned
our system to handle this.</p>

<p>We currently use this redesigned system. The key steps in our current
process are:</p>

<ol>

<li>Manage the web transaction using Perl CGI scripts and an Oracle
database.</li>

<li>After the user enters credit card information and clicks Submit, make a
SOAP call to our internal payment server.  The payment server logs all
events.</li>

<li>Perl scripts on the payment server call our mainframe system to determine
if the student's account is eligible to receive a payment.</li>

<li>If the student has an active account, we call VeriSign using their Perl
module.</li>

<li>Receive and log results from VeriSign.</li>

<li>If VeriSign approved the payment, call the mainframe again and credit the
student's account with the amount of the payment. If student paid in full,
remove the checkstop from the account.</li>

<li>Return the response for the initial SOAP call and present the user with the
result of the transaction.</li>

</ol>

<p>From a design perspective, most of the steps are necessary given the
disparate components we're working with. Despite all of the things we do, the
entire process usually takes about 10 seconds.</p>

<p>We have several systems that access our mainframe in real-time through Perl.
The Perl part is a basic socket call to a port on the mainframe.  Special
software runs on the mainframe as a server that can receive formatted requests
and return results after processing against mainframe systems. One major
advantage of the mainframe software is that it allows us to use existing mainframe
systems through a new internet front-end.</p>

<p>The interface with VeriSign was likewise fairly easy to integrate. They
provide a Perl module to call their system and retrieve results. The majority
of the work was in learning all of the non-success response codes and designing
the system to handle them appropriately.</p>

<p>However, you may wonder why we included a SOAP call between internal
servers. When we designed the system, we tried to make all of the parts as
flexible as possible. For this phase, we built both the front-end (the user websites) and the backend (the payment server). Given a generic enough interface,
we speculated that other campus users may want to build their own front-end website and interface directly with the payment server.  Constructing a SOAP
interface using <a
href="http://search.cpan.org/dist/SOAP-Lite"><code>SOAP::Lite</code></a>
allowed us to potentially provide a service in a technology-neutral
manner. The system has worked well and performance hasn't been a problem.  Thus
far, we haven't had an external, campus-entity interface with our system, but we
have built other internal systems that use the interface.</p>

<p>We also have a process in place for payments that don't need
immediate application (not real time).  For these payments, we follow a similar process but
skip the live mainframe connections. At night, we have batch Perl jobs that run
and apply the changes to the mainframe.</p>

<h3>Challenges</h3>

<p>Most of our challenges with the ePayment system are with the user interface,
specifically providing enough information. We will frequently receive a result
of "declined," or "declined with possible approval." Some declines are the simple
type where the user simply doesn't have enough room on their credit card.
However, many credit and debit cards have a maximum charge limit per day that
card holders aren't aware of. They tend to hit this limit when using a credit
card to make a large charge like a tuition payment. This type of decline is
conditional; the card issuer can approve the transaction after a phone
call from the card holder.</p>

<p>The problem is that the return code from VeriSign isn't always clear enough
for us to tell users exactly what they need to do. The correct response can
also vary from one credit card issuer to another. The challenge is presenting
them with messages that give them enough information, but no incorrect
information. Even when we can provide them with a clear message such as "You
need to call your credit card issuer," they often assume it's a problem with
our system and contact us anyway.</p>

<h3>Your eUniversity</h3>

<p>UB's ePayment project has been very successful and our users have received
it well.  In our last payment cycle, approximately 40% of payments came through
the internet, instead of the traditional methods of mailing a check, going to the
payment office, or paying over the phone. Even with this level of activity, the
level of support required has been very reasonable.</p>

<p>With so many internet payment systems available -- some specifically designed
for education -- some may question custom-building so much of the system. When
dealing with legacy components, however, it's often difficult to purchase a
solution for just part of the process. Replacing entire systems at a university
the size of UB is a much larger project than we usually want to tackle at any
one time. In these situations, we've found Perl to be very flexible, allowing
us to patch together disparate systems and external resources to build a
cohesive, effective system.</p>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1038" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/p6pdigest/20041202.html" rel="bookmark">This Fortnight in Perl 6, November 16-30 2004</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Matt Fowles</span> on <abbr class="published" title="2004-12-02T00:00:00-08:00">December  2, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->
<p>All~</p>

<p>Welcome to yet another summary. Although Aliya is present for this summary,
I think the unnamed gecko with its tongue out will be the one who is helping to
bring it to you, aided of course by Nicola Conte and Massive Attack.  Rather
than try to do something witty about the strange music I am listening to, or
the stuffed animals who are assisting me, I will start this summary off with an
entirely self-serving request. &lt;abuse&gt;A while ago I saw the quote,
"Computer Science is merely the post-Turing Decline of Formal Systems Theory," without an attribution. I have tried to find an attribution for it, but have
been unable to find one. If any of you know it, that information would be
appreciated.&lt;/abuse&gt;</p>

<p>Without too much further ado, I give you Perl 6 Language.</p>

<h3>Perl 6 Language</h3>

<h4><a href="http://xrl.us/d4hg">Return Values from a Substitution</a></h4>

<p>Nicholas Clark wondered what kind of return value the <code>s///</code>
operator would return. Larry provided the answer: a match object that does
wicked, smart things based on context (Boston is getting to me).</p>

<h4><a href="http://xrl.us/d4hh">Deep Operators</a></h4>

<p>Matthew Walton wondered about deep operators and return types. No answer
yet, but it is still a little early to call in the awesome forces of
Warnock.</p>

<h3>Perl 6 Compiler</h3>

<p>The race between Google and the compiler is over and Google loses.  Badly.
While, alas, I do not have a pretty interface, you all have links from <a
href="http://www.nntp.perl.org/">nntp.perl.org</a>, plus a nifty infant grammar
engine to torture.</p>

<h4>Parrot Grammar Engine</h4>

<p>Patrick R. Michaud (forever after known as Patrick) released a first
version of the Perl 6 Grammar Engine (P6GE). Sometime later, he renamed it the Parrot Grammar Engine, as it will be standard in Parrot and PGE sounds
better. He asked for people to poke and prod it. Many people did, with quite
some glee. Some work has been done adding it to the Parrot build and making it
use Parrot's Configure/make system, as well as some cross-platform cleanups.
Patrick also put out a request for tests and explained the basic framework
already in place. He also explained his short term plans.</p>

<ul>

<li><a href="http://xrl.us/d4hi">Initial release</a></li>

<li><a href="http://xrl.us/d4hj">Cross-platform happiness</a></li>

<li><a href="http://xrl.us/d4hk">Test explanation</a></li>

<li><a href="http://xrl.us/d4hm">Plans</a></li>

<li><a href="http://xrl.us/d4hn">The great renaming</a></li>

</ul>

<h4><a href="http://xrl.us/d4ho">Synopses and Apocalypses</a></h4>

<p>Larry has managed to persuade <a
href="http://dev.perl.org/">dev.perl.org</a> to host the latest and most up-to-date versions of the Synopses. Consider the former link deprecated. Larry also
mentioned that this should probably wait a little while before it hits
Slashdot. Dan put a desperate plea not to also, as "I feel obligated to
actually *read* the comments on Parrot and Perl 6 stories on Slashdot, at 0."</p>

<h3>Parrot Internals</h3>

<p>Having fought my way through the lack of Google, I can now return to its
calm, warm tones and convenient threading.</p>

<h4>RT Data Extraction</h4>

<p>Will Coleda pointed out that he has the mystical power to extract and
summarize data from RT automatically. Then he asked for suggestions about how
to use this power for good or for awesome.</p>

<ul>

<li><a href="http://xrl.us/d4hp">The request</a></li>

<li><a href="http://xrl.us/d4hq">For awesome</a></li>

</ul>

<h4><a href="http://xrl.us/d4hr">Locating Shared Libraries</a></h4>

<p>Adam Warner has some trouble locating shared libraries on Debian. Leo
pointed out that Debian apparently names these libraries funny things.  The he
added support for symlinks and asked Adam to provide the appropriate
symlinks.</p>

<h4><a href="http://xrl.us/d4hs">Double v. Float</a></h4>

<p>Adam Warner played around with the Leibniz summation for pi example, but
could not get it to be more precise than 3.1431591. It turns out that the
<code>print</code> opcode was at fault and that <code>sprintf</code> worked
better. In fact, it allows you to print more precision than you actually have.
Ain't life in the floating point world a pain? We should all use integers, where
pi is exactly 3.</p>

<h4><a href="http://xrl.us/d4ht">AIX PPC JIT</a></h4>

<p>The ongoing thread of three-letter acronyms finally seems to have run
its course, ending in a climactic upgrade to Perl 5.8.5.</p>

<h4><a href="http://xrl.us/d4hu">New Calling Scheme Proposal</a></h4>

<p>Leo posted a new, calling scheme proposal. Dan stomped on it hard, then
posted an updated version of PPD03 (calling conventions). People spent some
time fleshing out every little corner of the new doc.</p>

<h4><a href="http://xrl.us/d4hv">Parrot BASIC and Perl.org Blacklists</a></h4>
<csperl file="grab" domain="on" record="b/1424" template="b/article_sidebar.view">
<p>Joshua Gatcomb kindly acted as a intermediary between the list and Clinton A.
Pierce. Apparently perl.org has blacklisted Clinton's domain and ISP.  He would
be willing to resume work on it, but he would like help, and/or to be
un-blacklisted. There was no real answer to Clinton's troubles. On a side note,
my old email provider, www.softhome.net, also occasionally gets blacklisted by
perl.org (it seemed to go in fits and starts).</p>

<h4><a href="http://xrl.us/d4hw">CVS Access for Parakeet</a></h4>

<p>Michel Pelletier was wondering if he could have CVS access to the Parakeet
language directory now that he has a perl.org username (michel).  Dan said that
he had forgotten to mention that he had put in a request, and he would likely
forget to mention when the request went through.</p>

<h4><a href="http://xrl.us/d4hx">Return with Return Continuation</a></h4>

<p>In the confusion of what not to change and what to change, the op to return
to the caller by invoking the current return continuation disappeared in the
shuffle. After sorting out the fact that Dan wanted it to go in, Leo added it,
naming it <code>returncc</code> for lack of anything better.</p>

<h4><a href="http://xrl.us/d4hy">Parakeet Broken</a></h4>

<p>Jeff Horwitz noted that Parakeet did not quite work. Leo pointed out that
Parrot had outflown Parakeet and it needed to catch up with the new eval
changes.</p>

<h4>Deprecation of P0, P1, P2</h4>

<p>Leo sent a warning to the list that, as per PDD03, access to the current
continuation and sub should only come from the <code>interpinfo</code> ops.
Usage of P0 and P1 for these things is officially deprecated and soon to be
discontinued. Also, P2 current object came along for the ride later, which
caused troubles with imcc's <code>self</code> macro. Later, he removed the
deprecated things.</p>

<ul>

<li><a href="http://xrl.us/d4hz">Initial warning</a></li>

<li><a href="http://xrl.us/d4h2">Self stuff</a></li>

<li><a href="http://xrl.us/d4h3">Updated warning</a></li>

<li><a href="http://xrl.us/d4h4">The removal</a></li>

</ul>

<h4><a href="http://xrl.us/d4h5"><code>Main</code> Is Just a Sub</a></h4>

<p>Leo has coerced <code>main</code> into looking and acting exactly like any
other sub.  Consistency is nice like that.</p>

<h4>Continuations, Basic Blocks, and Register Allocation</h4>

<p>The thread of the week last week continued strong into early this week,
slowly but steadily clearing up misconceptions of certain summarizers who would
like to remain anonymous. Also, later in the week, Bill Coffman provided a
summary of the problems and ideas thus far. We all eagerly await the
resolution.</p>

<ul>

<li><a href="http://xrl.us/d4h6">The monster thread itself</a></li>

<li><a href="http://xrl.us/d4h7">Bill's summary</a></li>

</ul>

<h4><a href="http://xrl.us/d4h8">m4 0.0.10</a></h4>

<p>To keep up with the aforementioned <code>eval</code> changes, Bernhard
Schmalhofer provided some m4 improvements.</p>

<h4><a href="http://xrl.us/d4h9">Lightweight Calling Conventions</a></h4>

<p>Dan, Leo, and Patrick had an interesting discussion about the speed of
various calling conventions. While <code>BSR</code>/<code>RET</code> beats
continuations, continuations with tail-call optimization beat
<code>BSR</code>/<code>RET</code>; however, <code>BSR</code>/<code>RET</code>
with tail-call optimization edges out continuations. In the end, the PGE will be
agnostic to calling conventions so as to provide a real-world test for
benchmarking. Either way, fear the Big Sweaty Russian (ask Mike Z if you want
to know ;-).</p>

<h4><a href="http://xrl.us/d4ia">NCI Signature Correction</a></h4>

<p>Last week I incorrectly claimed that the <code>d</code> signature allowed
access to a raw buffer. I was wrong, it was <code>b</code>. Thanks for the
catch, Bernhard.</p>

<h4><a href="http://xrl.us/d4ib">Void Functions Don't Return Things</a></h4>

<p>Andy Dougherty noticed that <em>matchrange.pmc</em> attempted to return
something from a void function. He supplied a patch, but there seems to be no
response....</p>

<h4><a href="http://xrl.us/d4ic"><code>Perl6 --tree</code></a></h4>

<p>Gerd Pokorra submitted a patch to fix a problem with <code>perl6
--tree</code>.  Warnock applies.</p>

<h4><code>ResizableIntegerArray</code> Needs Soda</h4>

<p>Patrick requested that someone provide the wonderfully amazing
<code>ResizableIntegerArray</code> <code>pop</code>. Once that is done, PGE
should switch from using a <code>PerlArray</code> to a
<code>ResizableIntegerArray</code>. Patches welcome.</p>

<ul>

<li><a href="http://xrl.us/d4id">Pop request</a></li>

<li><a href="http://xrl.us/d4ie">Conversion request</a></li>

</ul>

<h4><a href="http://xrl.us/d4if">No perldoc =&gt; WARNING</a></h4>

<p>James deBoer provided the previously requested patch for doing the right
thing when there is no <code>perldoc</code> present. Leo applied it.</p>

<h4><a href="http://xrl.us/d4ig">Broken Benchmarks</a></h4>

<p>The great thing about breaking benchmarks is that if you do it right, your
execution time goes from a big number to nearly nothing. It provides one hell
of a speed up. Unfortunately, it also means they don't work. Alas, such is life. Fortunately Leo provided an explanation, if not a fix.</p>

<h4><a href="http://xrl.us/d4ih">MMD with Native Types</a></h4>

<p>Leo voiced his confusion about <code>MMD_ADD_INT</code>. When Leo is
confused, I worry.</p>

<h4>Polymorphic Inline Caches (PICs)</h4>

<p>Leo posted some interesting stuff about PICs and provided some preliminary
benchmarks. He also provided a link to the article from which he drew the
idea.</p>

<ul>

<li><a href="http://xrl.us/d4ii">Leo's post</a></li>

<li><a href="http://xrl.us/d4ij">The paper</a></li>

</ul>

<h4><a href="http://xrl.us/d4ik">Mac OS X.2 Failures</a></h4>

<p>Klaas-Jan Stol noticed that <em>pmc2c2.pl</em> failed on his 10.2
installation. He asked for help, but no one has responded yet.</p>

<h4><a href="http://xrl.us/d4im">Inconsistent opcode Names</a></h4>

<p>William Coleda noticed that we did not consistently use_underscores or
pushwordstogether. Everyone agrees this is a problem, so we are probably just
waiting on a brave soul who can make the necessary sweeping change. I think
that underscores_won_out.</p>

<h4><a href="http://xrl.us/d4in">Tcl Supports Lists</a></h4>

<p>Will Coleda added basic list support to Tcl. Then he threatened to do more
with it. I, for one, welcome our new list overlords.</p>

<h4><a href="http://xrl.us/d4io">Build Problems on PPC Linux</a></h4>

<p>chromatic (whose name Google rudely capitalizes) had some trouble building
Parrot on PPC Linux. No resolution yet.</p>

<h4>New TODO Items</h4>

<p>Will Coleda added some new TODO items.</p>

<ul>

<li><a href="http://xrl.us/d4ip">Finish split opcode</a></li>

<li><a href="http://xrl.us/d4iq">Remove Perl dependency on split</a></li>

<li><a href="http://xrl.us/d4ir">Add split to Tcl</a></li>

<li><a href="http://xrl.us/d4is">Add \u support to Tcl</a></li>

</ul>

<h4><a href="http://xrl.us/d4it">Intellectual Property</a></h4>

<p>Tim Brunce asked how Parrot was handling IP concerns. Dan told him that we
have lawyers working up "Real Paperwork" even as we speak. In the meantime, it is mostly an honor system.</p>

<h4><a href="http://xrl.us/d4iu">1 - 2 == BOOM</a></h4>

<p>Will Coleda found a bug in MMD. Leo took responsibility and submitted a
fix.</p>

<h4><a href="http://xrl.us/d4iv">Escaping Strings</a></h4>

<p>Patrick wondered if some code sitting around would properly escape a string
into a nice, clean form. The answer is yes, use <code>Data::Escape</code>.</p>

<h4><a href="http://xrl.us/d4iw">Bug in Method Calling with nonconst Keys</a></h4>

<p>Luke Palmer found this bug. Leo fixed it.</p>

<h4><a href="http://xrl.us/d4ix">Underscores on Subs</a></h4>

<p>Luke Palmer wondered if subs still had to have <code>_</code> before their
names. Leo provided the answer: no, and the docs are out of date.</p>

<h4><a href="http://xrl.us/d4iy">Silent Effect of opcodes</a></h4>

<p>Leo noted that opcodes with silent effects need a little more special
treatment. This morphed into a conversation about the continuation troubles that
have been haunting us all and exceptions, too.</p>

<h4><a href="http://xrl.us/d4iz">IMCC Tracing, Leaving Subs</a></h4>

<p>Will Coleda asked if it would be possible to indicate what route Parrot
would return to after a <code>returncc</code> opcode. Leo liked the idea and
put in a quick hack for it, which needs cleanup.</p>

<h4><a href="http://xrl.us/d4i2">Threads, Events, and Win32 (Oh My!)</a></h4>

<p>Gabe Schaffer continued to explore the problems and approaches to portable
threading with Leo's help. Best of luck, guys.</p>

<h4><a href="http://xrl.us/d4i3">IMCC Register Mapping</a></h4>

<p>Will Coleda noticed a possible optimization with register mapping. Leo said
that it was not that simple, but it would be implemented at some point in the
new register allocator.</p>

<h4>Exceptions</h4>

<p>Exceptions hurt my head, especially Dan's description of them. Thus I will
just leave you to read it for yourself, so your head can hurt, too.</p>

<ul>

<li><a href="http://xrl.us/d4i4">Dan's initial post</a></li>

<li><a href="http://xrl.us/d4i5">Will's troubles</a></li>

</ul>

<h4><a href="http://xrl.us/d4i6">Missing Makefile Dependencies</a></h4>

<p>Leo noticed that the <em>Makefile</em> is not quite right about its
dependencies.  This frequently recurs.</p>

<h4><a href="http://xrl.us/d4i7">JITted vtables for Sparc</a></h4>

<p>St&eacute;phane Peiry provided some more JIT support for the Sparc. Leo
applied the patch.</p>

<h4><a href="http://xrl.us/d4i8">PGE Namespaces and Names</a></h4>

<p>Will Coleda, Luke Palmer, Jerome Quelin, and Patrick all worked to clean up
PGE to have its own namespace and consistent naming.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a176fb26410228fc/a12ef10c010ecaec?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#a12ef10c010ecaec"><code>Parrot_compreg</code> Signature</a></h4>

<p>Bernhard Schmalhofer noticed that <code>Parrot_compreg</code> had a
different signature than documented, so he submitted a patch to fix it. Leo
applied it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0dcb4c68cab4a7ac/3de333c4d23c4ca9?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#3de333c4d23c4ca9">opcode
Numbering</a></h4>

<p>Leo added a TODO ticker for opcode numbering.</p>

<h4>Tests Pass, but Create Core Files</h4>

<p>I reported that on my machine all of the tests claim to pass, but core files
appear in the <em>parrot</em> directory. Dan confirmed my suspicion that this
was a real problem. I tried to supply helpful information like back trace, but
Warnock applies.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/74744e09d7adc092/d43f4106f2e905a5?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d43f4106f2e905a5">Initial
message</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/488e623d71b6d8ab/c909c9babac8d80f?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#c909c9babac8d80f">Squeeky
wheel gets the kick?</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/6a9d65594a45f70a/ba0ef78e52148775?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ba0ef78e52148775">pcc
Cleanup</a></h4>

<p>Leo removed the recently deprecated P0, P1, P2 usage. Relatively few tests
break as a result.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/7b48bde181d11a1a/66e7d4e7a7ab6ac2?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#66e7d4e7a7ab6ac2">Namespace-Sub
Invocation</a></h4>

<p>Luke Palmer wanted to know if there is syntax for calling subs from a
particular namespace. Leo provided the answer: call it as a method on the
namespace PMC.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/45872280dbf8ab9d/d8b7d8f26eccaf63?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d8b7d8f26eccaf63">Reserved
Words Annoy</a></h4>

<p>Luke Palmer wondered if he could define a <code>.sub "new"</code> to get
around reserved word problems. Leo added the support, but warned him not to use
"spaces or such."</p>

<h4>
Lexicals, Continuations, Register Allocation, and ASCII Art</h4>

<p>This thread (and the ones that preceded it) have made me wish that Gmail and
Google Groups had a fixed-width font option. Sadly, this summary will probably
not get me it, as it did not get me p6c either. Ah well. The problems
associated with lexicals and continuations churned. There was a plea for
guidance from Dan. Hopefully he will guide us shortly.</p>

<ul>

<li><a href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3a61fe5e97d17389/5d407a49e35702c0?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#5d407a49e35702c0">One thread about it</a></li>

<li><a href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/214157bf29879710/c57b4637509a41ab?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#c57b4637509a41ab">And another (with plea)</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/88235ce751128b01/33970bc9a90a06cb?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#33970bc9a90a06cb">Old
Parrot Question</a></h4>

<p>Bloves had a question about <em>assemble.pl</em> in the Parrot 0.0.1 source.
Warnock applies.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3cf8e317d26e3bcf/20e082437de64106?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D30%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#20e082437de64106">Parrot
on Linux PPC Build</a></h4>

<p>chromatic managed to track down some of the PPC build issues for Linux.  Leo
wondered where all of the config hackers went. I think Leo wants someone to fix
it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/3f850bb15ad00090/8c9270a316157318?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#8c9270a316157318
-- initial message">Preprocessor Problems</a></h4>

<p>Flavio S. Glock noted that the preprocessor did undesirable things. Leo
suddenly realized that it was woefully out-of-date and need major
fixing/disabling. Flavio submitted a small patch for it, but Leo pointed out
that this was not enough to actually fix the preprocessor.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/1c4cc50f5124ecdb/077a2262017fee69?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#077a2262017fee69">New
<code>push_eh</code> opcode</a></h4>

<p>Leo added a new <code>push_eh</code> opcode and deprecated the old
<code>set_eh</code>.</p>

<h4>TODO and RT Wrangling</h4>

<p>Will Coleda continued his stellar work managing the RT queues. Brent "Dax"
Royal-Gordon patched the first one.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/038a16c644cd85d9/b11b6c59dab91269?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#b11b6c59dab91269">Remove
Perl* PMCs (done)</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f9e3c119a6d96c92/4c254d61bdf2ffbf?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#4c254d61bdf2ffbf">The
patch</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/55d6877477bd2ce3/7fb65a1c7cd9a169?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#7fb65a1c7cd9a169">Make
Perl* PMCs dynamic</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/d968cfbd529970bb/ef890a6842435659?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ef890a6842435659">IMCC
documentation needed</a></li>

</ul>

<h4>PMC Does "hash|array|monkey"</h4>

<p>Will Coleda added a ticket for the <code>does</code> functionality. He
promptly closed it when Leo pointed out that it already existed in the form of
the <code>does</code> op. So Will up and started using it.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/0d7df7f4cdba0821/fcf7be31e8c07a97?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%Drecent%26&amp;_doneTitle=Back&amp;&amp;d#fcf7be31e8c07a97">Initial
request</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/20829a4743413438/7133a04b64d46880?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#7133a04b64d46880">Tcl
takes advantage</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/32e8b813ae9d638b/d413362b93c0b8d4?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#d413362b93c0b8d4">Strings
Are In</a></h4>

<p>Dan announced that the last of his string stuff was checked in and he would
like brave souls to help him merge it back into the tree.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/b278ec3c2df48ae4/f8c3302fed106b0e?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#f8c3302fed106b0e">Language
TODO Tests</a></h4>

<p>Will Coleda thanked Josh Wilmes for fixing the Language TODO tests.
Apparently one of Tcl's has mysteriously started working.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/e0d155b14c769ed0/fc395ff103bccd69?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#fc395ff103bccd69">Minesweeper
Broke</a></h4>

<p>Jens Rieks noticed that somewhere in the shuffle minesweeper broke.  As a
professional minesweeper-er, this shocks and offends me. Leo offered a pointer
as to where to start looking to fix it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/baf16164e0942a99/a7d9e8b2ea97a641?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#a7d9e8b2ea97a641"><code>@ANON</code> Subs</a></h4>

<p>Leo added some support for anonymous subroutines. People liked them and
began to use them. Luke Palmer promptly tried combining it with
<code>@IMMEDIATE</code> and began to wonder if it were immediate enough.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f9c31fa171d3a634/c18f2e2beaaedb2b?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#c18f2e2beaaedb2b">Parrot
Grammar Engine Issues</a></h4>

<p>I think that I shall continue to spell out PGE for a little while, but I may
decide to use only the acronym in some later summary without warning, so be
prepared. Oh right, the whole reason I mentioned it in the first place ... Will
Coleda pointed out a few issues, including (1) doesn't compile by default and
(2) doesn't compile at all. Nicholas Clark fixed (2), and Patrick figured that
(1) could wait until it was a little more mature.  Personally, I feel that
maturity is overrated, poo-poo head.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/c773166b629fa6e0/635e61453b2ad086?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#635e61453b2ad086">(Java|ECMA)Script
on Parrot</a></h4>

<p>David "liorean" Andersson wondered if there were any projects to run
JavaScript on Parrot. While there does not appear to be, many people think it
would be a good idea and offered useful pointers.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4245c22323f10eec/fb96b1b98e28df7a?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#fb96b1b98e28df7a">Rules
Engines</a></h4>

<p>Cindi Jenkins posted a link to an interesting blog entry on rules engines.
Unfortunately, I think she posted it to Google Groups as it did not find its
way onto the list. Also, unfortunately, it is a post about logic rules engines
a la Prolog and not grammar rules. Who knows, though, there might be some
overlap....</p>

<h4>
PIR Examples on the Website</h4>

<p>Herbert Snorrason noted that there were no PIR examples on the website and
opened a ticket for it. Will took a first pass at it.</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/cc070158b58d62f9/ed6e93528eb83000?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ed6e93528eb83000">Original
message</a></li>

<li><a href="http://www.parrotcode.org/examples/">Parrot code examples</a></li>

</ul>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/f431003d9429cfe2/7df630bb59973686?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#7df630bb59973686"><code>testj
string_102</code> Issues</a></h4>

<p>Luke Palmer found a subtle-looking problem in <em>string_102.pasm</em>. Leo
couldn't reproduce it and suggested that it might be a Red Hat thing. Peter
Sinnott chimed in with a possibly unrelated failure, also on Red Hat.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/ab18b616e2a89b3b/6bedca9a038ed1d9?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#6bedca9a038ed1d9">Tuning
and Monitoring</a></h4>

<p>Matt S. posted a question about how much internal tuning and monitoring
Parrot will allow. Unfortunately, I think he posted it to Google Groups, as it
didn't show up in my inbox. I am honestly not sure how much is available or in
the works.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a69db424446d8783/ff859e67ee2aa353?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#ff859e67ee2aa353">Missing
directory in <em>MANIFEST</em></a> </h4> 

<p>Andy Dougherty submitted a patch
fixing a missing directory in the manifest by allowing <em>ops2pm.pl</em> to
add it.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/eb26d8206c8346d4/cddac16c4d298d65?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#cddac16c4d298d65">Objects,
Classes, Metaclasses, and Tall People's Heads</a></h4>

<p>Dan posted a refresher on the current state of the object system. He then
went on to explain where it was headed and conjectured that this would be
enough. Just reading his description of it hurts my head enough that I do not
wish to guess if he is right or not.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/db77d18c6011534b/f140e6aa524b48a0?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#f140e6aa524b48a0"><code>eof</code>
opcodes</a></h4>

<p>Brian Wheeler wondered why there was no "eof" opcode. Leo told him that it
was a method on a PIO object. Apparently most of the IO opcodes should actually
be PIO methods.  Go figure.</p>

<h4>Ops to Deprecate or Not</h4>

<p>Leo attempted to trim down the core by removing some opcode variants.  Dan
did not appreciate the change and told Leo to roll it back.  Fortunately, Dan
went on to explain the longer-term goal (which should satisfy Leo).</p>

<ul>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/1c782d44bacb09d7/282ffc0fcf893f3e?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%Drecent%26&amp;_doneTitle=Back&amp;&amp;d#282ffc0fcf893f3e">Initial
posting</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/4895a297d8442753/9f6119f5da401c99?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#9f6119f5da401c99">CVS
commit message</a></li>

<li><a
href="http://groups-beta.google.com/group/perl.perl6.internals/browse_frm/thread/a549937c1d815228/9ca142664145ad61?_done=%2Fgroup%2Fperl.perl6.internals%2Fthreads%3Fstart%3D0%26order%3Drecent%26&amp;_doneTitle=Back&amp;&amp;d#9ca142664145ad61">The
goals</a></li>

</ul>


<h3>Perl 6 Language</h3>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/threa
d/7d839d26208ce291/5f2fea0de12b17ba?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fstart%3D0%26tsc%3D1%26&amp;_doneTitle=Back&amp;&amp;d#5f2fea0de12b17ba">Deep
Operators</a></h4>

<p>Last week, Matthew Walton wondered about Deep Operators and if they would
work as he expected. As I tentatively predicted, the answer came back and was
"yes." Then the thread got sidetracked with context and Perl vs. perl vs. PERL
concerns.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/ca6052f823f3742d/87aa6adbc75cf1af?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fstart%3D0%26tsc%3D1%26&amp;_doneTitle=Back&amp;&amp;d#87aa6adbc75cf1af"><code>Gather</code>
to Separate Bins</a></h4>

<p>Dave Whipp wanted to know if he could use
<code>gather</code>/<code>take</code> with multiple bins.  Michele Dondi
suggested using adverbs for it. Rod Adams pointed out that as
<code>gather</code> is inherently lazy, the two-binned approach could cause
strange results (like churning for a while, filling one bin, and trying to get an
element for the other).  Of course, not being able to do it would mean possibly
having to compute an expensive generator function. This is more than necessary, unless
it is memorized....</p>

<h4><a href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/a3dcca5308b8c1d3/7e652c58a92b8763?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fstart%3D0%26tsc%3D1%26&amp;_doneTitle=Back&amp;&amp;d#7e652c58a92b8763">&lt;&lt; In Here-Docs</a></h4>

<p>Thomas Seiler has decided to test my copy-paste-fu by starting a discussion on
characters that don't appear on my keyboard. His question was if
<code>&lt;&lt;END</code> could start a here-doc. The answer appears to be
"no."</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/257b8e0bbed541a8/ab6622fc31d918f9?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fstart%3D0%26tsc%3D1%26&amp;_doneTitle=Back&amp;&amp;d#ab6622fc31d918f9"><code>&laquo;
!= &lt;&lt;</code></a></h4>

<p>The above thread led to a discussion of the various quoting operators, and
the differences between <code>&laquo;&raquo; </code>and <code>&lt;&lt;&gt;&gt;</code>. This
led to much discussion on the finer points of <code>qw</code>, <code>qx</code>,
and <code>qq</code> (among others). Juerd suggested scrapping <code>qx</code>
and <code>qw</code> in favor of <code>qq:x</code> and <code>qq:w</code>, which
Larry liked. Rod Adams suggested scrapping <code>&lt;&lt;END</code> in favor of
<code>qq:h/END/</code>, which I like.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/68898c62789633c4/46454a84a9172df0?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fstart%3D0%26tsc%3D1%26&amp;_doneTitle=Back&amp;&amp;d#46454a84a9172df0">Unifying
Namespaces</a></h4>

<p>Alexey Trofimenko wondered about unifying the $, @, and % namespaces.  Larry
told him that this ship sailed long ago and that it was not changing.</p>

<h4><a
href="http://groups-beta.google.com/group/perl.perl6.language/browse_frm/thread/a96c900343eee05a/33dac0ffef3f5412?_done=%2Fgroup%2Fperl.perl6.language%2Fthreads%3Fstart%3D0%26tsc%3D1%26&amp;_doneTitle=Back&amp;&amp;d#33dac0ffef3f5412">Lexing/Parsing
Perl6 Without Executing Code</a></h4>

<p>Adam Kennedy wants to be able to syntax color (and possible perform basic
programmatic manipulations of Perl 6 code). Anyone who has used a good IDE like
Visual Studio, Eclipse, or IntelliJ probably understands where he is coming
from. He does not, however, want to execute arbitrary code in the process of
doing this. Much discussion ensued, but it does not look like he will be able
to do this. Quite the tragedy, but Perl is simply too dynamic for the docile
lexing of static languages.</p>

<h3>Perl6 Compiler</h3>

<h4><a href="http://www.nntp.perl.org/group/perl.perl6.compiler/121">Nice
Work</a></h4>

<p>Nick Glencross has the honor of the only message on p6c this week, but his
sentiment is shared by all. Nice work, Patrick.</p>

<h3>The Usual Footer</h3>

<p>If you find these summaries useful or enjoyable, please consider
contributing to the Perl Foundation to help support the development of Perl.
You might also like to send feedback to <a
href="mailto:ubermatt@gmail.com">ubermatt@gmail.com</a>.</p>

<ul>
<li><a href="http://donate.perl-foundation.org/">The Perl Foundation</a></li>
<li><a href="http://dev.perl.org/perl6/">Perl 6 Development site</a></li>
<li><a href="http://planet.parrotcode.org/">Parrot Blog aggregator</a></li>
</ul>



        </div>



    </div>
    <div class="asset-footer"></div>
</div>


                            
                            <div id="entry-1028" class="entry-asset asset hentry">
    <div class="asset-header">
        <h2 class="asset-name entry-title"><a href="/pub/2004/12/01/3d_engine.html" rel="bookmark">Building a 3D Engine in Perl</a></h2>
        <div class="asset-meta">
            <span class="byline">
    
                By <span class="vcard author">Geoff Broadwell</span> on <abbr class="published" title="2004-12-01T00:00:00-08:00">December  1, 2004 12:00 AM</abbr>
    
            </span>

            
            

        </div>
    </div>
    <div class="asset-content entry-content">

        <div class="asset-body">
            
<!-- sidebar begins -->
<!-- don't move sidebars -->
<!-- sidebar ends -->
<br clear="all" />
<p>This article is the first in a series aimed at building a full 3D engine.  It could be the underlying technology for a video game, the visualization system for a scientific application, the walkthrough program for an architectural design suite, or whatever.</p>

<p><em>Editor's note: see also the rest of the series, <a href="/pub/a/2004/12/29/3d_engine.html">events and keyboard handling</a>, <a href="/pub/a/2005/02/17/3d_engine.html">lighting and movement</a>, and <a href="/pub/a/2005/08/04/3d_engine.html">profiling your application</a>.</em></p>

<p>First, I'll set some goals and ground rules to help guide the design.  I'm
all for agile programming, but even the most agile development process needs
some basic goals at the outset:</p>

<ul>

<li>I'm not going to make little demos.  Early on, the engine won't have much
functionality, but it should always be a good foundation for future
growth.</li>

<li>The engine must be portable across architectures and operating systems.  I
will use OpenGL for 3D rendering and SDL for general, operating system
interaction, such as input handling and window creation.  The engine itself
should contain almost no OS-specific code.</li>

<li>The engine should be operational at every step of the way, from the very
beginning.  I will flesh it out over time, and there may be some complex
concepts that take some time to work through, but at the very least, every
article should end with the whole engine working again.</li>

<li>I'll leave out most error checking to save space and make the central
concepts more clear.  For the same reasons, there is no included test library.
In your own engine, you will want to have both!</li>

<li>Don't be afraid to experiment.  The best way to learn this stuff is to play with it.  Start with what's in the articles and add to it.  Any time you spend now will repay itself many times over later, because it's easier to understand advanced topics when you have a solid understanding of the earlier topics.</li>

</ul>

<p>As a final note before we begin, some versions of SDL_Perl have bugs that
will affect the engine.  If I know of any issues to watch out for, I'll let you
know; conversely, if you find any bugs, let me know, and I'll include a note in
a following article.</p>

<h3><a name="Getting Started">Getting Started</a></h3>

<p>The first step is to rough out a simple structure and make a runnable
program right off.  Bear with me; there's a fair bit of code here for what it
does, but that will simplify things later on.  Here's my starting point:</p>

<pre><code>#!/usr/bin/perl

use strict;
use warnings;

my ($done, $frame);

START: main();

sub main
{
    init();
    main_loop();
    cleanup();
}

sub init
{
    $| = 1;
}

sub main_loop
{
    while (not $done) {
        $frame++;
        do_frame();
    }
}

sub do_frame
{
    print '.';
    sleep 1;
    $done = 1 if $frame == 5;
}

sub cleanup
{
    print "\nDone.\n";
}</code></pre>

<p>The first few lines are the usual strict boilerplate, especially important
since I'm working without a net (a test library).  Then I declare a couple of
state variables (a "done" flag and a frame counter), and jump to the main
program.</p>

<p>The main program is pretty simple -- initialize, run the main loop for a
while, and then clean up.  It's typical of how I structure a potentially
complex program.  The top-level routines should be very simple, clear, and
self-documenting.  Each conceptual piece is a separate routine, wherein reside
all the gritty bits that actually do the real work.  I've seen huge programs
(hundreds of thousands of lines) where the main procedures started with several
hundred lines of initialization before finally branching to the "real" main
body at the end.  That style is hard to debug, hard to profile, and just plain
hard to understand.  I avoid it religiously.</p>

<p>Back to the program at hand.  <code>init</code> sets autoflush on
<code>STDOUT</code> so that partial lines print immediately, which I use later
in <code>do_frame</code>.</p>

<p>The <code>main_loop</code> simply loops until <code>$done</code> is true,
producing one finished animation frame per loop.  Each loop increments the
frame counter and calls the actual routine that does the work,
<code>do_frame</code>.</p>

<p><code>do_frame</code> prints a single dot to indicate a frame has begun, and
sleeps for a second.  When it wakes up, it checks if five frames have
completed, flagging <code>$done</code> if so.</p>

<p>With <code>$done</code> set, <code>main_loop</code> ends and control returns
to <code>main</code>, which calls the final <code>cleanup</code>.
<code>cleanup</code> just notifies the user of a clean exit and ends.</p>

<p>That's a fair amount of code to print two lines of text (over the course of
five seconds) and exit; it doesn't even open a rendering window!  I'll do that
next.</p>

<h3><a name="Creating a Window">Creating a Window</a></h3>

<p>First, I need to pull in the SDL and OpenGL libraries:</p>

<pre><code>use SDL::App;
use SDL::OpenGL;</code> </pre>

<p>and add a couple more state variables (a config hash and an
<code>SDL::App</code> object):</p>

<pre><code>my ($conf, $sdl_app);</code> </pre>

<h4><a name="Initialization">Initialization</a></h4>

<p>I'm going to do two new types of initialization, so I create routines for
them and call them from <code>init</code>:</p>

<pre><code>sub init
{
    $| = 1;
    init_conf();
    init_window();
}

sub init_conf
{
    $conf = {
        title  =&gt; 'Camel 3D',
        width  =&gt; 400,
        height =&gt; 400,
    };
}

sub init_window
{
    my ($title, $w, $h) = @$conf{qw( title width height )};

    $sdl_app = SDL::App-&gt;new(-title  =&gt; $title,
                             -width  =&gt; $w,
                             -height =&gt; $h,
                             -gl     =&gt; 1,
                            );
    SDL::ShowCursor(0);
}</code></pre>

<p>At this point, <code>init_conf</code> just defines some configuration
properties used immediately in <code>init_window</code>, which contains the
first real SDL meat.</p>

<p><code>init_window</code> performs two important actions.  First, it asks
<code>SDL::App</code> to create a new window, with the appropriate title,
width, and height.  The <em>-gl</em> option tells <code>SDL::App</code> to
attach an OpenGL 3D-rendering context to this window instead of the default 2D-rendering context.  Second, it hides the mouse cursor (while it's within the
new window's border) using <code>SDL::ShowCursor(0)</code>.</p>

<h3><a name="Three Phases of Drawing">Three Phases of Drawing</a></h3>

<p>Now that I have a nice new window, I'd like <code>do_frame</code> to do
something with it.  I'll start by breaking the rendering into three phases:
prepare, draw, and finish.</p>

<pre><code>sub do_frame
{
    prep_frame();
    draw_frame();
    end_frame();
}</code></pre>

<p>For now, <code>draw_frame</code> contains exactly what <code>do_frame</code>
used to contain:</p>

<pre><code>sub draw_frame
{
    print '.';
    sleep 1;
    $done = 1 if $frame == 5;
}</code></pre>

<p>The new code is in <code>prep_frame</code> and <code>end_frame</code>; let's
look at <code>prep_frame</code> first:</p>

<pre><code>sub prep_frame
{
    glClear(GL_COLOR_BUFFER_BIT);
}</code></pre>

<p>This is the first actual OpenGL call.  Before I explain the details, it's worth
pointing out the OpenGL naming conventions.  OpenGL's design allows it to work
with programming languages that have no concept of namespaces or packages.  In
order to work around this, all OpenGL routine names look like
<code>glFooBar</code> (CamelCase, no underscores, <code>gl</code> prepended),
and all OpenGL constant names look like <code>GL_FOO_BAR</code> (UPPERCASE,
underscores between words, <code>GL_</code> prepended).  In older languages,
this prevents the OpenGL names from colliding with names used in other
libraries.  In the Perl world, this isn't an issue for object-oriented modules.
Because OpenGL is not object-oriented, SDL_Perl takes advantage of this
convention and simply imports all of the names into the current package when
you write <code>use SDL::OpenGL</code>.</p>

<p>Note: If you read OpenGL code written in C, you may notice a short string of
characters appended to the routine names, such as <code>3fv</code>.  This
convention differentiates variants that have different numbers of parameters or
whose parameters are different types.  In Perl, values know their own type and
a function's parameters can vary in number, so this is unnecessary.  The Perl
bindings simply drop these extra characters and <code>SDL::OpenGL</code> do the right thing for you.</p>

<p>The OpenGL call in <code>prep_frame</code> clears the rendering area to
black by calling <code>glClear</code> -- the general OpenGL "clear a buffer"
routine -- with a constant that indicates it should clear the <em>color
buffer</em>.  As the name indicates, the color buffer stores the color for each
pixel and is what the user sees.  Several other OpenGL buffers exist; I'll
describe those later.</p>

<p>The alert reader may wonder why the code clears the color buffer to black as
opposed to white or some other color.  OpenGL relies heavily on the concept of
<em>current state</em>.  Many OpenGL routines do not actually request any
rendering, instead altering one or more variables in the current state so that
the next rendering command will perform its action differently.  When a program
prepares to use OpenGL, which <code>SDL::App::new</code> does for us, the
current state is set to (mostly) reasonable defaults.  One of these state
variables is the color to use when clearing the color buffer.  Its default is
black, which I haven't bothered to override.</p>

<p>The remaining routine is <code>end_frame</code> :</p>

<pre><code>sub end_frame
{
    $sdl_app-&gt;sync;
}</code></pre>

<p>This asks the SDL::App object to synchronize the window contents with those
held in OpenGL's color buffer, so that the user can see the rendered image.  In
this case, it's a black window for five seconds.</p>













<h3><a name="Something to See">Something to See</a></h3>

<p>It's time to draw something in that window.  To do so, I need to do three
things:</p>

<ol>

<li>Choose a projection, so that OpenGL knows how I want to look at the
scene.</li>

<li>Set the view, so OpenGL knows from which direction to view the scene (the
<em>viewpoint</em>) and in which direction I wish to look.</li>

<li>Define an object in the scene, placed where the viewpoint can see it.</li>

</ol>

<p>To start, I need another config setting, so I'll add another line to the
<code>$conf</code> hash in <code>init_conf</code>:</p>

<pre><code>        fovy   =&gt; 90,</code></pre>

<p>Next, for my three new functions, I add three new calls at the top of
<code>draw_frame</code>:</p>

<pre><code>sub draw_frame
{
    set_projection_3d();
    set_view_3d();
    draw_view();
</code></pre>

<h4><a name="Choose a Projection">Choose a Projection</a></h4>

<p><code>set_projection_3d</code> is as follows:</p>

<pre><code>sub set_projection_3d
{
    my ($fovy, $w, $h) = @$conf{qw( fovy width height )};
    my $aspect = $w / $h;

    glMatrixMode(GL_PROJECTION);
    glLoadIdentity;
    gluPerspective($fovy, $aspect, 1, 1000);

    glMatrixMode(GL_MODELVIEW);
    glLoadIdentity;
}</code></pre>

<p>This is the first place you can see an indication of the hard part of 3D
graphics simmering below the surface -- math, and lots of it.  3D-rendering code often includes a fairly hefty load of linear algebra (matrix math, for
those blocking out their high school and college years) and trigonometry.
Thankfully, OpenGL does a lot of that math under the covers.  I've also defined
a fairly simple projection and view, so this hides a lot of the complexity for
now (aside from some of the OpenGL function names).</p>

<p>The first section of the routine defines the viewing projection.  In the
simplest case, that means choosing whether to use an <em>orthogonal</em>
projection or a <em>perspective</em> projection.  Orthogonal projections have
no foreshortening.  They commonly appear in architectural and engineering
drawings, because parts that are the same size also appear the same size, no
matter where they are in the scene.</p>

<p>Perspective projections are what we see in the real world with our own eyes
or with a camera; distant objects appear smaller than near objects.  It's also
what you learn in a perspective drawing art class, in which the first
assignment is commonly train tracks going off to the horizon.  Tracks farther
from the viewer appear closer together as does the spacing between the ties.
To replicate the real world, I've chosen a perspective projection.</p>

<p>In OpenGL, you not only have to decide between an orthogonal or perspective
projection, you have to define its basic dimensions.  In other words, how much
can you see?  For a perspective projection, you define the vertical <em>field
of view</em> (FOV), the <em>aspect ratio</em> of the view, and the distance to
the nearest and farthest things visible.</p>

<p>The vertical FOV (<code>$fovy</code> in the code) defines the angle from the
viewpoint to the lowest and highest visible parts of the scene.  If you imagine
drawing what someone would see if she were standing with her eyes at the
viewpoint, this represents her vertical peripheral vision.  If you imagine a
camera instead, this depends on the focal length of the lens.  A telephoto lens
has a very small FOV because the angle from the camera to the top and bottom
visible objects is very small.  Conversely, a wide-angle lens has a large FOV,
and the FOV for a fisheye lens is even larger, approaching 180 degrees.</p>

<p>The aspect ratio comes directly from the dimensions of the drawing area (width/height).  This allows OpenGL to compensate for the stretching effect
of a non-square window.  In this case, the drawing area is square, so the
aspect ratio is 1.</p>

<p>After calculating the window's aspect ratio, I tell OpenGL that I want to
modify the projection and to start from a blank slate, using
<code>glMatrixMode(GL_PROJECTION)</code> and <code>glLoadIdentity</code>.  I
then call <code>gluPerspective</code> to define the desired perspective.  You
probably noticed that <code>gluPerspective</code> begins with <code>glu</code>
instead of <code>gl</code>, like all of the other calls we've seen.  This is
because I'm using one of the GLU (OpenGL Utility) routines to cover up some
complexity in the equivalent raw OpenGL sequence.</p>

<p>Finally, I switch back to model/view mode, and once again start with a blank
slate, using <code>glMatrixMode(GL_MODELVIEW)</code> and
<code>glLoadIdentity</code>.  You may wonder why I don't include this in the
next routine instead of doing it here.  I like to make sure routines that
change a commonly used OpenGL state, simply as a side effect of their main purpose,
return that state to the way they found it, especially if there is no net
performance effect to doing so.  In this case, I switch temporarily to
projection mode and then switch back to the default model/view mode.</p>

<h4><a name="Set the View">Set the View</a></h4>

<p>The next step is to move the viewpoint to somewhere we can see the
scene:</p>

<pre><code>sub set_view_3d
{
    # Move the viewpoint so we can see the origin
    glTranslate(0, -2, -10);
}</code></pre>

<p>I'm going to skip the detailed explanation for now, but in short the
<code>glTranslate</code> call leaves the viewpoint a few units away from (and
above) the origin of the scene, where I'll place my objects.  I keep the
default viewing direction, because it happens to point right where I want it
to.</p>

<h4><a name="Define an Object">Define an Object</a></h4>

<p>I'm going to start with a pretty simple scene -- just one object:</p>

<pre><code>sub draw_view
{
    draw_axes();
}

sub draw_axes
{
    # Lines from origin along positive axes, for orientation
    # X axis = red, Y axis = green, Z axis = blue
    glBegin(GL_LINES);
    glColor(1, 0, 0);
    glVertex(0, 0, 0);
    glVertex(1, 0, 0);

    glColor(0, 1, 0);
    glVertex(0, 0, 0);
    glVertex(0, 1, 0);

    glColor(0, 0, 1);
    glVertex(0, 0, 0);
    glVertex(0, 0, 1);
    glEnd;
}</code></pre>

<p>The lone object is itself quite simple, just three short lines extending
from the origin along the X, Y, and Z axes.  (I'm using "line" in the OpenGL
sense, as a line segment, not the infinite line of rigorous mathematics.)</p>

<p>In OpenGL, when you want to define something to render, you must notify
OpenGL when you begin and end the definition; these are the
<code>glBegin</code> and <code>glEnd</code> calls.  In addition, you must tell
OpenGL what type of <em>primitive</em> you will use to create your object.
There are several types of primitives, including points, lines, and triangles.
In addition, each primitive type has variants based on how several primitives
in a sequence connect (independently, connected in a strip, and so on).  In
this case, I use <code>GL_LINES</code>, indicating independently placed line
segments.</p>

<p>I want each line to be a different color to make it easier to tell which is
which.  To set the current drawing color, I call <code>glColor</code> with an
RGB (Red, Green, Blue) triplet.  In OpenGL, each color component can range from
0 (none) to 1 (full).  Therefore, (1, 0, 0) indicates pure red, (0, 1, 0) is
pure green, and so on.  A medium gray is (.5, .5, .5).  For further mnemonic
value, I assign the colors so that the RGB triplets match the coordinates of
the endpoints of the lines -- red for the X axis, green for Y, and blue for
Z.</p>

<p>For each line, after defining the color, I define the endpoints of the line
using <code>glVertex</code>.  Each line begins at the origin and extends one
unit along the appropriate axis.  In other words, this sequence defines a red
line from (0, 0, 0) to (1, 0, 0):</p>

<pre><code>    glColor(1, 0, 0);
    glVertex(0, 0, 0);
    glVertex(1, 0, 0);</code></pre>

<p>With these routines in place, we finally have something to look at!  As you
can see, the X axis points to the right, the Y axis points up, and the Z axis
points out of the screen toward the viewer (with OpenGL foreshortening it).
Note the delay before the object first appears; that's because the sleep at the
end of <code>draw_frame</code> creates a pause before
<code>end_frame</code> syncs the screen with the drawing area.</p>

<h3><a name="Moving Boxes Around">Moving Boxes Around</a></h3>

<p>Next, let's try a box.  Anyone who's played a First Person Shooter game
knows that their worlds have a surplus of boxes (a.k.a. "crates," "storage
containers," and so on - oddly, for <em>storage</em> containers, the larger
they are, the less they seem to contain).  I'll start with a simple cube and
add another call for it to the end of <code>draw_view</code>:</p>

<pre><code>sub draw_view
{
    draw_axes();
    draw_cube();
}</code></pre>

<h4><a name="Defining the Cube">Defining the Cube</a></h4>

<p>Here's the code that actually draws the cube:</p>

<pre><code>sub draw_cube
{
    # A simple cube
    my @indices = qw( 4 5 6 7   1 2 6 5   0 1 5 4
                      0 3 2 1   0 4 7 3   2 3 7 6 );
    my @vertices = ([-1, -1, -1], [ 1, -1, -1],
                    [ 1,  1, -1], [-1,  1, -1],
                    [-1, -1,  1], [ 1, -1,  1],
                    [ 1,  1,  1], [-1,  1,  1]);

    glBegin(GL_QUADS);
    foreach my $face (0 .. 5) {
        foreach my $vertex (0 .. 3) {
            my $index  = $indices[4 * $face + $vertex];
            my $coords = $vertices[$index];
            glVertex(@$coords);
        }
    }
    glEnd;
}</code></pre>

<p>That looks pretty hairy, but it's actually not bad.  The
<code>@vertices</code> array contains the coordinates for a cube two units on a
side, centered at the origin, with its sides aligned with the X, Y, and Z axes.
The <code>@indices</code> array defines which four vertices belong to each of
the six faces of the cube and in what order to send them to OpenGL.  The
order is very important; I've arranged it so that, as seen from the outside,
the vertices of each face draw in counterclockwise order.  Using a consistent
order helps OpenGL to determine the front and back side of each polygon; I've
chosen to use the default counterclockwise order.</p>

<p>After defining those arrays, I mark the beginning of a series of independent
quadrilateral primitives using <code>glBegin(GL_QUADS)</code>.  I then iterate
through each vertex of each face, finding the correct set of coordinates and
sending them to OpenGL using <code>glVertex</code>.  Finally, I mark the end of
this series of primitives using <code>glEnd</code>.</p>

<p>Colloquial Perl purists will no doubt wonder why I have chosen C-style loops
(with the attendant index math, yuck), rather than making <code>@indices</code>
an array of arrays.  Mostly I'm just showing that it's not too hard to deal
with this type of input data.  When the engine reads object descriptions from
files, rather than hand-coded routines, the natural output of the file parser
may be flattened.  It's often easier to do a little index math than to force
the parser to output more structured data (and possibly more efficient too, but
that's a clear call for benchmarking).</p>

<p>The result is one blue cube.  Why blue?  Since I never specified a new
color to use, OpenGL went back to the current state and looked up the current
drawing color.  The last line in the axes was drawn in blue and that's still
the current color.  Hence one blue cube.</p>

<h4><a name="Two Colored Boxes">Two Colored Boxes</a></h4>

<p>Let's fix that. At the same time, we can move the new cube out of the way of
the axes so we can see them again.  Heck, I'll go all out and have two cubes --
one to the left of the axis lines, and one to the right.  The nice thing is
that because I'm just drawing more of something I've already described, I just
need to change <code>draw_view</code>:</p>

<pre><code>sub draw_view
{
    draw_axes();

    glColor(1, 1, 1);
    glTranslate(-2, 0, 0);
    draw_cube();

    glColor(1, 1, 0);
    glTranslate( 2, 0, 0);
    draw_cube();
}</code></pre>

<p>Now I set the current color to white using <code>glColor(1, 1, 1)</code>
before drawing the first cube, and to yellow using <code>glColor(1, 1, 0)</code>
before drawing the second cube.  The <code>glTranslate</code> calls should
place the first cube two units to the left (along the negative X axis) and the
second cube two units to the right (along the positive X axis).</p>













<h4><a name="Cumulative Transformations">Cumulative Transformations</a></h4>

<p>Unfortunately, no dice.  The white cube is two units to the left, but the
yellow cube is right on top of the axis lines again, not two units to the right
as intended.  This happened because <code>glTranslate</code> calls (and the
other transformation calls I'll show later) are cumulative.  Unlike routines
such as <code>glColor</code> that simply set the current state, most
transformation calls instead modify the current state in a certain way.
Because of this, the first cube starts at (-2, 0, 0), and the second starts at
(-2, 0, 0) + (2, 0, 0) = (0, 0, 0) -- right back at the origin again.</p>

<p>The solution to this problem requires peeking under the covers a little bit.
OpenGL transformation calls really just set up a special matrix representing
the effect that the requested transformation has on coordinates.  OpenGL then
multiplies the current matrix by this new transformation matrix and replaces
the current matrix with the results of the multiplication.</p>

<p>What I need to fix this problem is some way to save the current matrix
before performing a transformation, and then restore it after I'm done with it.
Thankfully, OpenGL actually maintains a stack of matrices of each type.  I just
need to push a copy of the current matrix onto the stack before drawing the
white cube, and pop that copy off again afterwards to get back to the state before I
did my translation.  I'm going to do this for both cubes:</p>

<pre><code>sub draw_view
{
    draw_axes();

    glColor(1, 1, 1);
    glPushMatrix;
    glTranslate(-2, 0, 0);
    draw_cube();
    glPopMatrix;

    glColor(1, 1, 0);
    glPushMatrix;
    glTranslate( 2, 0, 0);
    draw_cube();
    glPopMatrix;
}</code></pre>

<p>That's a bit better.  The yellow cube now has its origin at (2, 0, 0), just
as intended.</p>

<h3><a name="Other Transformations">Other Transformations</a></h3>

<p>Earlier I referred to other transformation calls; let's take a look at a few
of them.  First, I'll scale the boxes (change their size).  I'm going to scale
the left (white) box uniformly -- in other words, scaling each of its
dimensions by the same amount.  To show the difference, I'll scale the right
(yellow) box non-uniformly, with each dimension scaled differently.  Here's the
new <code>draw_view</code>:</p>

<pre><code>sub draw_view
{
    draw_axes();

    glColor(1, 1, 1);
    glPushMatrix;
    glTranslate(-4, 0, 0);
    glScale( 2, 2, 2);
    draw_cube();
    glPopMatrix;

    glColor(1, 1, 0);
    glPushMatrix;
    glTranslate( 4, 0, 0);
    glScale(.2, 1, 2);
    draw_cube();
    glPopMatrix;
}</code></pre>

<p>For the white box, I just doubled each dimension; the parameters to
<code>glScale</code> are X, Y, and Z multipliers.  For the yellow box, I shrunk
the X dimension by a factor of 5 (multiplied by .2), left Y alone, and doubled
the Z dimension.  The boxes are now big enough that I've also pushed them
farther apart, hence the updated values for <code>glTranslate</code> that place
them four units on either side of the scene origin.</p>

<h4><a name="Watch the Rotation">Watch the Rotation</a></h4>

<p>I've done translation and scaling; next up is rotation.  To save space here,
I'll demonstrate on the yellow cube alone.  Here's the new code snippet:</p>

<pre><code>    glColor(1, 1, 0);
    glPushMatrix;
    glRotate( 40, 0, 0, 1);
    glTranslate( 4, 0, 0);
    glScale(.2, 1, 2);
    draw_cube();
    glPopMatrix;</code></pre>

<p>The parameters to <code>glRotate</code> are the number of degrees to rotate
and the axis around which to do the rotation.  In this case, I chose to rotate 40 degrees around the Z axis (0, 0, 1).  The direction of rotation follows the
general pattern in OpenGL -- a positive value means counterclockwise when
looking down the rotation axis toward the origin.</p>

<h4><a name="Order of Transforms">Order of Transforms</a></h4>

<p>This produces a flying yellow box in the upper-right quadrant.  Remember
when I said that each new transformation is cumulative?  The order matters.  To
understand why, I like to imagine each transformation as moving, rotating, or
scaling the coordinate system in which I draw my objects.  In this case, by
rotating first, I certainly rotated the box, but I really rotated the entire
coordinate system in which I defined the box.  This meant the
<code>glTranslate</code> call that immediately follows the rotation translated
out along a rotated X axis, 40 degrees above the scene's X axis, to be
precise.</p>

<p>I'll move the rotation after the other two transformations to fix that:</p>

<pre><code>    glTranslate( 4, 0, 0);
    glScale(.2, 1, 2);
    glRotate( 40, 0, 0, 1);</code></pre>

<p>Now the box isn't flying, but it does appear squashed in an odd way.  The
problem here is that because the nifty, non-uniform scaling happens before the
rotation, I'm now trying to rotate through a space where the dimensions are
different sizes.  Putting the rotation in the middle fixes it:</p>

<pre><code>    glTranslate( 4, 0, 0);
    glRotate( 40, 0, 0, 1);
    glScale(.2, 1, 2);</code></pre>

<p>If you compare this rendering from this version with the program with no
<code>glRotate</code> call, you should see that it does the right thing
now.</p>

<h3><a name="Whoa, Deep!">Whoa, Deep!</a></h3>

<p>The last item I wanted to bring up is what to do when something near the
back draws after something near the front.  To see what I mean, I'll move the
white box so that instead of being four units to the left of the scene origin,
it is four units behind it (along the negative Z axis).  That merely involves
changing the white box's <code>glTranslate</code> call from this:</p>

<pre><code>    glTranslate(-4, 0, 0);</code></pre>

<p>to this:</p>

<pre><code>    glTranslate( 0, 0, -4);</code></pre>

<p>As you can see, even though the white box should appear behind the axis
lines, it instead appears in front because OpenGL drew it after the axis lines.
By default, OpenGL assumes you intended to do this (it is more efficient to
make this assumption), but I didn't.  To fix this, I need to tell OpenGL to pay
attention to the depth of the various objects in the scene and not to overwrite
near objects with far ones.</p>

<p>To do this, I need to enable OpenGL's <em>depth buffer</em>.  This is
similar to the color buffer, which stores the color of every pixel drawn.
Instead of storing the color, however, it stores the depth (distance from the
viewpoint along the viewing direction) of every pixel.  Just like the color
buffer, I need to clear the depth buffer each frame.  Instead of clearing it to
black, OpenGL clears it to the maximum depth value, so that any later rendering
within the visible scene will be closer.</p>

<p>I also need to tell OpenGL that it should perform a test each time it wants
to draw a pixel, comparing the depth of the new pixel with what's already in
the depth buffer.  If the new pixel is farther from the viewer than the pixel
it is about to replace, it's safe to ignore the new pixel and to leave alone
the old color.  Here's the updated <code>prep_frame</code>:</p>

<pre><code>sub prep_frame
{
    glClear(GL_COLOR_BUFFER_BIT |
            GL_DEPTH_BUFFER_BIT );

    glEnable(GL_DEPTH_TEST);
}</code></pre>

<p>In this version, I tell <code>glClear</code> to clear both the color buffer
and the depth buffer. You can now see why the constant names end with
<code>_BIT</code>; they are, in fact, bit masks.  The reason for
this odd interface is purely efficiency -- some OpenGL implementations can very
rapidly clear all requested buffers simultaneously, and making the request for
all needed buffers in just one call allows this optimization.  As for the
choice of bit mask rather than a list of constants, SDL_Perl reflects the
underlying C interface, so that people comfortable with that can more easily
cross over to using OpenGL under Perl.</p>

<p>The second routine I call, <code>glEnable</code>, is actually one of the
most commonly used OpenGL routines, despite the fact that this is the first
we've seen of it.  Much of the OpenGL current state is a set of flags that tell
OpenGL when to do (or not do) certain things.  <code>glEnable</code> and the
corresponding <code>glDisable</code> set these flags as desired.  In this case,
I turn on the flag that tells OpenGL to perform the depth test, throwing away
pixels drawn in the wrong order.</p>

<p>With these changes, we can now once again see the axis lines, this time in
front of the white box where they belong.</p>

<h3><a name="Conclusion">Conclusion</a></h3>

<p>The final results may look simple, but we've come a long way.  I started
with some basic boilerplate and a simple main loop.  I didn't even load SDL or
OpenGL or open a window.  By the end, I'd added a window to draw on; projection
and viewing setup; multiple objects of different types, built using different
OpenGL primitives, drawn in different colors, and transformed several different
ways; and correct handling of out-of-order drawing.</p>

<p>That's a lot for now, but we're just starting.  Next time I'll cover moving the viewpoint, SDL keyboard handling, and compensating for frame rate variations.  I'll build on the <a href="/2004/12/01/examples/perl_opengl_examples.tar.gz">example source code</a> built in this article, so feel free to download it and use it for your own applications.</p>

<p>In the meantime, if you'd like to learn more visit the <a
href="http://www.opengl.org/">OpenGL</a> and <a
href="http://www.libsdl.org/">SDL</a> websites; each contains (and links to) mountains of information.</p>


        </div>



    </div>
    <div class="asset-footer"></div>
</div>




                            <div class="content-nav">
                                <a href="/pub/2004/11/">&laquo; November 2004</a> |
                                <a href="/pub/">Main Index</a> |
                                <a href="/pub/archives.html">Archives</a>
                                | <a href="/pub/2005/01/">January 2005 &raquo;</a>
                            </div>


                        </div>
                    </div>


                    <div id="beta">
    <div id="beta-inner">


    
    <div class="widget-what-is-perl widget">
    <div class="widget-content widget-content-what-is-perl">
       Visit the home of the  Perl programming language: <a href="http://www.perl.org/">Perl.org</a
    </div>
</div>
<div class="widget-find-out-more widget-archives widget">
    <div class="widget-content">
        <ul>
            <li><a href="http://www.perl.org/get.html">Download</a></li>
            <li><a href="http://perldoc.perl.org/">Documentation</a></li>
            <li><a href="http://blogs.perl.org/">Perl Bloggers</a></li>
            <li><a href="http://news.perlfoundation.org/">Foundation News</a></li>
        </ul>
    </div>
</div><div class="widget-tcpc widget">
<h3 class="widget-header">Sponsored by</h3>
    <div class="widget-content">
        <a href="http://training.perl.com/" alt="Perl Training" target="_blank"><img src="/i/tcpc.png" width="150" height="50"></a>
    </div>
</div>

<div class="widget-syndication widget">
    <div class="widget-content">
        <ul>
            <li><img src="/mt-static/images/status_icons/feed.gif" alt="Subscribe to feed" width="9" height="9" /> <a href="/pub/atom.xml">Subscribe to this website's feed</a></li>

        </ul>
    </div>
</div>
<div class="widget-archive-monthly widget-archive widget">
    <h3 class="widget-header">Monthly <a href="/pub/archives.html">Archives</a></h3>
    <div class="widget-content">
        <ul>
        
            <li><a href="/pub/2014/02/">February 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2014/01/">January 2014 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/10/">October 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2013/01/">January 2013 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/12/">December 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/11/">November 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2012/10/">October 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/08/">August 2012 (2)</a></li>
        
    
        
            <li><a href="/pub/2012/06/">June 2012 (11)</a></li>
        
    
        
            <li><a href="/pub/2012/05/">May 2012 (18)</a></li>
        
    
        
            <li><a href="/pub/2012/04/">April 2012 (17)</a></li>
        
    
        
            <li><a href="/pub/2012/02/">February 2012 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/12/">December 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/09/">September 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/08/">August 2011 (2)</a></li>
        
    
        
            <li><a href="/pub/2011/06/">June 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/05/">May 2011 (3)</a></li>
        
    
        
            <li><a href="/pub/2011/04/">April 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/03/">March 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/02/">February 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2011/01/">January 2011 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/11/">November 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/10/">October 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/09/">September 2010 (1)</a></li>
        
    
        
            <li><a href="/pub/2010/08/">August 2010 (3)</a></li>
        
    
        
            <li><a href="/pub/2010/07/">July 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/04/">April 2010 (2)</a></li>
        
    
        
            <li><a href="/pub/2010/03/">March 2010 (4)</a></li>
        
    
        
            <li><a href="/pub/2008/05/">May 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/04/">April 2008 (2)</a></li>
        
    
        
            <li><a href="/pub/2008/03/">March 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/02/">February 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2008/01/">January 2008 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/12/">December 2007 (2)</a></li>
        
    
        
            <li><a href="/pub/2007/09/">September 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/08/">August 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/07/">July 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/06/">June 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/05/">May 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/04/">April 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/03/">March 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/02/">February 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2007/01/">January 2007 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/12/">December 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/11/">November 2006 (2)</a></li>
        
    
        
            <li><a href="/pub/2006/10/">October 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/09/">September 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/08/">August 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/07/">July 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/06/">June 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/05/">May 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/04/">April 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/03/">March 2006 (1)</a></li>
        
    
        
            <li><a href="/pub/2006/02/">February 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2006/01/">January 2006 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/12/">December 2005 (4)</a></li>
        
    
        
            <li><a href="/pub/2005/11/">November 2005 (3)</a></li>
        
    
        
            <li><a href="/pub/2005/10/">October 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/09/">September 2005 (2)</a></li>
        
    
        
            <li><a href="/pub/2005/08/">August 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/07/">July 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/06/">June 2005 (9)</a></li>
        
    
        
            <li><a href="/pub/2005/05/">May 2005 (8)</a></li>
        
    
        
            <li><a href="/pub/2005/04/">April 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/03/">March 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2005/02/">February 2005 (7)</a></li>
        
    
        
            <li><a href="/pub/2005/01/">January 2005 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/12/">December 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/11/">November 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/10/">October 2004 (5)</a></li>
        
    
        
            <li><a href="/pub/2004/09/">September 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/08/">August 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/07/">July 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/06/">June 2004 (6)</a></li>
        
    
        
            <li><a href="/pub/2004/05/">May 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2004/04/">April 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/03/">March 2004 (8)</a></li>
        
    
        
            <li><a href="/pub/2004/02/">February 2004 (9)</a></li>
        
    
        
            <li><a href="/pub/2004/01/">January 2004 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/12/">December 2003 (4)</a></li>
        
    
        
            <li><a href="/pub/2003/11/">November 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/10/">October 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/09/">September 2003 (6)</a></li>
        
    
        
            <li><a href="/pub/2003/08/">August 2003 (7)</a></li>
        
    
        
            <li><a href="/pub/2003/07/">July 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/06/">June 2003 (9)</a></li>
        
    
        
            <li><a href="/pub/2003/05/">May 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/04/">April 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/03/">March 2003 (10)</a></li>
        
    
        
            <li><a href="/pub/2003/02/">February 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2003/01/">January 2003 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/12/">December 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/11/">November 2002 (9)</a></li>
        
    
        
            <li><a href="/pub/2002/10/">October 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/09/">September 2002 (11)</a></li>
        
    
        
            <li><a href="/pub/2002/08/">August 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/07/">July 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2002/06/">June 2002 (4)</a></li>
        
    
        
            <li><a href="/pub/2002/05/">May 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/04/">April 2002 (6)</a></li>
        
    
        
            <li><a href="/pub/2002/03/">March 2002 (7)</a></li>
        
    
        
            <li><a href="/pub/2002/02/">February 2002 (5)</a></li>
        
    
        
            <li><a href="/pub/2002/01/">January 2002 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/12/">December 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/11/">November 2001 (5)</a></li>
        
    
        
            <li><a href="/pub/2001/10/">October 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/09/">September 2001 (7)</a></li>
        
    
        
            <li><a href="/pub/2001/08/">August 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/07/">July 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/06/">June 2001 (13)</a></li>
        
    
        
            <li><a href="/pub/2001/05/">May 2001 (11)</a></li>
        
    
        
            <li><a href="/pub/2001/04/">April 2001 (9)</a></li>
        
    
        
            <li><a href="/pub/2001/03/">March 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/02/">February 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2001/01/">January 2001 (8)</a></li>
        
    
        
            <li><a href="/pub/2000/12/">December 2000 (6)</a></li>
        
    
        
            <li><a href="/pub/2000/11/">November 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/10/">October 2000 (10)</a></li>
        
    
        
            <li><a href="/pub/2000/09/">September 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/08/">August 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/07/">July 2000 (5)</a></li>
        
    
        
            <li><a href="/pub/2000/06/">June 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/05/">May 2000 (7)</a></li>
        
    
        
            <li><a href="/pub/2000/04/">April 2000 (3)</a></li>
        
    
        
            <li><a href="/pub/2000/03/">March 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/02/">February 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/2000/01/">January 2000 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/12/">December 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/11/">November 1999 (6)</a></li>
        
    
        
            <li><a href="/pub/1999/10/">October 1999 (5)</a></li>
        
    
        
            <li><a href="/pub/1999/09/">September 1999 (4)</a></li>
        
    
        
            <li><a href="/pub/1999/08/">August 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/07/">July 1999 (2)</a></li>
        
    
        
            <li><a href="/pub/1999/06/">June 1999 (3)</a></li>
        
    
        
            <li><a href="/pub/1999/04/">April 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/03/">March 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1999/01/">January 1999 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/12/">December 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/11/">November 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/07/">July 1998 (2)</a></li>
        
    
        
            <li><a href="/pub/1998/06/">June 1998 (1)</a></li>
        
    
        
            <li><a href="/pub/1998/03/">March 1998 (1)</a></li>
        
        </ul>
    </div>
</div>
        
    

<div class="widget-powered widget">
    <div class="widget-content">
        <a href="http://www.movabletype.com/"><img src="/mt-static/images/bug-pbmt-white.png" alt="Powered by Movable Type 5.13-en" width="120" height="75" /></a>
    </div>
</div>



    </div>
</div>






                </div>
            </div>


            <div id="footer">
    <div id="footer-inner">
        <div id="footer-content">
            <div class="widget-powered widget">
                <div class="widget-content">
                    Powered by <a href="http://www.movabletype.com/" rel="generator">Movable Type Pro</a>
                </div>
            </div>

            <div class="widget-creative-commons widget">
                <div class="widget-content">
                    This blog is licensed under a <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons License</a>.
                </div>
            </div>

        </div>
    </div>
</div>



        </div>
    </div>
</body>
</html>
